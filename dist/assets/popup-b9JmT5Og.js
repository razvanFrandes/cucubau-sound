import{g as Wt,a as mn,o as fn,e as gn,c as vn,L as bn,r as w,j as i,b as re,R as xn,d as yn}from"./index-DvoTy1Zf.js";const Et=["drums","bass","melody","vocal","fx","synth","guitar","piano","strings","brass","pad","lead","loop","oneshot","ambient","percussion","sample"],wn=[{name:"none",value:""},{name:"red",value:"#ff3b5c"},{name:"orange",value:"#ff9500"},{name:"yellow",value:"#facc15"},{name:"green",value:"#00ff88"},{name:"cyan",value:"#00d4ff"},{name:"blue",value:"#3b82f6"},{name:"purple",value:"#a855f7"},{name:"pink",value:"#ec4899"}],Cn=["C","C#","D","D#","E","F","F#","G","G#","A","A#","B","Cm","C#m","Dm","D#m","Em","Fm","F#m","Gm","G#m","Am","A#m","Bm"];async function Sn(r){const e=r.getChannelData(0),t=r.sampleRate,n=kn(e,t,150),s=Rn(n,t);if(s.length<2)return 0;const o=[];for(let m=1;m<s.length;m++)o.push(s[m]-s[m-1]);const a=new Map,l=Math.floor(t*.02);for(const m of o){const p=Math.round(m/l)*l;a.set(p,(a.get(p)||0)+1)}let d=0,c=0;if(a.forEach((m,p)=>{m>d&&(d=m,c=p)}),c===0)return 0;let f=60*t/c;for(;f>180;)f/=2;for(;f<60;)f*=2;return Math.round(f)}function kn(r,e,t){const n=1/(t*2*Math.PI),s=1/e,o=s/(n+s),a=new Float32Array(r.length);a[0]=r[0];for(let l=1;l<r.length;l++)a[l]=a[l-1]+o*(r[l]-a[l-1]);return a}function Rn(r,e){const t=[],n=Math.floor(e*.2);let s=0;for(let l=0;l<r.length;l++){const d=Math.abs(r[l]);d>s&&(s=d)}const o=s*.5;let a=-n;for(let l=1;l<r.length-1;l++)r[l]>o&&r[l]>r[l-1]&&r[l]>r[l+1]&&l-a>=n&&(t.push(l),a=l);return t}function En(r,e=.95){const t=new OfflineAudioContext(r.numberOfChannels,r.length,r.sampleRate);let n=0;for(let a=0;a<r.numberOfChannels;a++){const l=r.getChannelData(a);for(let d=0;d<l.length;d++){const c=Math.abs(l[d]);c>n&&(n=c)}}if(n===0)return r;const s=e/n,o=t.createBuffer(r.numberOfChannels,r.length,r.sampleRate);for(let a=0;a<r.numberOfChannels;a++){const l=r.getChannelData(a),d=o.getChannelData(a);for(let c=0;c<l.length;c++)d[c]=l[c]*s}return o}function jn(r,e,t){const n=r.sampleRate,s=Math.floor(e*n),a=Math.floor(t*n)-s,d=new OfflineAudioContext(r.numberOfChannels,a,n).createBuffer(r.numberOfChannels,a,n);for(let c=0;c<r.numberOfChannels;c++){const u=r.getChannelData(c),f=d.getChannelData(c);for(let m=0;m<a;m++)f[m]=u[s+m]||0}return d}function Dt(r){const e=r.numberOfChannels,t=r.sampleRate,n=1,s=16,o=s/8,a=e*o,l=r.length*a,d=44+l,c=new ArrayBuffer(d),u=new DataView(c);bt(u,0,"RIFF"),u.setUint32(4,36+l,!0),bt(u,8,"WAVE"),bt(u,12,"fmt "),u.setUint32(16,16,!0),u.setUint16(20,n,!0),u.setUint16(22,e,!0),u.setUint32(24,t,!0),u.setUint32(28,t*a,!0),u.setUint16(32,a,!0),u.setUint16(34,s,!0),bt(u,36,"data"),u.setUint32(40,l,!0);const f=[];for(let p=0;p<e;p++)f.push(r.getChannelData(p));let m=44;for(let p=0;p<r.length;p++)for(let h=0;h<e;h++){const b=Math.max(-1,Math.min(1,f[h][p])),v=b<0?b*32768:b*32767;u.setInt16(m,v,!0),m+=2}return new Blob([c],{type:"audio/wav"})}function bt(r,e,t){for(let n=0;n<t.length;n++)r.setUint8(e+n,t.charCodeAt(n))}async function jt(r){const e=await r.arrayBuffer(),t=new AudioContext,n=await t.decodeAudioData(e);return t.close(),n}class xt{static async needsMigration(){try{const e=await chrome.storage.local.get(["recordings","folders"]),t=e.recordings||[],n=e.folders||[],s=await Wt();return t.length>0||n.length>0||s.length>0}catch{return!1}}static async getMigrationCount(){try{const e=await chrome.storage.local.get(["recordings","folders"]),t=e.recordings||[],n=e.folders||[],s=await Wt();return{recordings:t.length,folders:n.length,blobs:s.length}}catch{return{recordings:0,folders:0,blobs:0}}}static async migrate(e,t){try{const n=await chrome.storage.local.get(["recordings","folders"]),s=n.recordings||[],o=n.folders||[],a=o.length+s.length+1;let l=0;const d=this.sortFoldersByDepth(o);for(const f of d){l++,t?.(`Creating folder: ${f.name}`,l,a);const m=await e.createFolder(f.name,f.parentId,f.color);m.success||console.warn(`Failed to create folder ${f.name}:`,m.error)}const c=e.getFolders(),u=this.buildFolderIdMap(o,c);for(const f of s){l++,t?.(`Migrating: ${f.tabTitle||f.filename}`,l,a);const m=await mn(f.id);if(!m){console.warn(`No audio blob found for recording ${f.id}, skipping`);continue}const p=await this.ensureWavFormat(m,f.filename),h=f.folderId==="uncategorized"?"uncategorized":u.get(f.folderId)||"uncategorized",b={...f,folderId:h,filename:f.filename.replace(/\.(webm|wav)$/i,".wav")},v=await e.saveRecording(b,p);v.success||console.warn(`Failed to migrate recording ${f.id}:`,v.error)}return l++,t?.("Cleaning up old storage...",l,a),await this.cleanupOldStorage(),fn(void 0)}catch(n){return gn({type:"WRITE_FAILED",reason:`Migration failed: ${String(n)}`})}}static sortFoldersByDepth(e){const t=n=>{let s=0,o=n.parentId;for(;o;)s++,o=e.find(l=>l.id===o)?.parentId??null;return s};return[...e].sort((n,s)=>t(n)-t(s))}static buildFolderIdMap(e,t){const n=new Map,s=(a,l)=>{const d=[a.name];let c=a.parentId;for(;c;){const u=l.find(f=>f.id===c);if(u)d.unshift(u.name),c=u.parentId;else break}return d.join("/")},o=new Map;for(const a of t)o.set(s(a,t),a.id);for(const a of e){const l=s(a,e),d=o.get(l);d&&n.set(a.id,d)}return n}static async ensureWavFormat(e,t){if(e.type==="audio/wav"||e.type==="audio/wave"||t.endsWith(".wav"))return e;try{const n=await e.arrayBuffer(),s=new AudioContext,o=await s.decodeAudioData(n),a=this.audioBufferToWav(o);return await s.close(),a}catch(n){return console.warn("Failed to convert audio to WAV, using original:",n),e}}static audioBufferToWav(e){const t=e.numberOfChannels,n=e.sampleRate,s=1,o=16,a=e.length*t*(o/8),l=new ArrayBuffer(44+a),d=new DataView(l),c=(m,p)=>{for(let h=0;h<p.length;h++)d.setUint8(m+h,p.charCodeAt(h))};c(0,"RIFF"),d.setUint32(4,36+a,!0),c(8,"WAVE"),c(12,"fmt "),d.setUint32(16,16,!0),d.setUint16(20,s,!0),d.setUint16(22,t,!0),d.setUint32(24,n,!0),d.setUint32(28,n*t*(o/8),!0),d.setUint16(32,t*(o/8),!0),d.setUint16(34,o,!0),c(36,"data"),d.setUint32(40,a,!0);const u=[];for(let m=0;m<t;m++)u.push(e.getChannelData(m));let f=44;for(let m=0;m<e.length;m++)for(let p=0;p<t;p++){const h=Math.max(-1,Math.min(1,u[p][m])),b=h<0?h*32768:h*32767;d.setInt16(f,b,!0),f+=2}return new Blob([l],{type:"audio/wav"})}static async cleanupOldStorage(){try{await vn(),await chrome.storage.local.remove(["recordings","folders","expandedFolders"]),await chrome.storage.local.set({migrationCompleted:!0,migrationVersion:bn})}catch(e){console.warn("Failed to cleanup old storage:",e)}}static async wasMigrationCompleted(){try{return(await chrome.storage.local.get(["migrationCompleted"])).migrationCompleted===!0}catch{return!1}}}function ke(r,e,t,n){return new(t||(t=Promise))((function(s,o){function a(c){try{d(n.next(c))}catch(u){o(u)}}function l(c){try{d(n.throw(c))}catch(u){o(u)}}function d(c){var u;c.done?s(c.value):(u=c.value,u instanceof t?u:new t((function(f){f(u)}))).then(a,l)}d((n=n.apply(r,e||[])).next())}))}let ft=class{constructor(){this.listeners={}}on(e,t,n){if(this.listeners[e]||(this.listeners[e]=new Set),n?.once){const s=(...o)=>{this.un(e,s),t(...o)};return this.listeners[e].add(s),()=>this.un(e,s)}return this.listeners[e].add(t),()=>this.un(e,t)}un(e,t){var n;(n=this.listeners[e])===null||n===void 0||n.delete(t)}once(e,t){return this.on(e,t,{once:!0})}unAll(){this.listeners={}}emit(e,...t){this.listeners[e]&&this.listeners[e].forEach((n=>n(...t)))}};const yt={decode:function(r,e){return ke(this,void 0,void 0,(function*(){const t=new AudioContext({sampleRate:e});try{return yield t.decodeAudioData(r)}finally{t.close()}}))},createBuffer:function(r,e){if(!r||r.length===0)throw new Error("channelData must be a non-empty array");if(e<=0)throw new Error("duration must be greater than 0");if(typeof r[0]=="number"&&(r=[r]),!r[0]||r[0].length===0)throw new Error("channelData must contain non-empty channel arrays");(function(n){const s=n[0];if(s.some((o=>o>1||o<-1))){const o=s.length;let a=0;for(let l=0;l<o;l++){const d=Math.abs(s[l]);d>a&&(a=d)}for(const l of n)for(let d=0;d<o;d++)l[d]/=a}})(r);const t=r.map((n=>n instanceof Float32Array?n:Float32Array.from(n)));return{duration:e,length:t[0].length,sampleRate:t[0].length/e,numberOfChannels:t.length,getChannelData:n=>{const s=t[n];if(!s)throw new Error(`Channel ${n} not found`);return s},copyFromChannel:AudioBuffer.prototype.copyFromChannel,copyToChannel:AudioBuffer.prototype.copyToChannel}}};function Vt(r,e){const t=e.xmlns?document.createElementNS(e.xmlns,r):document.createElement(r);for(const[n,s]of Object.entries(e))if(n==="children"&&s)for(const[o,a]of Object.entries(s))a instanceof Node?t.appendChild(a):typeof a=="string"?t.appendChild(document.createTextNode(a)):t.appendChild(Vt(o,a));else n==="style"?Object.assign(t.style,s):n==="textContent"?t.textContent=s:t.setAttribute(n,s.toString());return t}function Ot(r,e,t){const n=Vt(r,e||{});return t?.appendChild(n),n}var Mn=Object.freeze({__proto__:null,createElement:Ot,default:Ot});const Pn={fetchBlob:function(r,e,t){return ke(this,void 0,void 0,(function*(){const n=yield fetch(r,t);if(n.status>=400)throw new Error(`Failed to fetch ${r}: ${n.status} (${n.statusText})`);return(function(s,o){ke(this,void 0,void 0,(function*(){if(!s.body||!s.headers)return;const a=s.body.getReader(),l=Number(s.headers.get("Content-Length"))||0;let d=0;const c=u=>{d+=u?.length||0;const f=Math.round(d/l*100);o(f)};try{for(;;){const u=yield a.read();if(u.done)break;c(u.value)}}catch(u){console.warn("Progress tracking error:",u)}}))})(n.clone(),e),n.blob()}))}};function me(r){let e=r;const t=new Set;return{get value(){return e},set(n){Object.is(e,n)||(e=n,t.forEach((s=>s(e))))},update(n){this.set(n(e))},subscribe:n=>(t.add(n),()=>t.delete(n))}}function et(r,e){const t=me(r());return e.forEach((n=>n.subscribe((()=>{const s=r();Object.is(t.value,s)||t.set(s)})))),{get value(){return t.value},subscribe:n=>t.subscribe(n)}}function Ue(r,e){let t;const n=()=>{t&&(t(),t=void 0),t=r()},s=e.map((o=>o.subscribe(n)));return n(),()=>{t&&(t(),t=void 0),s.forEach((o=>o()))}}let Dn=class extends ft{get isPlayingSignal(){return this._isPlaying}get currentTimeSignal(){return this._currentTime}get durationSignal(){return this._duration}get volumeSignal(){return this._volume}get mutedSignal(){return this._muted}get playbackRateSignal(){return this._playbackRate}get seekingSignal(){return this._seeking}constructor(e){super(),this.isExternalMedia=!1,this.reactiveMediaEventCleanups=[],e.media?(this.media=e.media,this.isExternalMedia=!0):this.media=document.createElement("audio"),this._isPlaying=me(!1),this._currentTime=me(0),this._duration=me(0),this._volume=me(this.media.volume),this._muted=me(this.media.muted),this._playbackRate=me(this.media.playbackRate||1),this._seeking=me(!1),this.setupReactiveMediaEvents(),e.mediaControls&&(this.media.controls=!0),e.autoplay&&(this.media.autoplay=!0),e.playbackRate!=null&&this.onMediaEvent("canplay",(()=>{e.playbackRate!=null&&(this.media.playbackRate=e.playbackRate)}),{once:!0})}setupReactiveMediaEvents(){this.reactiveMediaEventCleanups.push(this.onMediaEvent("play",(()=>{this._isPlaying.set(!0)}))),this.reactiveMediaEventCleanups.push(this.onMediaEvent("pause",(()=>{this._isPlaying.set(!1)}))),this.reactiveMediaEventCleanups.push(this.onMediaEvent("ended",(()=>{this._isPlaying.set(!1)}))),this.reactiveMediaEventCleanups.push(this.onMediaEvent("timeupdate",(()=>{this._currentTime.set(this.media.currentTime)}))),this.reactiveMediaEventCleanups.push(this.onMediaEvent("durationchange",(()=>{this._duration.set(this.media.duration||0)}))),this.reactiveMediaEventCleanups.push(this.onMediaEvent("loadedmetadata",(()=>{this._duration.set(this.media.duration||0)}))),this.reactiveMediaEventCleanups.push(this.onMediaEvent("seeking",(()=>{this._seeking.set(!0)}))),this.reactiveMediaEventCleanups.push(this.onMediaEvent("seeked",(()=>{this._seeking.set(!1)}))),this.reactiveMediaEventCleanups.push(this.onMediaEvent("volumechange",(()=>{this._volume.set(this.media.volume),this._muted.set(this.media.muted)}))),this.reactiveMediaEventCleanups.push(this.onMediaEvent("ratechange",(()=>{this._playbackRate.set(this.media.playbackRate)})))}onMediaEvent(e,t,n){return this.media.addEventListener(e,t,n),()=>this.media.removeEventListener(e,t,n)}getSrc(){return this.media.currentSrc||this.media.src||""}revokeSrc(){const e=this.getSrc();e.startsWith("blob:")&&URL.revokeObjectURL(e)}canPlayType(e){return this.media.canPlayType(e)!==""}setSrc(e,t){const n=this.getSrc();if(e&&n===e)return;this.revokeSrc();const s=t instanceof Blob&&(this.canPlayType(t.type)||!e)?URL.createObjectURL(t):e;if(n&&this.media.removeAttribute("src"),s||e)try{this.media.src=s}catch{this.media.src=e}}destroy(){this.reactiveMediaEventCleanups.forEach((e=>e())),this.reactiveMediaEventCleanups=[],this.isExternalMedia||(this.media.pause(),this.revokeSrc(),this.media.removeAttribute("src"),this.media.load(),this.media.remove())}setMediaElement(e){this.reactiveMediaEventCleanups.forEach((t=>t())),this.reactiveMediaEventCleanups=[],this.media=e,this.setupReactiveMediaEvents()}play(){return ke(this,void 0,void 0,(function*(){try{return yield this.media.play()}catch(e){if(e instanceof DOMException&&e.name==="AbortError")return;throw e}}))}pause(){this.media.pause()}isPlaying(){return!this.media.paused&&!this.media.ended}setTime(e){this.media.currentTime=Math.max(0,Math.min(e,this.getDuration()))}getDuration(){return this.media.duration}getCurrentTime(){return this.media.currentTime}getVolume(){return this.media.volume}setVolume(e){this.media.volume=e}getMuted(){return this.media.muted}setMuted(e){this.media.muted=e}getPlaybackRate(){return this.media.playbackRate}isSeeking(){return this.media.seeking}setPlaybackRate(e,t){t!=null&&(this.media.preservesPitch=t),this.media.playbackRate=e}getMediaElement(){return this.media}setSinkId(e){return this.media.setSinkId(e)}};function Nn({maxTop:r,maxBottom:e,halfHeight:t,vScale:n,barMinHeight:s=0,barAlign:o}){let a=Math.round(r*t*n),l=a+Math.round(e*t*n)||1;return l<s&&(l=s,o||(a=l/2)),{topHeight:a,totalHeight:l}}function Tn({barAlign:r,halfHeight:e,topHeight:t,totalHeight:n,canvasHeight:s}){return r==="top"?0:r==="bottom"?s-n:e-t}function At(r,e,t){const n=e-r.left,s=t-r.top;return[n/r.width,s/r.height]}function Gt(r){return!!(r.barWidth||r.barGap||r.barAlign)}function It(r,e){if(!Gt(e))return r;const t=e.barWidth||.5,n=t+(e.barGap||t/2);return n===0?r:Math.floor(r/n)*n}function zt({scrollLeft:r,totalWidth:e,numCanvases:t}){if(e===0)return[0];const n=r/e,s=Math.floor(n*t);return[s-1,s,s+1]}function Yt(r){const e=r._cleanup;typeof e=="function"&&e()}function Ln(r){const e=me({scrollLeft:r.scrollLeft,scrollWidth:r.scrollWidth,clientWidth:r.clientWidth}),t=et((()=>(function(o){const{scrollLeft:a,scrollWidth:l,clientWidth:d}=o;if(l===0)return{startX:0,endX:1};const c=a/l,u=(a+d)/l;return{startX:Math.max(0,Math.min(1,c)),endX:Math.max(0,Math.min(1,u))}})(e.value)),[e]),n=et((()=>(function(o){return{left:o.scrollLeft,right:o.scrollLeft+o.clientWidth}})(e.value)),[e]),s=()=>{e.set({scrollLeft:r.scrollLeft,scrollWidth:r.scrollWidth,clientWidth:r.clientWidth})};return r.addEventListener("scroll",s,{passive:!0}),{scrollData:e,percentages:t,bounds:n,cleanup:()=>{r.removeEventListener("scroll",s),Yt(e)}}}let Wn=class extends ft{constructor(e,t){super(),this.timeouts=[],this.isScrollable=!1,this.audioData=null,this.resizeObserver=null,this.lastContainerWidth=0,this.isDragging=!1,this.subscriptions=[],this.unsubscribeOnScroll=[],this.dragStream=null,this.scrollStream=null,this.subscriptions=[],this.options=e;const n=this.parentFromOptionsContainer(e.container);this.parent=n;const[s,o]=this.initHtml();n.appendChild(s),this.container=s,this.scrollContainer=o.querySelector(".scroll"),this.wrapper=o.querySelector(".wrapper"),this.canvasWrapper=o.querySelector(".canvases"),this.progressWrapper=o.querySelector(".progress"),this.cursor=o.querySelector(".cursor"),t&&o.appendChild(t),this.initEvents()}parentFromOptionsContainer(e){let t;if(typeof e=="string"?t=document.querySelector(e):e instanceof HTMLElement&&(t=e),!t)throw new Error("Container not found");return t}initEvents(){this.wrapper.addEventListener("click",(t=>{const n=this.wrapper.getBoundingClientRect(),[s,o]=At(n,t.clientX,t.clientY);this.emit("click",s,o)})),this.wrapper.addEventListener("dblclick",(t=>{const n=this.wrapper.getBoundingClientRect(),[s,o]=At(n,t.clientX,t.clientY);this.emit("dblclick",s,o)})),this.options.dragToSeek!==!0&&typeof this.options.dragToSeek!="object"||this.initDrag(),this.scrollStream=Ln(this.scrollContainer);const e=Ue((()=>{const{startX:t,endX:n}=this.scrollStream.percentages.value,{left:s,right:o}=this.scrollStream.bounds.value;this.emit("scroll",t,n,s,o)}),[this.scrollStream.percentages,this.scrollStream.bounds]);if(this.subscriptions.push(e),typeof ResizeObserver=="function"){const t=this.createDelay(100);this.resizeObserver=new ResizeObserver((()=>{t().then((()=>this.onContainerResize())).catch((()=>{}))})),this.resizeObserver.observe(this.scrollContainer)}}onContainerResize(){const e=this.parent.clientWidth;e===this.lastContainerWidth&&this.options.height!=="auto"||(this.lastContainerWidth=e,this.reRender(),this.emit("resize"))}initDrag(){if(this.dragStream)return;this.dragStream=(function(t,n={}){const{threshold:s=3,mouseButton:o=0,touchDelay:a=100}=n,l=me(null),d=new Map,c=matchMedia("(pointer: coarse)").matches;let u=()=>{};const f=m=>{if(m.button!==o||(d.set(m.pointerId,m),d.size>1))return;let p=m.clientX,h=m.clientY,b=!1;const v=Date.now(),C=t.getBoundingClientRect(),{left:k,top:D}=C,j=S=>{if(S.defaultPrevented||d.size>1||c&&Date.now()-v<a)return;const P=S.clientX,H=S.clientY,I=P-p,_=H-h;(b||Math.abs(I)>s||Math.abs(_)>s)&&(S.preventDefault(),S.stopPropagation(),b||(l.set({type:"start",x:p-k,y:h-D}),b=!0),l.set({type:"move",x:P-k,y:H-D,deltaX:I,deltaY:_}),p=P,h=H)},R=S=>{if(d.delete(S.pointerId),b){const P=S.clientX,H=S.clientY;l.set({type:"end",x:P-k,y:H-D})}u()},N=S=>{d.delete(S.pointerId),S.relatedTarget&&S.relatedTarget!==document.documentElement||R(S)},M=S=>{b&&(S.stopPropagation(),S.preventDefault())},O=S=>{S.defaultPrevented||d.size>1||b&&S.preventDefault()};document.addEventListener("pointermove",j),document.addEventListener("pointerup",R),document.addEventListener("pointerout",N),document.addEventListener("pointercancel",N),document.addEventListener("touchmove",O,{passive:!1}),document.addEventListener("click",M,{capture:!0}),u=()=>{document.removeEventListener("pointermove",j),document.removeEventListener("pointerup",R),document.removeEventListener("pointerout",N),document.removeEventListener("pointercancel",N),document.removeEventListener("touchmove",O),setTimeout((()=>{document.removeEventListener("click",M,{capture:!0})}),10)}};return t.addEventListener("pointerdown",f),{signal:l,cleanup:()=>{u(),t.removeEventListener("pointerdown",f),d.clear(),Yt(l)}}})(this.wrapper);const e=Ue((()=>{const t=this.dragStream.signal.value;if(!t)return;const n=this.wrapper.getBoundingClientRect().width,s=(o=t.x/n)<0?0:o>1?1:o;var o;t.type==="start"?(this.isDragging=!0,this.emit("dragstart",s)):t.type==="move"?this.emit("drag",s):t.type==="end"&&(this.isDragging=!1,this.emit("dragend",s))}),[this.dragStream.signal]);this.subscriptions.push(e)}initHtml(){const e=document.createElement("div"),t=e.attachShadow({mode:"open"}),n=this.options.cspNonce&&typeof this.options.cspNonce=="string"?this.options.cspNonce.replace(/"/g,""):"";return t.innerHTML=`
      <style${n?` nonce="${n}"`:""}>
        :host {
          user-select: none;
          min-width: 1px;
        }
        :host audio {
          display: block;
          width: 100%;
        }
        :host .scroll {
          overflow-x: auto;
          overflow-y: hidden;
          width: 100%;
          position: relative;
        }
        :host .noScrollbar {
          scrollbar-color: transparent;
          scrollbar-width: none;
        }
        :host .noScrollbar::-webkit-scrollbar {
          display: none;
          -webkit-appearance: none;
        }
        :host .wrapper {
          position: relative;
          overflow: visible;
          z-index: 2;
        }
        :host .canvases {
          min-height: ${this.getHeight(this.options.height,this.options.splitChannels)}px;
          pointer-events: none;
        }
        :host .canvases > div {
          position: relative;
        }
        :host canvas {
          display: block;
          position: absolute;
          top: 0;
          image-rendering: pixelated;
        }
        :host .progress {
          pointer-events: none;
          position: absolute;
          z-index: 2;
          top: 0;
          left: 0;
          width: 0;
          height: 100%;
          overflow: hidden;
        }
        :host .progress > div {
          position: relative;
        }
        :host .cursor {
          pointer-events: none;
          position: absolute;
          z-index: 5;
          top: 0;
          left: 0;
          height: 100%;
          border-radius: 2px;
        }
      </style>

      <div class="scroll" part="scroll">
        <div class="wrapper" part="wrapper">
          <div class="canvases" part="canvases"></div>
          <div class="progress" part="progress"></div>
          <div class="cursor" part="cursor"></div>
        </div>
      </div>
    `,[e,t]}setOptions(e){if(this.options.container!==e.container){const t=this.parentFromOptionsContainer(e.container);t.appendChild(this.container),this.parent=t}e.dragToSeek!==!0&&typeof this.options.dragToSeek!="object"||this.initDrag(),this.options=e,this.reRender()}getWrapper(){return this.wrapper}getWidth(){return this.scrollContainer.clientWidth}getScroll(){return this.scrollContainer.scrollLeft}setScroll(e){this.scrollContainer.scrollLeft=e}setScrollPercentage(e){const{scrollWidth:t}=this.scrollContainer,n=t*e;this.setScroll(n)}destroy(){var e;this.subscriptions.forEach((t=>t())),this.container.remove(),this.resizeObserver&&(this.resizeObserver.disconnect(),this.resizeObserver=null),(e=this.unsubscribeOnScroll)===null||e===void 0||e.forEach((t=>t())),this.unsubscribeOnScroll=[],this.dragStream&&(this.dragStream.cleanup(),this.dragStream=null),this.scrollStream&&(this.scrollStream.cleanup(),this.scrollStream=null)}createDelay(e=10){let t,n;const s=()=>{t&&(clearTimeout(t),t=void 0),n&&(n(),n=void 0)};return this.timeouts.push(s),()=>new Promise(((o,a)=>{s(),n=a,t=setTimeout((()=>{t=void 0,n=void 0,o()}),e)}))}getHeight(e,t){var n;const s=((n=this.audioData)===null||n===void 0?void 0:n.numberOfChannels)||1;return(function({optionsHeight:o,optionsSplitChannels:a,parentHeight:l,numberOfChannels:d,defaultHeight:c=128}){if(o==null)return c;const u=Number(o);if(!isNaN(u))return u;if(o==="auto"){const f=l||c;return a?.every((m=>!m.overlay))?f/d:f}return c})({optionsHeight:e,optionsSplitChannels:t,parentHeight:this.parent.clientHeight,numberOfChannels:s,defaultHeight:128})}convertColorValues(e,t){return(function(n,s,o){if(!Array.isArray(n))return n||"";if(n.length===0)return"#999";if(n.length<2)return n[0]||"";const a=document.createElement("canvas"),l=a.getContext("2d"),d=o??a.height*s,c=l.createLinearGradient(0,0,0,d||s),u=1/(n.length-1);return n.forEach(((f,m)=>{c.addColorStop(m*u,f)})),c})(e,this.getPixelRatio(),t?.canvas.height)}getPixelRatio(){return e=window.devicePixelRatio,Math.max(1,e||1);var e}renderBarWaveform(e,t,n,s){const{width:o,height:a}=n.canvas,{halfHeight:l,barWidth:d,barRadius:c,barIndexScale:u,barSpacing:f,barMinHeight:m}=(function({width:h,height:b,length:v,options:C,pixelRatio:k}){const D=b/2,j=C.barWidth?C.barWidth*k:1,R=C.barGap?C.barGap*k:C.barWidth?j/2:0,N=j+R||1;return{halfHeight:D,barWidth:j,barGap:R,barRadius:C.barRadius||0,barMinHeight:C.barMinHeight?C.barMinHeight*k:0,barIndexScale:v>0?h/N/v:0,barSpacing:N}})({width:o,height:a,length:(e[0]||[]).length,options:t,pixelRatio:this.getPixelRatio()}),p=(function({channelData:h,barIndexScale:b,barSpacing:v,barWidth:C,halfHeight:k,vScale:D,canvasHeight:j,barAlign:R,barMinHeight:N}){const M=h[0]||[],O=h[1]||M,S=M.length,P=[];let H=0,I=0,_=0;for(let E=0;E<=S;E++){const z=Math.round(E*b);if(z>H){const{topHeight:ce,totalHeight:de}=Nn({maxTop:I,maxBottom:_,halfHeight:k,vScale:D,barMinHeight:N,barAlign:R}),ge=Tn({barAlign:R,halfHeight:k,topHeight:ce,totalHeight:de,canvasHeight:j});P.push({x:H*v,y:ge,width:C,height:de}),H=z,I=0,_=0}const ie=Math.abs(M[E]||0),K=Math.abs(O[E]||0);ie>I&&(I=ie),K>_&&(_=K)}return P})({channelData:e,barIndexScale:u,barSpacing:f,barWidth:d,halfHeight:l,vScale:s,canvasHeight:a,barAlign:t.barAlign,barMinHeight:m});n.beginPath();for(const h of p)c&&"roundRect"in n?n.roundRect(h.x,h.y,h.width,h.height,c):n.rect(h.x,h.y,h.width,h.height);n.fill(),n.closePath()}renderLineWaveform(e,t,n,s){const{width:o,height:a}=n.canvas,l=(function({channelData:d,width:c,height:u,vScale:f}){const m=u/2,p=d[0]||[];return[p,d[1]||p].map(((h,b)=>{const v=h.length,C=v?c/v:0,k=m,D=b===0?-1:1,j=[{x:0,y:k}];let R=0,N=0;for(let M=0;M<=v;M++){const O=Math.round(M*C);if(O>R){const P=k+(Math.round(N*m*f)||1)*D;j.push({x:R,y:P}),R=O,N=0}const S=Math.abs(h[M]||0);S>N&&(N=S)}return j.push({x:R,y:k}),j}))})({channelData:e,width:o,height:a,vScale:s});n.beginPath();for(const d of l)if(d.length){n.moveTo(d[0].x,d[0].y);for(let c=1;c<d.length;c++){const u=d[c];n.lineTo(u.x,u.y)}}n.fill(),n.closePath()}renderWaveform(e,t,n){if(n.fillStyle=this.convertColorValues(t.waveColor,n),t.renderFunction)return void t.renderFunction(e,n);const s=(function({channelData:o,barHeight:a,normalize:l,maxPeak:d}){var c;const u=a||1;if(!l)return u;const f=o[0];if(!f||f.length===0)return u;let m=d??0;if(!d)for(let p=0;p<f.length;p++){const h=(c=f[p])!==null&&c!==void 0?c:0,b=Math.abs(h);b>m&&(m=b)}return m?u/m:u})({channelData:e,barHeight:t.barHeight,normalize:t.normalize,maxPeak:t.maxPeak});Gt(t)?this.renderBarWaveform(e,t,n,s):this.renderLineWaveform(e,t,n,s)}renderSingleCanvas(e,t,n,s,o,a,l){const d=this.getPixelRatio(),c=document.createElement("canvas");c.width=Math.round(n*d),c.height=Math.round(s*d),c.style.width=`${n}px`,c.style.height=`${s}px`,c.style.left=`${Math.round(o)}px`,a.appendChild(c);const u=c.getContext("2d");if(t.renderFunction?(u.fillStyle=this.convertColorValues(t.waveColor,u),t.renderFunction(e,u)):this.renderWaveform(e,t,u),c.width>0&&c.height>0){const f=c.cloneNode(),m=f.getContext("2d");m.drawImage(c,0,0),m.globalCompositeOperation="source-in",m.fillStyle=this.convertColorValues(t.progressColor,m),m.fillRect(0,0,c.width,c.height),l.appendChild(f)}}renderMultiCanvas(e,t,n,s,o,a){const l=this.getPixelRatio(),{clientWidth:d}=this.scrollContainer,c=n/l,u=(function({clientWidth:h,totalWidth:b,options:v}){return It(Math.min(8e3,h,b),v)})({clientWidth:d,totalWidth:c,options:t});let f={};if(u===0)return;const m=h=>{if(h<0||h>=p||f[h])return;f[h]=!0;const b=h*u;let v=Math.min(c-b,u);if(v=It(v,t),v<=0)return;const C=(function({channelData:k,offset:D,clampedWidth:j,totalWidth:R}){return k.map((N=>{const M=Math.floor(D/R*N.length),O=Math.floor((D+j)/R*N.length);return N.slice(M,O)}))})({channelData:e,offset:b,clampedWidth:v,totalWidth:c});this.renderSingleCanvas(C,t,v,s,b,o,a)},p=Math.ceil(c/u);if(!this.isScrollable){for(let h=0;h<p;h++)m(h);return}if(zt({scrollLeft:this.scrollContainer.scrollLeft,totalWidth:c,numCanvases:p}).forEach((h=>m(h))),p>1){const h=this.on("scroll",(()=>{const{scrollLeft:b}=this.scrollContainer;Object.keys(f).length>10&&(o.innerHTML="",a.innerHTML="",f={}),zt({scrollLeft:b,totalWidth:c,numCanvases:p}).forEach((v=>m(v)))}));this.unsubscribeOnScroll.push(h)}}renderChannel(e,t,n,s){var{overlay:o}=t,a=(function(u,f){var m={};for(var p in u)Object.prototype.hasOwnProperty.call(u,p)&&f.indexOf(p)<0&&(m[p]=u[p]);if(u!=null&&typeof Object.getOwnPropertySymbols=="function"){var h=0;for(p=Object.getOwnPropertySymbols(u);h<p.length;h++)f.indexOf(p[h])<0&&Object.prototype.propertyIsEnumerable.call(u,p[h])&&(m[p[h]]=u[p[h]])}return m})(t,["overlay"]);const l=document.createElement("div"),d=this.getHeight(a.height,a.splitChannels);l.style.height=`${d}px`,o&&s>0&&(l.style.marginTop=`-${d}px`),this.canvasWrapper.style.minHeight=`${d}px`,this.canvasWrapper.appendChild(l);const c=l.cloneNode();this.progressWrapper.appendChild(c),this.renderMultiCanvas(e,a,n,d,l,c)}render(e){return ke(this,void 0,void 0,(function*(){var t;this.timeouts.forEach((c=>c())),this.timeouts=[],this.canvasWrapper.innerHTML="",this.progressWrapper.innerHTML="",this.options.width!=null&&(this.scrollContainer.style.width=typeof this.options.width=="number"?`${this.options.width}px`:this.options.width);const n=this.getPixelRatio(),s=this.scrollContainer.clientWidth,{scrollWidth:o,isScrollable:a,useParentWidth:l,width:d}=(function({duration:c,minPxPerSec:u=0,parentWidth:f,fillParent:m,pixelRatio:p}){const h=Math.ceil(c*u),b=h>f,v=!!(m&&!b);return{scrollWidth:h,isScrollable:b,useParentWidth:v,width:(v?f:h)*p}})({duration:e.duration,minPxPerSec:this.options.minPxPerSec||0,parentWidth:s,fillParent:this.options.fillParent,pixelRatio:n});if(this.isScrollable=a,this.wrapper.style.width=l?"100%":`${o}px`,this.scrollContainer.style.overflowX=this.isScrollable?"auto":"hidden",this.scrollContainer.classList.toggle("noScrollbar",!!this.options.hideScrollbar),this.cursor.style.backgroundColor=`${this.options.cursorColor||this.options.progressColor}`,this.cursor.style.width=`${this.options.cursorWidth}px`,this.audioData=e,this.emit("render"),this.options.splitChannels)for(let c=0;c<e.numberOfChannels;c++){const u=Object.assign(Object.assign({},this.options),(t=this.options.splitChannels)===null||t===void 0?void 0:t[c]);this.renderChannel([e.getChannelData(c)],u,d,c)}else{const c=[e.getChannelData(0)];e.numberOfChannels>1&&c.push(e.getChannelData(1)),this.renderChannel(c,this.options,d,0)}Promise.resolve().then((()=>this.emit("rendered")))}))}reRender(){if(this.unsubscribeOnScroll.forEach((n=>n())),this.unsubscribeOnScroll=[],!this.audioData)return;const{scrollWidth:e}=this.scrollContainer,{right:t}=this.progressWrapper.getBoundingClientRect();if(this.render(this.audioData),this.isScrollable&&e!==this.scrollContainer.scrollWidth){const{right:n}=this.progressWrapper.getBoundingClientRect(),s=(function(o){const a=2*o;return(a<0?Math.floor(a):Math.ceil(a))/2})(n-t);this.scrollContainer.scrollLeft+=s}}zoom(e){this.options.minPxPerSec=e,this.reRender()}scrollIntoView(e,t=!1){const{scrollLeft:n,scrollWidth:s,clientWidth:o}=this.scrollContainer,a=e*s,l=n,d=n+o,c=o/2;if(this.isDragging)a+30>d?this.scrollContainer.scrollLeft+=30:a-30<l&&(this.scrollContainer.scrollLeft-=30);else{(a<l||a>d)&&(this.scrollContainer.scrollLeft=a-(this.options.autoCenter?c:0));const u=a-n-c;t&&this.options.autoCenter&&u>0&&(this.scrollContainer.scrollLeft+=u)}}renderProgress(e,t){if(isNaN(e))return;const n=100*e;this.canvasWrapper.style.clipPath=`polygon(${n}% 0%, 100% 0%, 100% 100%, ${n}% 100%)`,this.progressWrapper.style.width=`${n}%`,this.cursor.style.left=`${n}%`,this.cursor.style.transform=this.options.cursorWidth?`translateX(-${e*this.options.cursorWidth}px)`:"",this.isScrollable&&this.options.autoScroll&&this.audioData&&this.audioData.duration>0&&this.scrollIntoView(e,t)}exportImage(e,t,n){return ke(this,void 0,void 0,(function*(){const s=this.canvasWrapper.querySelectorAll("canvas");if(!s.length)throw new Error("No waveform data");if(n==="dataURL"){const o=Array.from(s).map((a=>a.toDataURL(e,t)));return Promise.resolve(o)}return Promise.all(Array.from(s).map((o=>new Promise(((a,l)=>{o.toBlob((d=>{d?a(d):l(new Error("Could not export image"))}),e,t)})))))}))}},On=class extends ft{constructor(){super(...arguments),this.animationFrameId=null,this.isRunning=!1}start(){if(this.isRunning)return;this.isRunning=!0;const e=()=>{this.isRunning&&(this.emit("tick"),this.animationFrameId=requestAnimationFrame(e))};e()}stop(){this.isRunning=!1,this.animationFrameId!==null&&(cancelAnimationFrame(this.animationFrameId),this.animationFrameId=null)}destroy(){this.stop()}},Mt=class extends ft{constructor(e=new AudioContext){super(),this.bufferNode=null,this.playStartTime=0,this.playedDuration=0,this._muted=!1,this._playbackRate=1,this._duration=void 0,this.buffer=null,this.currentSrc="",this.paused=!0,this.crossOrigin=null,this.seeking=!1,this.autoplay=!1,this.addEventListener=this.on,this.removeEventListener=this.un,this.audioContext=e,this.gainNode=this.audioContext.createGain(),this.gainNode.connect(this.audioContext.destination)}load(){return ke(this,void 0,void 0,(function*(){}))}get src(){return this.currentSrc}set src(e){if(this.currentSrc=e,this._duration=void 0,!e)return this.buffer=null,void this.emit("emptied");fetch(e).then((t=>{if(t.status>=400)throw new Error(`Failed to fetch ${e}: ${t.status} (${t.statusText})`);return t.arrayBuffer()})).then((t=>this.currentSrc!==e?null:this.audioContext.decodeAudioData(t))).then((t=>{this.currentSrc===e&&(this.buffer=t,this.emit("loadedmetadata"),this.emit("canplay"),this.autoplay&&this.play())})).catch((t=>{console.error("WebAudioPlayer load error:",t)}))}_play(){if(!this.paused)return;this.paused=!1,this.bufferNode&&(this.bufferNode.onended=null,this.bufferNode.disconnect()),this.bufferNode=this.audioContext.createBufferSource(),this.buffer&&(this.bufferNode.buffer=this.buffer),this.bufferNode.playbackRate.value=this._playbackRate,this.bufferNode.connect(this.gainNode);let e=this.playedDuration*this._playbackRate;(e>=this.duration||e<0)&&(e=0,this.playedDuration=0),this.bufferNode.start(this.audioContext.currentTime,e),this.playStartTime=this.audioContext.currentTime,this.bufferNode.onended=()=>{this.currentTime>=this.duration&&(this.pause(),this.emit("ended"))}}_pause(){var e;this.paused=!0,(e=this.bufferNode)===null||e===void 0||e.stop(),this.playedDuration+=this.audioContext.currentTime-this.playStartTime}play(){return ke(this,void 0,void 0,(function*(){this.paused&&(this._play(),this.emit("play"))}))}pause(){this.paused||(this._pause(),this.emit("pause"))}stopAt(e){const t=e-this.currentTime,n=this.bufferNode;n?.stop(this.audioContext.currentTime+t),n?.addEventListener("ended",(()=>{n===this.bufferNode&&(this.bufferNode=null,this.pause())}),{once:!0})}setSinkId(e){return ke(this,void 0,void 0,(function*(){return this.audioContext.setSinkId(e)}))}get playbackRate(){return this._playbackRate}set playbackRate(e){this._playbackRate=e,this.bufferNode&&(this.bufferNode.playbackRate.value=e)}get currentTime(){return(this.paused?this.playedDuration:this.playedDuration+(this.audioContext.currentTime-this.playStartTime))*this._playbackRate}set currentTime(e){const t=!this.paused;t&&this._pause(),this.playedDuration=e/this._playbackRate,t&&this._play(),this.emit("seeking"),this.emit("timeupdate")}get duration(){var e,t;return(e=this._duration)!==null&&e!==void 0?e:((t=this.buffer)===null||t===void 0?void 0:t.duration)||0}set duration(e){this._duration=e}get volume(){return this.gainNode.gain.value}set volume(e){this.gainNode.gain.value=e,this.emit("volumechange")}get muted(){return this._muted}set muted(e){this._muted!==e&&(this._muted=e,this._muted?this.gainNode.disconnect():this.gainNode.connect(this.audioContext.destination))}canPlayType(e){return/^(audio|video)\//.test(e)}getGainNode(){return this.gainNode}getChannelData(){const e=[];if(!this.buffer)return e;const t=this.buffer.numberOfChannels;for(let n=0;n<t;n++)e.push(this.buffer.getChannelData(n));return e}removeAttribute(e){switch(e){case"src":this.src="";break;case"playbackRate":this.playbackRate=0;break;case"currentTime":this.currentTime=0;break;case"duration":this.duration=0;break;case"volume":this.volume=0;break;case"muted":this.muted=!1}}};const An={waveColor:"#999",progressColor:"#555",cursorWidth:1,minPxPerSec:0,fillParent:!0,interact:!0,dragToSeek:!1,autoScroll:!0,autoCenter:!0,sampleRate:8e3};let kt=class Zt extends Dn{static create(e){return new Zt(e)}getState(){return this.wavesurferState}getRenderer(){return this.renderer}constructor(e){const t=e.media||(e.backend==="WebAudio"?new Mt:void 0);super({media:t,mediaControls:e.mediaControls,autoplay:e.autoplay,playbackRate:e.audioRate}),this.plugins=[],this.decodedData=null,this.stopAtPosition=null,this.subscriptions=[],this.mediaSubscriptions=[],this.abortController=null,this.reactiveCleanups=[],this.options=Object.assign({},An,e);const{state:n,actions:s}=(function(l){var d,c,u,f,m,p;const h=(d=l?.currentTime)!==null&&d!==void 0?d:me(0),b=(c=l?.duration)!==null&&c!==void 0?c:me(0),v=(u=l?.isPlaying)!==null&&u!==void 0?u:me(!1),C=(f=l?.isSeeking)!==null&&f!==void 0?f:me(!1),k=(m=l?.volume)!==null&&m!==void 0?m:me(1),D=(p=l?.playbackRate)!==null&&p!==void 0?p:me(1),j=me(null),R=me(null),N=me(""),M=me(0),O=me(0),S=et((()=>!v.value),[v]),P=et((()=>j.value!==null),[j]),H=et((()=>P.value&&b.value>0),[P,b]),I=et((()=>h.value),[h]),_=et((()=>b.value>0?h.value/b.value:0),[h,b]);return{state:{currentTime:h,duration:b,isPlaying:v,isPaused:S,isSeeking:C,volume:k,playbackRate:D,audioBuffer:j,peaks:R,url:N,zoom:M,scrollPosition:O,canPlay:P,isReady:H,progress:I,progressPercent:_},actions:{setCurrentTime:E=>{const z=Math.max(0,Math.min(b.value||1/0,E));h.set(z)},setDuration:E=>{b.set(Math.max(0,E))},setPlaying:E=>{v.set(E)},setSeeking:E=>{C.set(E)},setVolume:E=>{const z=Math.max(0,Math.min(1,E));k.set(z)},setPlaybackRate:E=>{const z=Math.max(.1,Math.min(16,E));D.set(z)},setAudioBuffer:E=>{j.set(E),E&&b.set(E.duration)},setPeaks:E=>{R.set(E)},setUrl:E=>{N.set(E)},setZoom:E=>{M.set(Math.max(0,E))},setScrollPosition:E=>{O.set(Math.max(0,E))}}}})({isPlaying:this.isPlayingSignal,currentTime:this.currentTimeSignal,duration:this.durationSignal,volume:this.volumeSignal,playbackRate:this.playbackRateSignal,isSeeking:this.seekingSignal});this.wavesurferState=n,this.wavesurferActions=s,this.timer=new On;const o=t?void 0:this.getMediaElement();this.renderer=new Wn(this.options,o),this.initPlayerEvents(),this.initRendererEvents(),this.initTimerEvents(),this.initReactiveState(),this.initPlugins();const a=this.options.url||this.getSrc()||"";Promise.resolve().then((()=>{this.emit("init");const{peaks:l,duration:d}=this.options;(a||l&&d)&&this.load(a,l,d).catch((c=>{this.emit("error",c instanceof Error?c:new Error(String(c)))}))}))}updateProgress(e=this.getCurrentTime()){return this.renderer.renderProgress(e/this.getDuration(),this.isPlaying()),e}initTimerEvents(){this.subscriptions.push(this.timer.on("tick",(()=>{if(!this.isSeeking()){const e=this.updateProgress();this.emit("timeupdate",e),this.emit("audioprocess",e),this.stopAtPosition!=null&&this.isPlaying()&&e>=this.stopAtPosition&&this.pause()}})))}initReactiveState(){this.reactiveCleanups.push((function(e,t){const n=[];n.push(Ue((()=>{const a=e.isPlaying.value;t.emit(a?"play":"pause")}),[e.isPlaying])),n.push(Ue((()=>{const a=e.currentTime.value;t.emit("timeupdate",a),e.isPlaying.value&&t.emit("audioprocess",a)}),[e.currentTime,e.isPlaying])),n.push(Ue((()=>{e.isSeeking.value&&t.emit("seeking",e.currentTime.value)}),[e.isSeeking,e.currentTime]));let s=!1;n.push(Ue((()=>{e.isReady.value&&!s&&(s=!0,t.emit("ready",e.duration.value))}),[e.isReady,e.duration]));let o=!1;return n.push(Ue((()=>{const a=e.isPlaying.value,l=e.currentTime.value,d=e.duration.value,c=d>0&&l>=d;o&&!a&&c&&t.emit("finish"),o=a&&c}),[e.isPlaying,e.currentTime,e.duration])),n.push(Ue((()=>{const a=e.zoom.value;a>0&&t.emit("zoom",a)}),[e.zoom])),()=>{n.forEach((a=>a()))}})(this.wavesurferState,{emit:this.emit.bind(this)}))}initPlayerEvents(){this.isPlaying()&&(this.emit("play"),this.timer.start()),this.mediaSubscriptions.push(this.onMediaEvent("timeupdate",(()=>{const e=this.updateProgress();this.emit("timeupdate",e)})),this.onMediaEvent("play",(()=>{this.emit("play"),this.timer.start()})),this.onMediaEvent("pause",(()=>{this.emit("pause"),this.timer.stop(),this.stopAtPosition=null})),this.onMediaEvent("emptied",(()=>{this.timer.stop(),this.stopAtPosition=null})),this.onMediaEvent("ended",(()=>{this.emit("timeupdate",this.getDuration()),this.emit("finish"),this.stopAtPosition=null})),this.onMediaEvent("seeking",(()=>{this.emit("seeking",this.getCurrentTime())})),this.onMediaEvent("error",(()=>{var e;this.emit("error",(e=this.getMediaElement().error)!==null&&e!==void 0?e:new Error("Media error")),this.stopAtPosition=null})))}initRendererEvents(){this.subscriptions.push(this.renderer.on("click",((e,t)=>{this.options.interact&&(this.seekTo(e),this.emit("interaction",e*this.getDuration()),this.emit("click",e,t))})),this.renderer.on("dblclick",((e,t)=>{this.emit("dblclick",e,t)})),this.renderer.on("scroll",((e,t,n,s)=>{const o=this.getDuration();this.emit("scroll",e*o,t*o,n,s)})),this.renderer.on("render",(()=>{this.emit("redraw")})),this.renderer.on("rendered",(()=>{this.emit("redrawcomplete")})),this.renderer.on("dragstart",(e=>{this.emit("dragstart",e)})),this.renderer.on("dragend",(e=>{this.emit("dragend",e)})),this.renderer.on("resize",(()=>{this.emit("resize")})));{let e;const t=this.renderer.on("drag",(n=>{var s;if(!this.options.interact)return;this.renderer.renderProgress(n),clearTimeout(e);let o=0;const a=this.options.dragToSeek;this.isPlaying()?o=0:a===!0?o=200:a&&typeof a=="object"&&(o=(s=a.debounceTime)!==null&&s!==void 0?s:200),e=setTimeout((()=>{this.seekTo(n)}),o),this.emit("interaction",n*this.getDuration()),this.emit("drag",n)}));this.subscriptions.push((()=>{clearTimeout(e),t()}))}}initPlugins(){var e;!((e=this.options.plugins)===null||e===void 0)&&e.length&&this.options.plugins.forEach((t=>{this.registerPlugin(t)}))}unsubscribePlayerEvents(){this.mediaSubscriptions.forEach((e=>e())),this.mediaSubscriptions=[]}setOptions(e){this.options=Object.assign({},this.options,e),e.duration&&!e.peaks&&(this.decodedData=yt.createBuffer(this.exportPeaks(),e.duration)),e.peaks&&e.duration&&(this.decodedData=yt.createBuffer(e.peaks,e.duration)),this.renderer.setOptions(this.options),e.audioRate&&this.setPlaybackRate(e.audioRate),e.mediaControls!=null&&(this.getMediaElement().controls=e.mediaControls)}registerPlugin(e){if(this.plugins.includes(e))return e;e._init(this),this.plugins.push(e);const t=e.once("destroy",(()=>{this.plugins=this.plugins.filter((n=>n!==e)),this.subscriptions=this.subscriptions.filter((n=>n!==t))}));return this.subscriptions.push(t),e}unregisterPlugin(e){this.plugins=this.plugins.filter((t=>t!==e)),e.destroy()}getWrapper(){return this.renderer.getWrapper()}getWidth(){return this.renderer.getWidth()}getScroll(){return this.renderer.getScroll()}setScroll(e){return this.renderer.setScroll(e)}setScrollTime(e){const t=e/this.getDuration();this.renderer.setScrollPercentage(t)}getActivePlugins(){return this.plugins}loadAudio(e,t,n,s){return ke(this,void 0,void 0,(function*(){var o;if(this.emit("load",e),!this.options.media&&this.isPlaying()&&this.pause(),this.decodedData=null,this.stopAtPosition=null,(o=this.abortController)===null||o===void 0||o.abort(),this.abortController=null,!t&&!n){const l=this.options.fetchParams||{};window.AbortController&&!l.signal&&(this.abortController=new AbortController,l.signal=this.abortController.signal);const d=u=>this.emit("loading",u);t=yield Pn.fetchBlob(e,d,l);const c=this.options.blobMimeType;c&&(t=new Blob([t],{type:c}))}this.setSrc(e,t);const a=yield new Promise((l=>{const d=s||this.getDuration();d?l(d):this.mediaSubscriptions.push(this.onMediaEvent("loadedmetadata",(()=>l(this.getDuration())),{once:!0}))}));if(!e&&!t){const l=this.getMediaElement();l instanceof Mt&&(l.duration=a)}if(n)this.decodedData=yt.createBuffer(n,a||0);else if(t){const l=yield t.arrayBuffer();this.decodedData=yield yt.decode(l,this.options.sampleRate)}this.decodedData&&(this.emit("decode",this.getDuration()),this.renderer.render(this.decodedData)),this.emit("ready",this.getDuration())}))}load(e,t,n){return ke(this,void 0,void 0,(function*(){try{return yield this.loadAudio(e,void 0,t,n)}catch(s){throw this.emit("error",s),s}}))}loadBlob(e,t,n){return ke(this,void 0,void 0,(function*(){try{return yield this.loadAudio("",e,t,n)}catch(s){throw this.emit("error",s),s}}))}zoom(e){if(!this.decodedData)throw new Error("No audio loaded");this.renderer.zoom(e),this.emit("zoom",e)}getDecodedData(){return this.decodedData}exportPeaks({channels:e=2,maxLength:t=8e3,precision:n=1e4}={}){if(!this.decodedData)throw new Error("The audio has not been decoded yet");const s=Math.min(e,this.decodedData.numberOfChannels),o=[];for(let a=0;a<s;a++){const l=this.decodedData.getChannelData(a),d=[],c=l.length/t;for(let u=0;u<t;u++){const f=l.slice(Math.floor(u*c),Math.ceil((u+1)*c));let m=0;for(let p=0;p<f.length;p++){const h=f[p];Math.abs(h)>Math.abs(m)&&(m=h)}d.push(Math.round(m*n)/n)}o.push(d)}return o}getDuration(){let e=super.getDuration()||0;return e!==0&&e!==1/0||!this.decodedData||(e=this.decodedData.duration),e}toggleInteraction(e){this.options.interact=e}setTime(e){this.stopAtPosition=null,super.setTime(e),this.updateProgress(e),this.emit("timeupdate",e)}seekTo(e){const t=this.getDuration()*e;this.setTime(t)}play(e,t){const n=Object.create(null,{play:{get:()=>super.play}});return ke(this,void 0,void 0,(function*(){e!=null&&this.setTime(e);const s=yield n.play.call(this);return t!=null&&(this.media instanceof Mt?this.media.stopAt(t):this.stopAtPosition=t),s}))}playPause(){return ke(this,void 0,void 0,(function*(){return this.isPlaying()?this.pause():this.play()}))}stop(){this.pause(),this.setTime(0)}skip(e){this.setTime(this.getCurrentTime()+e)}empty(){this.load("",[[0]],.001)}setMediaElement(e){this.unsubscribePlayerEvents(),super.setMediaElement(e),this.initPlayerEvents()}exportImage(){return ke(this,arguments,void 0,(function*(e="image/png",t=1,n="dataURL"){return this.renderer.exportImage(e,t,n)}))}destroy(){var e;this.emit("destroy"),(e=this.abortController)===null||e===void 0||e.abort(),this.plugins.forEach((t=>t.destroy())),this.subscriptions.forEach((t=>t())),this.unsubscribePlayerEvents(),this.reactiveCleanups.forEach((t=>t())),this.reactiveCleanups=[],this.timer.destroy(),this.renderer.destroy(),super.destroy()}};kt.BasePlugin=class extends ft{constructor(r){super(),this.subscriptions=[],this.isDestroyed=!1,this.options=r}onInit(){}_init(r){this.isDestroyed&&(this.subscriptions=[],this.isDestroyed=!1),this.wavesurfer=r,this.onInit()}destroy(){this.emit("destroy"),this.subscriptions.forEach((r=>r())),this.subscriptions=[],this.isDestroyed=!0,this.wavesurfer=void 0}},kt.dom=Mn;let Kt=class{constructor(){this.listeners={}}on(e,t,n){if(this.listeners[e]||(this.listeners[e]=new Set),n?.once){const s=(...o)=>{this.un(e,s),t(...o)};return this.listeners[e].add(s),()=>this.un(e,s)}return this.listeners[e].add(t),()=>this.un(e,t)}un(e,t){var n;(n=this.listeners[e])===null||n===void 0||n.delete(t)}once(e,t){return this.on(e,t,{once:!0})}unAll(){this.listeners={}}emit(e,...t){this.listeners[e]&&this.listeners[e].forEach((n=>n(...t)))}},In=class extends Kt{constructor(e){super(),this.subscriptions=[],this.isDestroyed=!1,this.options=e}onInit(){}_init(e){this.isDestroyed&&(this.subscriptions=[],this.isDestroyed=!1),this.wavesurfer=e,this.onInit()}destroy(){this.emit("destroy"),this.subscriptions.forEach((e=>e())),this.subscriptions=[],this.isDestroyed=!0,this.wavesurfer=void 0}};function Jt(r,e){const t=e.xmlns?document.createElementNS(e.xmlns,r):document.createElement(r);for(const[n,s]of Object.entries(e))if(n==="children"&&s)for(const[o,a]of Object.entries(s))a instanceof Node?t.appendChild(a):typeof a=="string"?t.appendChild(document.createTextNode(a)):t.appendChild(Jt(o,a));else n==="style"?Object.assign(t.style,s):n==="textContent"?t.textContent=s:t.setAttribute(n,s.toString());return t}function ht(r,e,t){const n=Jt(r,e||{});return t?.appendChild(n),n}function Qt(r){let e=r;const t=new Set;return{get value(){return e},set(n){Object.is(e,n)||(e=n,t.forEach((s=>s(e))))},update(n){this.set(n(e))},subscribe:n=>(t.add(n),()=>t.delete(n))}}function Ct(r,e){let t;const n=()=>{t&&(t(),t=void 0),t=r()},s=e.map((o=>o.subscribe(n)));return n(),()=>{t&&(t(),t=void 0),s.forEach((o=>o()))}}function ot(r,e){const t=Qt(null),n=s=>{t.set(s)};return r.addEventListener(e,n),t._cleanup=()=>{r.removeEventListener(e,n)},t}function Qe(r){const e=r._cleanup;typeof e=="function"&&e()}function St(r,e={}){const{threshold:t=3,mouseButton:n=0,touchDelay:s=100}=e,o=Qt(null),a=new Map,l=matchMedia("(pointer: coarse)").matches;let d=()=>{};const c=u=>{if(u.button!==n||(a.set(u.pointerId,u),a.size>1))return;let f=u.clientX,m=u.clientY,p=!1;const h=Date.now(),b=r.getBoundingClientRect(),{left:v,top:C}=b,k=M=>{if(M.defaultPrevented||a.size>1||l&&Date.now()-h<s)return;const O=M.clientX,S=M.clientY,P=O-f,H=S-m;(p||Math.abs(P)>t||Math.abs(H)>t)&&(M.preventDefault(),M.stopPropagation(),p||(o.set({type:"start",x:f-v,y:m-C}),p=!0),o.set({type:"move",x:O-v,y:S-C,deltaX:P,deltaY:H}),f=O,m=S)},D=M=>{if(a.delete(M.pointerId),p){const O=M.clientX,S=M.clientY;o.set({type:"end",x:O-v,y:S-C})}d()},j=M=>{a.delete(M.pointerId),M.relatedTarget&&M.relatedTarget!==document.documentElement||D(M)},R=M=>{p&&(M.stopPropagation(),M.preventDefault())},N=M=>{M.defaultPrevented||a.size>1||p&&M.preventDefault()};document.addEventListener("pointermove",k),document.addEventListener("pointerup",D),document.addEventListener("pointerout",j),document.addEventListener("pointercancel",j),document.addEventListener("touchmove",N,{passive:!1}),document.addEventListener("click",R,{capture:!0}),d=()=>{document.removeEventListener("pointermove",k),document.removeEventListener("pointerup",D),document.removeEventListener("pointerout",j),document.removeEventListener("pointercancel",j),document.removeEventListener("touchmove",N),setTimeout((()=>{document.removeEventListener("click",R,{capture:!0})}),10)}};return r.addEventListener("pointerdown",c),{signal:o,cleanup:()=>{d(),r.removeEventListener("pointerdown",c),a.clear(),Qe(o)}}}let Ft=class extends Kt{constructor(e,t,n=0){var s,o,a,l,d,c,u,f,m,p;super(),this.totalDuration=t,this.numberOfChannels=n,this.element=null,this.minLength=0,this.maxLength=1/0,this.contentEditable=!1,this.subscriptions=[],this.updatingSide=void 0,this.isRemoved=!1,this.subscriptions=[],this.id=e.id||`region-${Math.random().toString(32).slice(2)}`,this.start=this.clampPosition(e.start),this.end=this.clampPosition((s=e.end)!==null&&s!==void 0?s:e.start),this.drag=(o=e.drag)===null||o===void 0||o,this.resize=(a=e.resize)===null||a===void 0||a,this.resizeStart=(l=e.resizeStart)===null||l===void 0||l,this.resizeEnd=(d=e.resizeEnd)===null||d===void 0||d,this.color=(c=e.color)!==null&&c!==void 0?c:"rgba(0, 0, 0, 0.1)",this.minLength=(u=e.minLength)!==null&&u!==void 0?u:this.minLength,this.maxLength=(f=e.maxLength)!==null&&f!==void 0?f:this.maxLength,this.channelIdx=(m=e.channelIdx)!==null&&m!==void 0?m:-1,this.contentEditable=(p=e.contentEditable)!==null&&p!==void 0?p:this.contentEditable,this.element=this.initElement(),this.setContent(e.content),this.setPart(),this.renderPosition(),this.initMouseEvents()}clampPosition(e){return Math.max(0,Math.min(this.totalDuration,e))}setPart(){var e;const t=this.start===this.end;(e=this.element)===null||e===void 0||e.setAttribute("part",`${t?"marker":"region"} ${this.id}`)}addResizeHandles(e){const t={position:"absolute",zIndex:"2",width:"6px",height:"100%",top:"0",cursor:"ew-resize",wordBreak:"keep-all"},n=ht("div",{part:"region-handle region-handle-left",style:Object.assign(Object.assign({},t),{left:"0",borderLeft:"2px solid rgba(0, 0, 0, 0.5)",borderRadius:"2px 0 0 2px"})},e),s=ht("div",{part:"region-handle region-handle-right",style:Object.assign(Object.assign({},t),{right:"0",borderRight:"2px solid rgba(0, 0, 0, 0.5)",borderRadius:"0 2px 2px 0"})},e),o=St(n,{threshold:1}),a=St(s,{threshold:1}),l=Ct((()=>{const c=o.signal.value;c&&(c.type==="move"&&c.deltaX!==void 0?this.onResize(c.deltaX,"start"):c.type==="end"&&this.onEndResizing("start"))}),[o.signal]),d=Ct((()=>{const c=a.signal.value;c&&(c.type==="move"&&c.deltaX!==void 0?this.onResize(c.deltaX,"end"):c.type==="end"&&this.onEndResizing("end"))}),[a.signal]);this.subscriptions.push((()=>{l(),d(),o.cleanup(),a.cleanup()}))}removeResizeHandles(e){const t=e.querySelector('[part*="region-handle-left"]'),n=e.querySelector('[part*="region-handle-right"]');t&&e.removeChild(t),n&&e.removeChild(n)}initElement(){if(this.isRemoved)return null;const e=this.start===this.end;let t=0,n=100;this.channelIdx>=0&&this.numberOfChannels>0&&this.channelIdx<this.numberOfChannels&&(n=100/this.numberOfChannels,t=n*this.channelIdx);const s=ht("div",{style:{position:"absolute",top:`${t}%`,height:`${n}%`,backgroundColor:e?"none":this.color,borderLeft:e?"2px solid "+this.color:"none",borderRadius:"2px",boxSizing:"border-box",transition:"background-color 0.2s ease",cursor:this.drag?"grab":"default",pointerEvents:"all"}});return!e&&this.resize&&this.addResizeHandles(s),s}renderPosition(){if(!this.element)return;const e=this.start/this.totalDuration,t=(this.totalDuration-this.end)/this.totalDuration;this.element.style.left=100*e+"%",this.element.style.right=100*t+"%"}toggleCursor(e){var t;this.drag&&(!((t=this.element)===null||t===void 0)&&t.style)&&(this.element.style.cursor=e?"grabbing":"grab")}initMouseEvents(){const{element:e}=this;if(!e)return;const t=ot(e,"click"),n=ot(e,"mouseenter"),s=ot(e,"mouseleave"),o=ot(e,"dblclick"),a=ot(e,"pointerdown"),l=ot(e,"pointerup"),d=t.subscribe((v=>v&&this.emit("click",v))),c=n.subscribe((v=>v&&this.emit("over",v))),u=s.subscribe((v=>v&&this.emit("leave",v))),f=o.subscribe((v=>v&&this.emit("dblclick",v))),m=a.subscribe((v=>v&&this.toggleCursor(!0))),p=l.subscribe((v=>v&&this.toggleCursor(!1)));this.subscriptions.push((()=>{d(),c(),u(),f(),m(),p(),Qe(t),Qe(n),Qe(s),Qe(o),Qe(a),Qe(l)}));const h=St(e),b=Ct((()=>{const v=h.signal.value;v&&(v.type==="start"?this.toggleCursor(!0):v.type==="move"&&v.deltaX!==void 0?this.onMove(v.deltaX):v.type==="end"&&(this.toggleCursor(!1),this.drag&&this.emit("update-end")))}),[h.signal]);this.subscriptions.push((()=>{b(),h.cleanup()})),this.contentEditable&&this.content&&(this.contentClickListener=v=>this.onContentClick(v),this.contentBlurListener=()=>this.onContentBlur(),this.content.addEventListener("click",this.contentClickListener),this.content.addEventListener("blur",this.contentBlurListener))}_onUpdate(e,t,n){var s;if(!(!((s=this.element)===null||s===void 0)&&s.parentElement))return;const{width:o}=this.element.parentElement.getBoundingClientRect(),a=e/o*this.totalDuration;let l=t&&t!=="start"?this.start:this.start+a,d=t&&t!=="end"?this.end:this.end+a;const c=n!==void 0;c&&this.updatingSide&&this.updatingSide!==t&&(this.updatingSide==="start"?l=n:d=n),l=Math.max(0,l),d=Math.min(this.totalDuration,d);const u=d-l;this.updatingSide=t;const f=u>=this.minLength&&u<=this.maxLength;l<=d&&(f||c)&&(this.start=l,this.end=d,this.renderPosition(),this.emit("update",t))}onMove(e){this.drag&&this._onUpdate(e)}onResize(e,t){this.resize&&(this.resizeStart||t!=="start")&&(this.resizeEnd||t!=="end")&&this._onUpdate(e,t)}onEndResizing(e){this.resize&&(this.emit("update-end",e),this.updatingSide=void 0)}onContentClick(e){e.stopPropagation(),e.target.focus(),this.emit("click",e)}onContentBlur(){this.emit("update-end")}_setTotalDuration(e){this.totalDuration=e,this.renderPosition()}play(e){this.emit("play",e&&this.end!==this.start?this.end:void 0)}getContent(e=!1){var t;return e?this.content||void 0:this.element instanceof HTMLElement?((t=this.content)===null||t===void 0?void 0:t.innerHTML)||void 0:""}setContent(e){var t;if(this.element)if(this.content&&this.contentEditable&&(this.contentClickListener&&this.content.removeEventListener("click",this.contentClickListener),this.contentBlurListener&&this.content.removeEventListener("blur",this.contentBlurListener)),(t=this.content)===null||t===void 0||t.remove(),e){if(typeof e=="string"){const n=this.start===this.end;this.content=ht("div",{style:{padding:`0.2em ${n?.2:.4}em`,display:"inline-block"},textContent:e})}else this.content=e;this.contentEditable&&(this.content.contentEditable="true",this.contentClickListener=n=>this.onContentClick(n),this.contentBlurListener=()=>this.onContentBlur(),this.content.addEventListener("click",this.contentClickListener),this.content.addEventListener("blur",this.contentBlurListener)),this.content.setAttribute("part","region-content"),this.element.appendChild(this.content),this.emit("content-changed")}else this.content=void 0}setOptions(e){var t,n;if(this.element){if(e.color&&(this.color=e.color,this.element.style.backgroundColor=this.color),e.drag!==void 0&&(this.drag=e.drag,this.element.style.cursor=this.drag?"grab":"default"),e.start!==void 0||e.end!==void 0){const s=this.start===this.end;this.start=this.clampPosition((t=e.start)!==null&&t!==void 0?t:this.start),this.end=this.clampPosition((n=e.end)!==null&&n!==void 0?n:s?this.start:this.end),this.renderPosition(),this.setPart()}if(e.content&&this.setContent(e.content),e.id&&(this.id=e.id,this.setPart()),e.resize!==void 0&&e.resize!==this.resize){const s=this.start===this.end;this.resize=e.resize,this.resize&&!s?this.addResizeHandles(this.element):this.removeResizeHandles(this.element)}e.resizeStart!==void 0&&(this.resizeStart=e.resizeStart),e.resizeEnd!==void 0&&(this.resizeEnd=e.resizeEnd)}}remove(){this.isRemoved=!0,this.emit("remove"),this.subscriptions.forEach((e=>e())),this.subscriptions=[],this.content&&this.contentEditable&&(this.contentClickListener&&(this.content.removeEventListener("click",this.contentClickListener),this.contentClickListener=void 0),this.contentBlurListener&&(this.content.removeEventListener("blur",this.contentBlurListener),this.contentBlurListener=void 0)),this.element&&(this.element.remove(),this.element=null),this.unAll()}},en=class tn extends In{constructor(e){super(e),this.regions=[],this.regionsContainer=this.initRegionsContainer()}static create(e){return new tn(e)}onInit(){if(!this.wavesurfer)throw Error("WaveSurfer is not initialized");this.wavesurfer.getWrapper().appendChild(this.regionsContainer),this.subscriptions.push(this.wavesurfer.on("ready",(t=>{this.regions.forEach((n=>n._setTotalDuration(t)))})));let e=[];this.subscriptions.push(this.wavesurfer.on("timeupdate",(t=>{const n=this.regions.filter((s=>s.start<=t&&(s.end===s.start?s.start+.05:s.end)>=t));n.forEach((s=>{e.includes(s)||this.emit("region-in",s)})),e.forEach((s=>{n.includes(s)||this.emit("region-out",s)})),e=n})))}initRegionsContainer(){return ht("div",{part:"regions-container",style:{position:"absolute",top:"0",left:"0",width:"100%",height:"100%",zIndex:"5",pointerEvents:"none"}})}getRegions(){return this.regions}avoidOverlapping(e){e.content&&setTimeout((()=>{const t=e.content,n=t.getBoundingClientRect(),s=this.regions.map((o=>{if(o===e||!o.content)return 0;const a=o.content.getBoundingClientRect();return n.left<a.left+a.width&&a.left<n.left+n.width?a.height:0})).reduce(((o,a)=>o+a),0);t.style.marginTop=`${s}px`}),10)}adjustScroll(e){var t,n;if(!e.element)return;const s=(n=(t=this.wavesurfer)===null||t===void 0?void 0:t.getWrapper())===null||n===void 0?void 0:n.parentElement;if(!s)return;const{clientWidth:o,scrollWidth:a}=s;if(a<=o)return;const l=s.getBoundingClientRect(),d=e.element.getBoundingClientRect(),c=d.left-l.left,u=d.right-l.left;c<0?s.scrollLeft+=c:u>o&&(s.scrollLeft+=u-o)}virtualAppend(e,t,n){const s=()=>{if(!this.wavesurfer)return;const o=this.wavesurfer.getWidth(),a=this.wavesurfer.getScroll(),l=t.clientWidth,d=this.wavesurfer.getDuration(),c=Math.round(e.start/d*l),u=c+(Math.round((e.end-e.start)/d*l)||1)>a&&c<a+o;u&&!n.parentElement?t.appendChild(n):!u&&n.parentElement&&n.remove()};setTimeout((()=>{if(!this.wavesurfer||!e.element)return;s();const o=this.wavesurfer.on("scroll",s),a=this.wavesurfer.on("zoom",s),l=this.wavesurfer.on("resize",s);this.subscriptions.push(o,a,l),e.once("remove",(()=>{o(),a(),l()}))}),0)}saveRegion(e){if(!e.element)return;this.virtualAppend(e,this.regionsContainer,e.element),this.avoidOverlapping(e),this.regions.push(e);const t=[e.on("update",(n=>{n||this.adjustScroll(e),this.emit("region-update",e,n)})),e.on("update-end",(n=>{this.avoidOverlapping(e),this.emit("region-updated",e,n)})),e.on("play",(n=>{var s;(s=this.wavesurfer)===null||s===void 0||s.play(e.start,n)})),e.on("click",(n=>{this.emit("region-clicked",e,n)})),e.on("dblclick",(n=>{this.emit("region-double-clicked",e,n)})),e.on("content-changed",(()=>{this.emit("region-content-changed",e)})),e.once("remove",(()=>{t.forEach((n=>n())),this.regions=this.regions.filter((n=>n!==e)),this.emit("region-removed",e)}))];this.subscriptions.push(...t),this.emit("region-created",e)}addRegion(e){var t,n;if(!this.wavesurfer)throw Error("WaveSurfer is not initialized");const s=this.wavesurfer.getDuration(),o=(n=(t=this.wavesurfer)===null||t===void 0?void 0:t.getDecodedData())===null||n===void 0?void 0:n.numberOfChannels,a=new Ft(e,s,o);return this.emit("region-initialized",a),s?this.saveRegion(a):this.subscriptions.push(this.wavesurfer.once("ready",(l=>{a._setTotalDuration(l),this.saveRegion(a)}))),a}enableDragSelection(e,t=3){var n;const s=(n=this.wavesurfer)===null||n===void 0?void 0:n.getWrapper();if(!(s&&s instanceof HTMLElement))return()=>{};let o=null,a=0,l=0;const d=St(s,{threshold:t}),c=Ct((()=>{var u,f;const m=d.signal.value;if(m)if(m.type==="start"){if(a=m.x,!this.wavesurfer)return;const p=this.wavesurfer.getDuration(),h=(f=(u=this.wavesurfer)===null||u===void 0?void 0:u.getDecodedData())===null||f===void 0?void 0:f.numberOfChannels,{width:b}=this.wavesurfer.getWrapper().getBoundingClientRect();l=a/b*p;const v=m.x/b*p,C=(m.x+5)/b*p;o=new Ft(Object.assign(Object.assign({},e),{start:v,end:C}),p,h),this.emit("region-initialized",o),o.element&&this.regionsContainer.appendChild(o.element)}else m.type==="move"&&m.deltaX!==void 0?o&&o._onUpdate(m.deltaX,m.x>a?"end":"start",l):m.type==="end"&&o&&(this.saveRegion(o),o.updatingSide=void 0,o=null)}),[d.signal]);return()=>{c(),d.cleanup()}}clearRegions(){this.regions.slice().forEach((e=>e.remove())),this.regions=[]}destroy(){this.clearRegions(),super.destroy(),this.regionsContainer.remove()}};class gt{constructor(){this.listeners={}}on(e,t,n){if(this.listeners[e]||(this.listeners[e]=new Set),n?.once){const s=(...o)=>{this.un(e,s),t(...o)};return this.listeners[e].add(s),()=>this.un(e,s)}return this.listeners[e].add(t),()=>this.un(e,t)}un(e,t){var n;(n=this.listeners[e])===null||n===void 0||n.delete(t)}once(e,t){return this.on(e,t,{once:!0})}unAll(){this.listeners={}}emit(e,...t){this.listeners[e]&&this.listeners[e].forEach((n=>n(...t)))}}class nn extends gt{constructor(e){super(),this.subscriptions=[],this.isDestroyed=!1,this.options=e}onInit(){}_init(e){this.isDestroyed&&(this.subscriptions=[],this.isDestroyed=!1),this.wavesurfer=e,this.onInit()}destroy(){this.emit("destroy"),this.subscriptions.forEach((e=>e())),this.subscriptions=[],this.isDestroyed=!0,this.wavesurfer=void 0}}function Re(r,e,t,n){return new(t||(t=Promise))((function(s,o){function a(c){try{d(n.next(c))}catch(u){o(u)}}function l(c){try{d(n.throw(c))}catch(u){o(u)}}function d(c){var u;c.done?s(c.value):(u=c.value,u instanceof t?u:new t((function(f){f(u)}))).then(a,l)}d((n=n.apply(r,e||[])).next())}))}const wt={decode:function(r,e){return Re(this,void 0,void 0,(function*(){const t=new AudioContext({sampleRate:e});try{return yield t.decodeAudioData(r)}finally{t.close()}}))},createBuffer:function(r,e){if(!r||r.length===0)throw new Error("channelData must be a non-empty array");if(e<=0)throw new Error("duration must be greater than 0");if(typeof r[0]=="number"&&(r=[r]),!r[0]||r[0].length===0)throw new Error("channelData must contain non-empty channel arrays");(function(n){const s=n[0];if(s.some((o=>o>1||o<-1))){const o=s.length;let a=0;for(let l=0;l<o;l++){const d=Math.abs(s[l]);d>a&&(a=d)}for(const l of n)for(let d=0;d<o;d++)l[d]/=a}})(r);const t=r.map((n=>n instanceof Float32Array?n:Float32Array.from(n)));return{duration:e,length:t[0].length,sampleRate:t[0].length/e,numberOfChannels:t.length,getChannelData:n=>{const s=t[n];if(!s)throw new Error(`Channel ${n} not found`);return s},copyFromChannel:AudioBuffer.prototype.copyFromChannel,copyToChannel:AudioBuffer.prototype.copyToChannel}}};function sn(r,e){const t=e.xmlns?document.createElementNS(e.xmlns,r):document.createElement(r);for(const[n,s]of Object.entries(e))if(n==="children"&&s)for(const[o,a]of Object.entries(s))a instanceof Node?t.appendChild(a):typeof a=="string"?t.appendChild(document.createTextNode(a)):t.appendChild(sn(o,a));else n==="style"?Object.assign(t.style,s):n==="textContent"?t.textContent=s:t.setAttribute(n,s.toString());return t}function Rt(r,e,t){const n=sn(r,e||{});return t?.appendChild(n),n}var zn=Object.freeze({__proto__:null,createElement:Rt,default:Rt});const Fn={fetchBlob:function(r,e,t){return Re(this,void 0,void 0,(function*(){const n=yield fetch(r,t);if(n.status>=400)throw new Error(`Failed to fetch ${r}: ${n.status} (${n.statusText})`);return(function(s,o){Re(this,void 0,void 0,(function*(){if(!s.body||!s.headers)return;const a=s.body.getReader(),l=Number(s.headers.get("Content-Length"))||0;let d=0;const c=u=>{d+=u?.length||0;const f=Math.round(d/l*100);o(f)};try{for(;;){const u=yield a.read();if(u.done)break;c(u.value)}}catch(u){console.warn("Progress tracking error:",u)}}))})(n.clone(),e),n.blob()}))}};function fe(r){let e=r;const t=new Set;return{get value(){return e},set(n){Object.is(e,n)||(e=n,t.forEach((s=>s(e))))},update(n){this.set(n(e))},subscribe:n=>(t.add(n),()=>t.delete(n))}}function tt(r,e){const t=fe(r());return e.forEach((n=>n.subscribe((()=>{const s=r();Object.is(t.value,s)||t.set(s)})))),{get value(){return t.value},subscribe:n=>t.subscribe(n)}}function qe(r,e){let t;const n=()=>{t&&(t(),t=void 0),t=r()},s=e.map((o=>o.subscribe(n)));return n(),()=>{t&&(t(),t=void 0),s.forEach((o=>o()))}}class $n extends gt{get isPlayingSignal(){return this._isPlaying}get currentTimeSignal(){return this._currentTime}get durationSignal(){return this._duration}get volumeSignal(){return this._volume}get mutedSignal(){return this._muted}get playbackRateSignal(){return this._playbackRate}get seekingSignal(){return this._seeking}constructor(e){super(),this.isExternalMedia=!1,this.reactiveMediaEventCleanups=[],e.media?(this.media=e.media,this.isExternalMedia=!0):this.media=document.createElement("audio"),this._isPlaying=fe(!1),this._currentTime=fe(0),this._duration=fe(0),this._volume=fe(this.media.volume),this._muted=fe(this.media.muted),this._playbackRate=fe(this.media.playbackRate||1),this._seeking=fe(!1),this.setupReactiveMediaEvents(),e.mediaControls&&(this.media.controls=!0),e.autoplay&&(this.media.autoplay=!0),e.playbackRate!=null&&this.onMediaEvent("canplay",(()=>{e.playbackRate!=null&&(this.media.playbackRate=e.playbackRate)}),{once:!0})}setupReactiveMediaEvents(){this.reactiveMediaEventCleanups.push(this.onMediaEvent("play",(()=>{this._isPlaying.set(!0)}))),this.reactiveMediaEventCleanups.push(this.onMediaEvent("pause",(()=>{this._isPlaying.set(!1)}))),this.reactiveMediaEventCleanups.push(this.onMediaEvent("ended",(()=>{this._isPlaying.set(!1)}))),this.reactiveMediaEventCleanups.push(this.onMediaEvent("timeupdate",(()=>{this._currentTime.set(this.media.currentTime)}))),this.reactiveMediaEventCleanups.push(this.onMediaEvent("durationchange",(()=>{this._duration.set(this.media.duration||0)}))),this.reactiveMediaEventCleanups.push(this.onMediaEvent("loadedmetadata",(()=>{this._duration.set(this.media.duration||0)}))),this.reactiveMediaEventCleanups.push(this.onMediaEvent("seeking",(()=>{this._seeking.set(!0)}))),this.reactiveMediaEventCleanups.push(this.onMediaEvent("seeked",(()=>{this._seeking.set(!1)}))),this.reactiveMediaEventCleanups.push(this.onMediaEvent("volumechange",(()=>{this._volume.set(this.media.volume),this._muted.set(this.media.muted)}))),this.reactiveMediaEventCleanups.push(this.onMediaEvent("ratechange",(()=>{this._playbackRate.set(this.media.playbackRate)})))}onMediaEvent(e,t,n){return this.media.addEventListener(e,t,n),()=>this.media.removeEventListener(e,t,n)}getSrc(){return this.media.currentSrc||this.media.src||""}revokeSrc(){const e=this.getSrc();e.startsWith("blob:")&&URL.revokeObjectURL(e)}canPlayType(e){return this.media.canPlayType(e)!==""}setSrc(e,t){const n=this.getSrc();if(e&&n===e)return;this.revokeSrc();const s=t instanceof Blob&&(this.canPlayType(t.type)||!e)?URL.createObjectURL(t):e;if(n&&this.media.removeAttribute("src"),s||e)try{this.media.src=s}catch{this.media.src=e}}destroy(){this.reactiveMediaEventCleanups.forEach((e=>e())),this.reactiveMediaEventCleanups=[],this.isExternalMedia||(this.media.pause(),this.revokeSrc(),this.media.removeAttribute("src"),this.media.load(),this.media.remove())}setMediaElement(e){this.reactiveMediaEventCleanups.forEach((t=>t())),this.reactiveMediaEventCleanups=[],this.media=e,this.setupReactiveMediaEvents()}play(){return Re(this,void 0,void 0,(function*(){try{return yield this.media.play()}catch(e){if(e instanceof DOMException&&e.name==="AbortError")return;throw e}}))}pause(){this.media.pause()}isPlaying(){return!this.media.paused&&!this.media.ended}setTime(e){this.media.currentTime=Math.max(0,Math.min(e,this.getDuration()))}getDuration(){return this.media.duration}getCurrentTime(){return this.media.currentTime}getVolume(){return this.media.volume}setVolume(e){this.media.volume=e}getMuted(){return this.media.muted}setMuted(e){this.media.muted=e}getPlaybackRate(){return this.media.playbackRate}isSeeking(){return this.media.seeking}setPlaybackRate(e,t){t!=null&&(this.media.preservesPitch=t),this.media.playbackRate=e}getMediaElement(){return this.media}setSinkId(e){return this.media.setSinkId(e)}}function _n({maxTop:r,maxBottom:e,halfHeight:t,vScale:n,barMinHeight:s=0,barAlign:o}){let a=Math.round(r*t*n),l=a+Math.round(e*t*n)||1;return l<s&&(l=s,o||(a=l/2)),{topHeight:a,totalHeight:l}}function Bn({barAlign:r,halfHeight:e,topHeight:t,totalHeight:n,canvasHeight:s}){return r==="top"?0:r==="bottom"?s-n:e-t}function $t(r,e,t){const n=e-r.left,s=t-r.top;return[n/r.width,s/r.height]}function rn(r){return!!(r.barWidth||r.barGap||r.barAlign)}function _t(r,e){if(!rn(e))return r;const t=e.barWidth||.5,n=t+(e.barGap||t/2);return n===0?r:Math.floor(r/n)*n}function Bt({scrollLeft:r,totalWidth:e,numCanvases:t}){if(e===0)return[0];const n=r/e,s=Math.floor(n*t);return[s-1,s,s+1]}function an(r){const e=r._cleanup;typeof e=="function"&&e()}function Hn(r){const e=fe({scrollLeft:r.scrollLeft,scrollWidth:r.scrollWidth,clientWidth:r.clientWidth}),t=tt((()=>(function(o){const{scrollLeft:a,scrollWidth:l,clientWidth:d}=o;if(l===0)return{startX:0,endX:1};const c=a/l,u=(a+d)/l;return{startX:Math.max(0,Math.min(1,c)),endX:Math.max(0,Math.min(1,u))}})(e.value)),[e]),n=tt((()=>(function(o){return{left:o.scrollLeft,right:o.scrollLeft+o.clientWidth}})(e.value)),[e]),s=()=>{e.set({scrollLeft:r.scrollLeft,scrollWidth:r.scrollWidth,clientWidth:r.clientWidth})};return r.addEventListener("scroll",s,{passive:!0}),{scrollData:e,percentages:t,bounds:n,cleanup:()=>{r.removeEventListener("scroll",s),an(e)}}}class Un extends gt{constructor(e,t){super(),this.timeouts=[],this.isScrollable=!1,this.audioData=null,this.resizeObserver=null,this.lastContainerWidth=0,this.isDragging=!1,this.subscriptions=[],this.unsubscribeOnScroll=[],this.dragStream=null,this.scrollStream=null,this.subscriptions=[],this.options=e;const n=this.parentFromOptionsContainer(e.container);this.parent=n;const[s,o]=this.initHtml();n.appendChild(s),this.container=s,this.scrollContainer=o.querySelector(".scroll"),this.wrapper=o.querySelector(".wrapper"),this.canvasWrapper=o.querySelector(".canvases"),this.progressWrapper=o.querySelector(".progress"),this.cursor=o.querySelector(".cursor"),t&&o.appendChild(t),this.initEvents()}parentFromOptionsContainer(e){let t;if(typeof e=="string"?t=document.querySelector(e):e instanceof HTMLElement&&(t=e),!t)throw new Error("Container not found");return t}initEvents(){this.wrapper.addEventListener("click",(t=>{const n=this.wrapper.getBoundingClientRect(),[s,o]=$t(n,t.clientX,t.clientY);this.emit("click",s,o)})),this.wrapper.addEventListener("dblclick",(t=>{const n=this.wrapper.getBoundingClientRect(),[s,o]=$t(n,t.clientX,t.clientY);this.emit("dblclick",s,o)})),this.options.dragToSeek!==!0&&typeof this.options.dragToSeek!="object"||this.initDrag(),this.scrollStream=Hn(this.scrollContainer);const e=qe((()=>{const{startX:t,endX:n}=this.scrollStream.percentages.value,{left:s,right:o}=this.scrollStream.bounds.value;this.emit("scroll",t,n,s,o)}),[this.scrollStream.percentages,this.scrollStream.bounds]);if(this.subscriptions.push(e),typeof ResizeObserver=="function"){const t=this.createDelay(100);this.resizeObserver=new ResizeObserver((()=>{t().then((()=>this.onContainerResize())).catch((()=>{}))})),this.resizeObserver.observe(this.scrollContainer)}}onContainerResize(){const e=this.parent.clientWidth;e===this.lastContainerWidth&&this.options.height!=="auto"||(this.lastContainerWidth=e,this.reRender(),this.emit("resize"))}initDrag(){if(this.dragStream)return;this.dragStream=(function(t,n={}){const{threshold:s=3,mouseButton:o=0,touchDelay:a=100}=n,l=fe(null),d=new Map,c=matchMedia("(pointer: coarse)").matches;let u=()=>{};const f=m=>{if(m.button!==o||(d.set(m.pointerId,m),d.size>1))return;let p=m.clientX,h=m.clientY,b=!1;const v=Date.now(),C=t.getBoundingClientRect(),{left:k,top:D}=C,j=S=>{if(S.defaultPrevented||d.size>1||c&&Date.now()-v<a)return;const P=S.clientX,H=S.clientY,I=P-p,_=H-h;(b||Math.abs(I)>s||Math.abs(_)>s)&&(S.preventDefault(),S.stopPropagation(),b||(l.set({type:"start",x:p-k,y:h-D}),b=!0),l.set({type:"move",x:P-k,y:H-D,deltaX:I,deltaY:_}),p=P,h=H)},R=S=>{if(d.delete(S.pointerId),b){const P=S.clientX,H=S.clientY;l.set({type:"end",x:P-k,y:H-D})}u()},N=S=>{d.delete(S.pointerId),S.relatedTarget&&S.relatedTarget!==document.documentElement||R(S)},M=S=>{b&&(S.stopPropagation(),S.preventDefault())},O=S=>{S.defaultPrevented||d.size>1||b&&S.preventDefault()};document.addEventListener("pointermove",j),document.addEventListener("pointerup",R),document.addEventListener("pointerout",N),document.addEventListener("pointercancel",N),document.addEventListener("touchmove",O,{passive:!1}),document.addEventListener("click",M,{capture:!0}),u=()=>{document.removeEventListener("pointermove",j),document.removeEventListener("pointerup",R),document.removeEventListener("pointerout",N),document.removeEventListener("pointercancel",N),document.removeEventListener("touchmove",O),setTimeout((()=>{document.removeEventListener("click",M,{capture:!0})}),10)}};return t.addEventListener("pointerdown",f),{signal:l,cleanup:()=>{u(),t.removeEventListener("pointerdown",f),d.clear(),an(l)}}})(this.wrapper);const e=qe((()=>{const t=this.dragStream.signal.value;if(!t)return;const n=this.wrapper.getBoundingClientRect().width,s=(o=t.x/n)<0?0:o>1?1:o;var o;t.type==="start"?(this.isDragging=!0,this.emit("dragstart",s)):t.type==="move"?this.emit("drag",s):t.type==="end"&&(this.isDragging=!1,this.emit("dragend",s))}),[this.dragStream.signal]);this.subscriptions.push(e)}initHtml(){const e=document.createElement("div"),t=e.attachShadow({mode:"open"}),n=this.options.cspNonce&&typeof this.options.cspNonce=="string"?this.options.cspNonce.replace(/"/g,""):"";return t.innerHTML=`
      <style${n?` nonce="${n}"`:""}>
        :host {
          user-select: none;
          min-width: 1px;
        }
        :host audio {
          display: block;
          width: 100%;
        }
        :host .scroll {
          overflow-x: auto;
          overflow-y: hidden;
          width: 100%;
          position: relative;
        }
        :host .noScrollbar {
          scrollbar-color: transparent;
          scrollbar-width: none;
        }
        :host .noScrollbar::-webkit-scrollbar {
          display: none;
          -webkit-appearance: none;
        }
        :host .wrapper {
          position: relative;
          overflow: visible;
          z-index: 2;
        }
        :host .canvases {
          min-height: ${this.getHeight(this.options.height,this.options.splitChannels)}px;
          pointer-events: none;
        }
        :host .canvases > div {
          position: relative;
        }
        :host canvas {
          display: block;
          position: absolute;
          top: 0;
          image-rendering: pixelated;
        }
        :host .progress {
          pointer-events: none;
          position: absolute;
          z-index: 2;
          top: 0;
          left: 0;
          width: 0;
          height: 100%;
          overflow: hidden;
        }
        :host .progress > div {
          position: relative;
        }
        :host .cursor {
          pointer-events: none;
          position: absolute;
          z-index: 5;
          top: 0;
          left: 0;
          height: 100%;
          border-radius: 2px;
        }
      </style>

      <div class="scroll" part="scroll">
        <div class="wrapper" part="wrapper">
          <div class="canvases" part="canvases"></div>
          <div class="progress" part="progress"></div>
          <div class="cursor" part="cursor"></div>
        </div>
      </div>
    `,[e,t]}setOptions(e){if(this.options.container!==e.container){const t=this.parentFromOptionsContainer(e.container);t.appendChild(this.container),this.parent=t}e.dragToSeek!==!0&&typeof this.options.dragToSeek!="object"||this.initDrag(),this.options=e,this.reRender()}getWrapper(){return this.wrapper}getWidth(){return this.scrollContainer.clientWidth}getScroll(){return this.scrollContainer.scrollLeft}setScroll(e){this.scrollContainer.scrollLeft=e}setScrollPercentage(e){const{scrollWidth:t}=this.scrollContainer,n=t*e;this.setScroll(n)}destroy(){var e;this.subscriptions.forEach((t=>t())),this.container.remove(),this.resizeObserver&&(this.resizeObserver.disconnect(),this.resizeObserver=null),(e=this.unsubscribeOnScroll)===null||e===void 0||e.forEach((t=>t())),this.unsubscribeOnScroll=[],this.dragStream&&(this.dragStream.cleanup(),this.dragStream=null),this.scrollStream&&(this.scrollStream.cleanup(),this.scrollStream=null)}createDelay(e=10){let t,n;const s=()=>{t&&(clearTimeout(t),t=void 0),n&&(n(),n=void 0)};return this.timeouts.push(s),()=>new Promise(((o,a)=>{s(),n=a,t=setTimeout((()=>{t=void 0,n=void 0,o()}),e)}))}getHeight(e,t){var n;const s=((n=this.audioData)===null||n===void 0?void 0:n.numberOfChannels)||1;return(function({optionsHeight:o,optionsSplitChannels:a,parentHeight:l,numberOfChannels:d,defaultHeight:c=128}){if(o==null)return c;const u=Number(o);if(!isNaN(u))return u;if(o==="auto"){const f=l||c;return a?.every((m=>!m.overlay))?f/d:f}return c})({optionsHeight:e,optionsSplitChannels:t,parentHeight:this.parent.clientHeight,numberOfChannels:s,defaultHeight:128})}convertColorValues(e,t){return(function(n,s,o){if(!Array.isArray(n))return n||"";if(n.length===0)return"#999";if(n.length<2)return n[0]||"";const a=document.createElement("canvas"),l=a.getContext("2d"),d=o??a.height*s,c=l.createLinearGradient(0,0,0,d||s),u=1/(n.length-1);return n.forEach(((f,m)=>{c.addColorStop(m*u,f)})),c})(e,this.getPixelRatio(),t?.canvas.height)}getPixelRatio(){return e=window.devicePixelRatio,Math.max(1,e||1);var e}renderBarWaveform(e,t,n,s){const{width:o,height:a}=n.canvas,{halfHeight:l,barWidth:d,barRadius:c,barIndexScale:u,barSpacing:f,barMinHeight:m}=(function({width:h,height:b,length:v,options:C,pixelRatio:k}){const D=b/2,j=C.barWidth?C.barWidth*k:1,R=C.barGap?C.barGap*k:C.barWidth?j/2:0,N=j+R||1;return{halfHeight:D,barWidth:j,barGap:R,barRadius:C.barRadius||0,barMinHeight:C.barMinHeight?C.barMinHeight*k:0,barIndexScale:v>0?h/N/v:0,barSpacing:N}})({width:o,height:a,length:(e[0]||[]).length,options:t,pixelRatio:this.getPixelRatio()}),p=(function({channelData:h,barIndexScale:b,barSpacing:v,barWidth:C,halfHeight:k,vScale:D,canvasHeight:j,barAlign:R,barMinHeight:N}){const M=h[0]||[],O=h[1]||M,S=M.length,P=[];let H=0,I=0,_=0;for(let E=0;E<=S;E++){const z=Math.round(E*b);if(z>H){const{topHeight:ce,totalHeight:de}=_n({maxTop:I,maxBottom:_,halfHeight:k,vScale:D,barMinHeight:N,barAlign:R}),ge=Bn({barAlign:R,halfHeight:k,topHeight:ce,totalHeight:de,canvasHeight:j});P.push({x:H*v,y:ge,width:C,height:de}),H=z,I=0,_=0}const ie=Math.abs(M[E]||0),K=Math.abs(O[E]||0);ie>I&&(I=ie),K>_&&(_=K)}return P})({channelData:e,barIndexScale:u,barSpacing:f,barWidth:d,halfHeight:l,vScale:s,canvasHeight:a,barAlign:t.barAlign,barMinHeight:m});n.beginPath();for(const h of p)c&&"roundRect"in n?n.roundRect(h.x,h.y,h.width,h.height,c):n.rect(h.x,h.y,h.width,h.height);n.fill(),n.closePath()}renderLineWaveform(e,t,n,s){const{width:o,height:a}=n.canvas,l=(function({channelData:d,width:c,height:u,vScale:f}){const m=u/2,p=d[0]||[];return[p,d[1]||p].map(((h,b)=>{const v=h.length,C=v?c/v:0,k=m,D=b===0?-1:1,j=[{x:0,y:k}];let R=0,N=0;for(let M=0;M<=v;M++){const O=Math.round(M*C);if(O>R){const P=k+(Math.round(N*m*f)||1)*D;j.push({x:R,y:P}),R=O,N=0}const S=Math.abs(h[M]||0);S>N&&(N=S)}return j.push({x:R,y:k}),j}))})({channelData:e,width:o,height:a,vScale:s});n.beginPath();for(const d of l)if(d.length){n.moveTo(d[0].x,d[0].y);for(let c=1;c<d.length;c++){const u=d[c];n.lineTo(u.x,u.y)}}n.fill(),n.closePath()}renderWaveform(e,t,n){if(n.fillStyle=this.convertColorValues(t.waveColor,n),t.renderFunction)return void t.renderFunction(e,n);const s=(function({channelData:o,barHeight:a,normalize:l,maxPeak:d}){var c;const u=a||1;if(!l)return u;const f=o[0];if(!f||f.length===0)return u;let m=d??0;if(!d)for(let p=0;p<f.length;p++){const h=(c=f[p])!==null&&c!==void 0?c:0,b=Math.abs(h);b>m&&(m=b)}return m?u/m:u})({channelData:e,barHeight:t.barHeight,normalize:t.normalize,maxPeak:t.maxPeak});rn(t)?this.renderBarWaveform(e,t,n,s):this.renderLineWaveform(e,t,n,s)}renderSingleCanvas(e,t,n,s,o,a,l){const d=this.getPixelRatio(),c=document.createElement("canvas");c.width=Math.round(n*d),c.height=Math.round(s*d),c.style.width=`${n}px`,c.style.height=`${s}px`,c.style.left=`${Math.round(o)}px`,a.appendChild(c);const u=c.getContext("2d");if(t.renderFunction?(u.fillStyle=this.convertColorValues(t.waveColor,u),t.renderFunction(e,u)):this.renderWaveform(e,t,u),c.width>0&&c.height>0){const f=c.cloneNode(),m=f.getContext("2d");m.drawImage(c,0,0),m.globalCompositeOperation="source-in",m.fillStyle=this.convertColorValues(t.progressColor,m),m.fillRect(0,0,c.width,c.height),l.appendChild(f)}}renderMultiCanvas(e,t,n,s,o,a){const l=this.getPixelRatio(),{clientWidth:d}=this.scrollContainer,c=n/l,u=(function({clientWidth:h,totalWidth:b,options:v}){return _t(Math.min(8e3,h,b),v)})({clientWidth:d,totalWidth:c,options:t});let f={};if(u===0)return;const m=h=>{if(h<0||h>=p||f[h])return;f[h]=!0;const b=h*u;let v=Math.min(c-b,u);if(v=_t(v,t),v<=0)return;const C=(function({channelData:k,offset:D,clampedWidth:j,totalWidth:R}){return k.map((N=>{const M=Math.floor(D/R*N.length),O=Math.floor((D+j)/R*N.length);return N.slice(M,O)}))})({channelData:e,offset:b,clampedWidth:v,totalWidth:c});this.renderSingleCanvas(C,t,v,s,b,o,a)},p=Math.ceil(c/u);if(!this.isScrollable){for(let h=0;h<p;h++)m(h);return}if(Bt({scrollLeft:this.scrollContainer.scrollLeft,totalWidth:c,numCanvases:p}).forEach((h=>m(h))),p>1){const h=this.on("scroll",(()=>{const{scrollLeft:b}=this.scrollContainer;Object.keys(f).length>10&&(o.innerHTML="",a.innerHTML="",f={}),Bt({scrollLeft:b,totalWidth:c,numCanvases:p}).forEach((v=>m(v)))}));this.unsubscribeOnScroll.push(h)}}renderChannel(e,t,n,s){var{overlay:o}=t,a=(function(u,f){var m={};for(var p in u)Object.prototype.hasOwnProperty.call(u,p)&&f.indexOf(p)<0&&(m[p]=u[p]);if(u!=null&&typeof Object.getOwnPropertySymbols=="function"){var h=0;for(p=Object.getOwnPropertySymbols(u);h<p.length;h++)f.indexOf(p[h])<0&&Object.prototype.propertyIsEnumerable.call(u,p[h])&&(m[p[h]]=u[p[h]])}return m})(t,["overlay"]);const l=document.createElement("div"),d=this.getHeight(a.height,a.splitChannels);l.style.height=`${d}px`,o&&s>0&&(l.style.marginTop=`-${d}px`),this.canvasWrapper.style.minHeight=`${d}px`,this.canvasWrapper.appendChild(l);const c=l.cloneNode();this.progressWrapper.appendChild(c),this.renderMultiCanvas(e,a,n,d,l,c)}render(e){return Re(this,void 0,void 0,(function*(){var t;this.timeouts.forEach((c=>c())),this.timeouts=[],this.canvasWrapper.innerHTML="",this.progressWrapper.innerHTML="",this.options.width!=null&&(this.scrollContainer.style.width=typeof this.options.width=="number"?`${this.options.width}px`:this.options.width);const n=this.getPixelRatio(),s=this.scrollContainer.clientWidth,{scrollWidth:o,isScrollable:a,useParentWidth:l,width:d}=(function({duration:c,minPxPerSec:u=0,parentWidth:f,fillParent:m,pixelRatio:p}){const h=Math.ceil(c*u),b=h>f,v=!!(m&&!b);return{scrollWidth:h,isScrollable:b,useParentWidth:v,width:(v?f:h)*p}})({duration:e.duration,minPxPerSec:this.options.minPxPerSec||0,parentWidth:s,fillParent:this.options.fillParent,pixelRatio:n});if(this.isScrollable=a,this.wrapper.style.width=l?"100%":`${o}px`,this.scrollContainer.style.overflowX=this.isScrollable?"auto":"hidden",this.scrollContainer.classList.toggle("noScrollbar",!!this.options.hideScrollbar),this.cursor.style.backgroundColor=`${this.options.cursorColor||this.options.progressColor}`,this.cursor.style.width=`${this.options.cursorWidth}px`,this.audioData=e,this.emit("render"),this.options.splitChannels)for(let c=0;c<e.numberOfChannels;c++){const u=Object.assign(Object.assign({},this.options),(t=this.options.splitChannels)===null||t===void 0?void 0:t[c]);this.renderChannel([e.getChannelData(c)],u,d,c)}else{const c=[e.getChannelData(0)];e.numberOfChannels>1&&c.push(e.getChannelData(1)),this.renderChannel(c,this.options,d,0)}Promise.resolve().then((()=>this.emit("rendered")))}))}reRender(){if(this.unsubscribeOnScroll.forEach((n=>n())),this.unsubscribeOnScroll=[],!this.audioData)return;const{scrollWidth:e}=this.scrollContainer,{right:t}=this.progressWrapper.getBoundingClientRect();if(this.render(this.audioData),this.isScrollable&&e!==this.scrollContainer.scrollWidth){const{right:n}=this.progressWrapper.getBoundingClientRect(),s=(function(o){const a=2*o;return(a<0?Math.floor(a):Math.ceil(a))/2})(n-t);this.scrollContainer.scrollLeft+=s}}zoom(e){this.options.minPxPerSec=e,this.reRender()}scrollIntoView(e,t=!1){const{scrollLeft:n,scrollWidth:s,clientWidth:o}=this.scrollContainer,a=e*s,l=n,d=n+o,c=o/2;if(this.isDragging)a+30>d?this.scrollContainer.scrollLeft+=30:a-30<l&&(this.scrollContainer.scrollLeft-=30);else{(a<l||a>d)&&(this.scrollContainer.scrollLeft=a-(this.options.autoCenter?c:0));const u=a-n-c;t&&this.options.autoCenter&&u>0&&(this.scrollContainer.scrollLeft+=u)}}renderProgress(e,t){if(isNaN(e))return;const n=100*e;this.canvasWrapper.style.clipPath=`polygon(${n}% 0%, 100% 0%, 100% 100%, ${n}% 100%)`,this.progressWrapper.style.width=`${n}%`,this.cursor.style.left=`${n}%`,this.cursor.style.transform=this.options.cursorWidth?`translateX(-${e*this.options.cursorWidth}px)`:"",this.isScrollable&&this.options.autoScroll&&this.audioData&&this.audioData.duration>0&&this.scrollIntoView(e,t)}exportImage(e,t,n){return Re(this,void 0,void 0,(function*(){const s=this.canvasWrapper.querySelectorAll("canvas");if(!s.length)throw new Error("No waveform data");if(n==="dataURL"){const o=Array.from(s).map((a=>a.toDataURL(e,t)));return Promise.resolve(o)}return Promise.all(Array.from(s).map((o=>new Promise(((a,l)=>{o.toBlob((d=>{d?a(d):l(new Error("Could not export image"))}),e,t)})))))}))}}class qn extends gt{constructor(){super(...arguments),this.animationFrameId=null,this.isRunning=!1}start(){if(this.isRunning)return;this.isRunning=!0;const e=()=>{this.isRunning&&(this.emit("tick"),this.animationFrameId=requestAnimationFrame(e))};e()}stop(){this.isRunning=!1,this.animationFrameId!==null&&(cancelAnimationFrame(this.animationFrameId),this.animationFrameId=null)}destroy(){this.stop()}}class Pt extends gt{constructor(e=new AudioContext){super(),this.bufferNode=null,this.playStartTime=0,this.playedDuration=0,this._muted=!1,this._playbackRate=1,this._duration=void 0,this.buffer=null,this.currentSrc="",this.paused=!0,this.crossOrigin=null,this.seeking=!1,this.autoplay=!1,this.addEventListener=this.on,this.removeEventListener=this.un,this.audioContext=e,this.gainNode=this.audioContext.createGain(),this.gainNode.connect(this.audioContext.destination)}load(){return Re(this,void 0,void 0,(function*(){}))}get src(){return this.currentSrc}set src(e){if(this.currentSrc=e,this._duration=void 0,!e)return this.buffer=null,void this.emit("emptied");fetch(e).then((t=>{if(t.status>=400)throw new Error(`Failed to fetch ${e}: ${t.status} (${t.statusText})`);return t.arrayBuffer()})).then((t=>this.currentSrc!==e?null:this.audioContext.decodeAudioData(t))).then((t=>{this.currentSrc===e&&(this.buffer=t,this.emit("loadedmetadata"),this.emit("canplay"),this.autoplay&&this.play())})).catch((t=>{console.error("WebAudioPlayer load error:",t)}))}_play(){if(!this.paused)return;this.paused=!1,this.bufferNode&&(this.bufferNode.onended=null,this.bufferNode.disconnect()),this.bufferNode=this.audioContext.createBufferSource(),this.buffer&&(this.bufferNode.buffer=this.buffer),this.bufferNode.playbackRate.value=this._playbackRate,this.bufferNode.connect(this.gainNode);let e=this.playedDuration*this._playbackRate;(e>=this.duration||e<0)&&(e=0,this.playedDuration=0),this.bufferNode.start(this.audioContext.currentTime,e),this.playStartTime=this.audioContext.currentTime,this.bufferNode.onended=()=>{this.currentTime>=this.duration&&(this.pause(),this.emit("ended"))}}_pause(){var e;this.paused=!0,(e=this.bufferNode)===null||e===void 0||e.stop(),this.playedDuration+=this.audioContext.currentTime-this.playStartTime}play(){return Re(this,void 0,void 0,(function*(){this.paused&&(this._play(),this.emit("play"))}))}pause(){this.paused||(this._pause(),this.emit("pause"))}stopAt(e){const t=e-this.currentTime,n=this.bufferNode;n?.stop(this.audioContext.currentTime+t),n?.addEventListener("ended",(()=>{n===this.bufferNode&&(this.bufferNode=null,this.pause())}),{once:!0})}setSinkId(e){return Re(this,void 0,void 0,(function*(){return this.audioContext.setSinkId(e)}))}get playbackRate(){return this._playbackRate}set playbackRate(e){this._playbackRate=e,this.bufferNode&&(this.bufferNode.playbackRate.value=e)}get currentTime(){return(this.paused?this.playedDuration:this.playedDuration+(this.audioContext.currentTime-this.playStartTime))*this._playbackRate}set currentTime(e){const t=!this.paused;t&&this._pause(),this.playedDuration=e/this._playbackRate,t&&this._play(),this.emit("seeking"),this.emit("timeupdate")}get duration(){var e,t;return(e=this._duration)!==null&&e!==void 0?e:((t=this.buffer)===null||t===void 0?void 0:t.duration)||0}set duration(e){this._duration=e}get volume(){return this.gainNode.gain.value}set volume(e){this.gainNode.gain.value=e,this.emit("volumechange")}get muted(){return this._muted}set muted(e){this._muted!==e&&(this._muted=e,this._muted?this.gainNode.disconnect():this.gainNode.connect(this.audioContext.destination))}canPlayType(e){return/^(audio|video)\//.test(e)}getGainNode(){return this.gainNode}getChannelData(){const e=[];if(!this.buffer)return e;const t=this.buffer.numberOfChannels;for(let n=0;n<t;n++)e.push(this.buffer.getChannelData(n));return e}removeAttribute(e){switch(e){case"src":this.src="";break;case"playbackRate":this.playbackRate=0;break;case"currentTime":this.currentTime=0;break;case"duration":this.duration=0;break;case"volume":this.volume=0;break;case"muted":this.muted=!1}}}const Xn={waveColor:"#999",progressColor:"#555",cursorWidth:1,minPxPerSec:0,fillParent:!0,interact:!0,dragToSeek:!1,autoScroll:!0,autoCenter:!0,sampleRate:8e3};class pt extends $n{static create(e){return new pt(e)}getState(){return this.wavesurferState}getRenderer(){return this.renderer}constructor(e){const t=e.media||(e.backend==="WebAudio"?new Pt:void 0);super({media:t,mediaControls:e.mediaControls,autoplay:e.autoplay,playbackRate:e.audioRate}),this.plugins=[],this.decodedData=null,this.stopAtPosition=null,this.subscriptions=[],this.mediaSubscriptions=[],this.abortController=null,this.reactiveCleanups=[],this.options=Object.assign({},Xn,e);const{state:n,actions:s}=(function(l){var d,c,u,f,m,p;const h=(d=l?.currentTime)!==null&&d!==void 0?d:fe(0),b=(c=l?.duration)!==null&&c!==void 0?c:fe(0),v=(u=l?.isPlaying)!==null&&u!==void 0?u:fe(!1),C=(f=l?.isSeeking)!==null&&f!==void 0?f:fe(!1),k=(m=l?.volume)!==null&&m!==void 0?m:fe(1),D=(p=l?.playbackRate)!==null&&p!==void 0?p:fe(1),j=fe(null),R=fe(null),N=fe(""),M=fe(0),O=fe(0),S=tt((()=>!v.value),[v]),P=tt((()=>j.value!==null),[j]),H=tt((()=>P.value&&b.value>0),[P,b]),I=tt((()=>h.value),[h]),_=tt((()=>b.value>0?h.value/b.value:0),[h,b]);return{state:{currentTime:h,duration:b,isPlaying:v,isPaused:S,isSeeking:C,volume:k,playbackRate:D,audioBuffer:j,peaks:R,url:N,zoom:M,scrollPosition:O,canPlay:P,isReady:H,progress:I,progressPercent:_},actions:{setCurrentTime:E=>{const z=Math.max(0,Math.min(b.value||1/0,E));h.set(z)},setDuration:E=>{b.set(Math.max(0,E))},setPlaying:E=>{v.set(E)},setSeeking:E=>{C.set(E)},setVolume:E=>{const z=Math.max(0,Math.min(1,E));k.set(z)},setPlaybackRate:E=>{const z=Math.max(.1,Math.min(16,E));D.set(z)},setAudioBuffer:E=>{j.set(E),E&&b.set(E.duration)},setPeaks:E=>{R.set(E)},setUrl:E=>{N.set(E)},setZoom:E=>{M.set(Math.max(0,E))},setScrollPosition:E=>{O.set(Math.max(0,E))}}}})({isPlaying:this.isPlayingSignal,currentTime:this.currentTimeSignal,duration:this.durationSignal,volume:this.volumeSignal,playbackRate:this.playbackRateSignal,isSeeking:this.seekingSignal});this.wavesurferState=n,this.wavesurferActions=s,this.timer=new qn;const o=t?void 0:this.getMediaElement();this.renderer=new Un(this.options,o),this.initPlayerEvents(),this.initRendererEvents(),this.initTimerEvents(),this.initReactiveState(),this.initPlugins();const a=this.options.url||this.getSrc()||"";Promise.resolve().then((()=>{this.emit("init");const{peaks:l,duration:d}=this.options;(a||l&&d)&&this.load(a,l,d).catch((c=>{this.emit("error",c instanceof Error?c:new Error(String(c)))}))}))}updateProgress(e=this.getCurrentTime()){return this.renderer.renderProgress(e/this.getDuration(),this.isPlaying()),e}initTimerEvents(){this.subscriptions.push(this.timer.on("tick",(()=>{if(!this.isSeeking()){const e=this.updateProgress();this.emit("timeupdate",e),this.emit("audioprocess",e),this.stopAtPosition!=null&&this.isPlaying()&&e>=this.stopAtPosition&&this.pause()}})))}initReactiveState(){this.reactiveCleanups.push((function(e,t){const n=[];n.push(qe((()=>{const a=e.isPlaying.value;t.emit(a?"play":"pause")}),[e.isPlaying])),n.push(qe((()=>{const a=e.currentTime.value;t.emit("timeupdate",a),e.isPlaying.value&&t.emit("audioprocess",a)}),[e.currentTime,e.isPlaying])),n.push(qe((()=>{e.isSeeking.value&&t.emit("seeking",e.currentTime.value)}),[e.isSeeking,e.currentTime]));let s=!1;n.push(qe((()=>{e.isReady.value&&!s&&(s=!0,t.emit("ready",e.duration.value))}),[e.isReady,e.duration]));let o=!1;return n.push(qe((()=>{const a=e.isPlaying.value,l=e.currentTime.value,d=e.duration.value,c=d>0&&l>=d;o&&!a&&c&&t.emit("finish"),o=a&&c}),[e.isPlaying,e.currentTime,e.duration])),n.push(qe((()=>{const a=e.zoom.value;a>0&&t.emit("zoom",a)}),[e.zoom])),()=>{n.forEach((a=>a()))}})(this.wavesurferState,{emit:this.emit.bind(this)}))}initPlayerEvents(){this.isPlaying()&&(this.emit("play"),this.timer.start()),this.mediaSubscriptions.push(this.onMediaEvent("timeupdate",(()=>{const e=this.updateProgress();this.emit("timeupdate",e)})),this.onMediaEvent("play",(()=>{this.emit("play"),this.timer.start()})),this.onMediaEvent("pause",(()=>{this.emit("pause"),this.timer.stop(),this.stopAtPosition=null})),this.onMediaEvent("emptied",(()=>{this.timer.stop(),this.stopAtPosition=null})),this.onMediaEvent("ended",(()=>{this.emit("timeupdate",this.getDuration()),this.emit("finish"),this.stopAtPosition=null})),this.onMediaEvent("seeking",(()=>{this.emit("seeking",this.getCurrentTime())})),this.onMediaEvent("error",(()=>{var e;this.emit("error",(e=this.getMediaElement().error)!==null&&e!==void 0?e:new Error("Media error")),this.stopAtPosition=null})))}initRendererEvents(){this.subscriptions.push(this.renderer.on("click",((e,t)=>{this.options.interact&&(this.seekTo(e),this.emit("interaction",e*this.getDuration()),this.emit("click",e,t))})),this.renderer.on("dblclick",((e,t)=>{this.emit("dblclick",e,t)})),this.renderer.on("scroll",((e,t,n,s)=>{const o=this.getDuration();this.emit("scroll",e*o,t*o,n,s)})),this.renderer.on("render",(()=>{this.emit("redraw")})),this.renderer.on("rendered",(()=>{this.emit("redrawcomplete")})),this.renderer.on("dragstart",(e=>{this.emit("dragstart",e)})),this.renderer.on("dragend",(e=>{this.emit("dragend",e)})),this.renderer.on("resize",(()=>{this.emit("resize")})));{let e;const t=this.renderer.on("drag",(n=>{var s;if(!this.options.interact)return;this.renderer.renderProgress(n),clearTimeout(e);let o=0;const a=this.options.dragToSeek;this.isPlaying()?o=0:a===!0?o=200:a&&typeof a=="object"&&(o=(s=a.debounceTime)!==null&&s!==void 0?s:200),e=setTimeout((()=>{this.seekTo(n)}),o),this.emit("interaction",n*this.getDuration()),this.emit("drag",n)}));this.subscriptions.push((()=>{clearTimeout(e),t()}))}}initPlugins(){var e;!((e=this.options.plugins)===null||e===void 0)&&e.length&&this.options.plugins.forEach((t=>{this.registerPlugin(t)}))}unsubscribePlayerEvents(){this.mediaSubscriptions.forEach((e=>e())),this.mediaSubscriptions=[]}setOptions(e){this.options=Object.assign({},this.options,e),e.duration&&!e.peaks&&(this.decodedData=wt.createBuffer(this.exportPeaks(),e.duration)),e.peaks&&e.duration&&(this.decodedData=wt.createBuffer(e.peaks,e.duration)),this.renderer.setOptions(this.options),e.audioRate&&this.setPlaybackRate(e.audioRate),e.mediaControls!=null&&(this.getMediaElement().controls=e.mediaControls)}registerPlugin(e){if(this.plugins.includes(e))return e;e._init(this),this.plugins.push(e);const t=e.once("destroy",(()=>{this.plugins=this.plugins.filter((n=>n!==e)),this.subscriptions=this.subscriptions.filter((n=>n!==t))}));return this.subscriptions.push(t),e}unregisterPlugin(e){this.plugins=this.plugins.filter((t=>t!==e)),e.destroy()}getWrapper(){return this.renderer.getWrapper()}getWidth(){return this.renderer.getWidth()}getScroll(){return this.renderer.getScroll()}setScroll(e){return this.renderer.setScroll(e)}setScrollTime(e){const t=e/this.getDuration();this.renderer.setScrollPercentage(t)}getActivePlugins(){return this.plugins}loadAudio(e,t,n,s){return Re(this,void 0,void 0,(function*(){var o;if(this.emit("load",e),!this.options.media&&this.isPlaying()&&this.pause(),this.decodedData=null,this.stopAtPosition=null,(o=this.abortController)===null||o===void 0||o.abort(),this.abortController=null,!t&&!n){const l=this.options.fetchParams||{};window.AbortController&&!l.signal&&(this.abortController=new AbortController,l.signal=this.abortController.signal);const d=u=>this.emit("loading",u);t=yield Fn.fetchBlob(e,d,l);const c=this.options.blobMimeType;c&&(t=new Blob([t],{type:c}))}this.setSrc(e,t);const a=yield new Promise((l=>{const d=s||this.getDuration();d?l(d):this.mediaSubscriptions.push(this.onMediaEvent("loadedmetadata",(()=>l(this.getDuration())),{once:!0}))}));if(!e&&!t){const l=this.getMediaElement();l instanceof Pt&&(l.duration=a)}if(n)this.decodedData=wt.createBuffer(n,a||0);else if(t){const l=yield t.arrayBuffer();this.decodedData=yield wt.decode(l,this.options.sampleRate)}this.decodedData&&(this.emit("decode",this.getDuration()),this.renderer.render(this.decodedData)),this.emit("ready",this.getDuration())}))}load(e,t,n){return Re(this,void 0,void 0,(function*(){try{return yield this.loadAudio(e,void 0,t,n)}catch(s){throw this.emit("error",s),s}}))}loadBlob(e,t,n){return Re(this,void 0,void 0,(function*(){try{return yield this.loadAudio("",e,t,n)}catch(s){throw this.emit("error",s),s}}))}zoom(e){if(!this.decodedData)throw new Error("No audio loaded");this.renderer.zoom(e),this.emit("zoom",e)}getDecodedData(){return this.decodedData}exportPeaks({channels:e=2,maxLength:t=8e3,precision:n=1e4}={}){if(!this.decodedData)throw new Error("The audio has not been decoded yet");const s=Math.min(e,this.decodedData.numberOfChannels),o=[];for(let a=0;a<s;a++){const l=this.decodedData.getChannelData(a),d=[],c=l.length/t;for(let u=0;u<t;u++){const f=l.slice(Math.floor(u*c),Math.ceil((u+1)*c));let m=0;for(let p=0;p<f.length;p++){const h=f[p];Math.abs(h)>Math.abs(m)&&(m=h)}d.push(Math.round(m*n)/n)}o.push(d)}return o}getDuration(){let e=super.getDuration()||0;return e!==0&&e!==1/0||!this.decodedData||(e=this.decodedData.duration),e}toggleInteraction(e){this.options.interact=e}setTime(e){this.stopAtPosition=null,super.setTime(e),this.updateProgress(e),this.emit("timeupdate",e)}seekTo(e){const t=this.getDuration()*e;this.setTime(t)}play(e,t){const n=Object.create(null,{play:{get:()=>super.play}});return Re(this,void 0,void 0,(function*(){e!=null&&this.setTime(e);const s=yield n.play.call(this);return t!=null&&(this.media instanceof Pt?this.media.stopAt(t):this.stopAtPosition=t),s}))}playPause(){return Re(this,void 0,void 0,(function*(){return this.isPlaying()?this.pause():this.play()}))}stop(){this.pause(),this.setTime(0)}skip(e){this.setTime(this.getCurrentTime()+e)}empty(){this.load("",[[0]],.001)}setMediaElement(e){this.unsubscribePlayerEvents(),super.setMediaElement(e),this.initPlayerEvents()}exportImage(){return Re(this,arguments,void 0,(function*(e="image/png",t=1,n="dataURL"){return this.renderer.exportImage(e,t,n)}))}destroy(){var e;this.emit("destroy"),(e=this.abortController)===null||e===void 0||e.abort(),this.plugins.forEach((t=>t.destroy())),this.subscriptions.forEach((t=>t())),this.unsubscribePlayerEvents(),this.reactiveCleanups.forEach((t=>t())),this.reactiveCleanups=[],this.timer.destroy(),this.renderer.destroy(),super.destroy()}}pt.BasePlugin=nn,pt.dom=zn;const Vn={height:50,overlayColor:"rgba(100, 100, 100, 0.1)",insertPosition:"afterend"};class Nt extends nn{constructor(e){super(e),this.miniWavesurfer=null,this.container=null,this.isInitializing=!1,this.options=Object.assign({},Vn,e),this.minimapWrapper=this.initMinimapWrapper(),this.overlay=this.initOverlay()}static create(e){return new Nt(e)}onInit(){var e,t;if(!this.wavesurfer)throw Error("WaveSurfer is not initialized");this.options.container?(typeof this.options.container=="string"?this.container=document.querySelector(this.options.container):this.options.container instanceof HTMLElement&&(this.container=this.options.container),(e=this.container)===null||e===void 0||e.appendChild(this.minimapWrapper)):(this.container=this.wavesurfer.getWrapper().parentElement,(t=this.container)===null||t===void 0||t.insertAdjacentElement(this.options.insertPosition,this.minimapWrapper)),this.initWaveSurferEvents(),Promise.resolve().then((()=>{this.initMinimap()}))}initMinimapWrapper(){return Rt("div",{part:"minimap",style:{position:"relative"}})}initOverlay(){return Rt("div",{part:"minimap-overlay",style:{position:"absolute",zIndex:"2",left:"0",top:"0",bottom:"0",transition:"left 100ms ease-out",pointerEvents:"none",backgroundColor:this.options.overlayColor}},this.minimapWrapper)}initMinimap(){if(this.isInitializing)return;if(this.isInitializing=!0,this.miniWavesurfer&&(this.miniWavesurfer.destroy(),this.miniWavesurfer=null),!this.wavesurfer)return void(this.isInitializing=!1);const e=this.wavesurfer.getDecodedData(),t=this.wavesurfer.getMediaElement();if(!e||!t)return void(this.isInitializing=!1);const n=[];for(let s=0;s<e.numberOfChannels;s++)n.push(e.getChannelData(s));this.miniWavesurfer=pt.create(Object.assign(Object.assign({},this.options),{container:this.minimapWrapper,minPxPerSec:0,fillParent:!0,media:t,peaks:n,duration:e.duration})),this.subscriptions.push(this.miniWavesurfer.on("audioprocess",(s=>{this.emit("audioprocess",s)})),this.miniWavesurfer.on("click",((s,o)=>{this.emit("click",s,o)})),this.miniWavesurfer.on("dblclick",((s,o)=>{this.emit("dblclick",s,o)})),this.miniWavesurfer.on("decode",(s=>{this.emit("decode",s)})),this.miniWavesurfer.on("destroy",(()=>{this.emit("destroy")})),this.miniWavesurfer.on("drag",(s=>{this.emit("drag",s)})),this.miniWavesurfer.on("dragend",(s=>{this.emit("dragend",s)})),this.miniWavesurfer.on("dragstart",(s=>{this.emit("dragstart",s)})),this.miniWavesurfer.on("interaction",(()=>{this.emit("interaction")})),this.miniWavesurfer.on("init",(()=>{this.emit("init")})),this.miniWavesurfer.on("ready",(()=>{this.emit("ready")})),this.miniWavesurfer.on("redraw",(()=>{this.emit("redraw")})),this.miniWavesurfer.on("redrawcomplete",(()=>{this.emit("redrawcomplete")})),this.miniWavesurfer.on("seeking",(s=>{this.emit("seeking",s)})),this.miniWavesurfer.on("timeupdate",(s=>{this.emit("timeupdate",s)}))),this.isInitializing=!1}getOverlayWidth(){var e;const t=((e=this.wavesurfer)===null||e===void 0?void 0:e.getWrapper().clientWidth)||1;return Math.round(this.minimapWrapper.clientWidth/t*100)}onRedraw(){const e=this.getOverlayWidth();this.overlay.style.width=`${e}%`}onScroll(e){if(!this.wavesurfer)return;const t=this.wavesurfer.getDuration();this.overlay.style.left=e/t*100+"%"}initWaveSurferEvents(){this.wavesurfer&&this.subscriptions.push(this.wavesurfer.on("decode",(()=>{this.initMinimap()})),this.wavesurfer.on("scroll",(e=>{this.onScroll(e)})),this.wavesurfer.on("redraw",(()=>{this.onRedraw()})))}destroy(){var e;(e=this.miniWavesurfer)===null||e===void 0||e.destroy(),this.minimapWrapper.remove(),this.container=null,super.destroy()}}function mt(r){const e=Math.floor(r/60),t=Math.floor(r%60);return`${e.toString().padStart(2,"0")}:${t.toString().padStart(2,"0")}`}function ut(r){const e=Math.floor(r/60),t=Math.floor(r%60),n=Math.floor(r%1*100);return`${e.toString().padStart(2,"0")}:${t.toString().padStart(2,"0")}.${n.toString().padStart(2,"0")}`}function on(r){return new Date(r).toLocaleString("ro-RO",{day:"2-digit",month:"short",hour:"2-digit",minute:"2-digit"})}function ln(r){return r<1024?`${r} B`:r<1024*1024?`${(r/1024).toFixed(1)} KB`:`${(r/(1024*1024)).toFixed(1)} MB`}const Ht=["#00ff88","#ff3b5c","#00d4ff","#ff9500","#a855f7","#ec4899","#facc15","#64748b"];function cn(r){const e=r.replace(/^www\./,"").replace(/\.(com|org|net|io|co|tv|me)$/,"");return e.charAt(0).toUpperCase()+e.slice(1)}function Gn(r,e){const t=e.map(s=>s.tabTitle);if(!t.includes(r))return r;let n=2;for(;t.includes(`${r} ${n}`);)n++;return`${r} ${n}`}const G={Mic:()=>i.jsxs("svg",{width:"24",height:"24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[i.jsx("path",{d:"M12 2a3 3 0 0 0-3 3v7a3 3 0 0 0 6 0V5a3 3 0 0 0-3-3Z"}),i.jsx("path",{d:"M19 10v2a7 7 0 0 1-14 0v-2"}),i.jsx("line",{x1:"12",x2:"12",y1:"19",y2:"22"})]}),Stop:()=>i.jsx("svg",{width:"24",height:"24",fill:"currentColor",viewBox:"0 0 24 24",children:i.jsx("rect",{x:"6",y:"6",width:"12",height:"12",rx:"2"})}),Play:({size:r=16})=>i.jsx("svg",{width:r,height:r,fill:"currentColor",viewBox:"0 0 24 24",children:i.jsx("path",{d:"M8 5v14l11-7z"})}),Pause:()=>i.jsxs("svg",{width:"16",height:"16",fill:"currentColor",viewBox:"0 0 24 24",children:[i.jsx("rect",{x:"6",y:"4",width:"4",height:"16",rx:"1"}),i.jsx("rect",{x:"14",y:"4",width:"4",height:"16",rx:"1"})]}),Folder:({open:r})=>i.jsx("svg",{width:"16",height:"16",fill:"none",stroke:"currentColor",strokeWidth:"1.5",strokeLinecap:"round",strokeLinejoin:"round",children:r?i.jsx("path",{d:"M2 7.5V4a1 1 0 0 1 1-1h3.5l2 2H13a1 1 0 0 1 1 1v1.5M2 7.5l1.4 5.6a1 1 0 0 0 1 .9h7.2a1 1 0 0 0 1-.9L14 7.5M2 7.5h12"}):i.jsx("path",{d:"M2 5a1 1 0 0 1 1-1h3.5l2 2H13a1 1 0 0 1 1 1v6a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1V5Z"})}),FolderPlus:()=>i.jsxs("svg",{width:"16",height:"16",fill:"none",stroke:"currentColor",strokeWidth:"1.5",strokeLinecap:"round",strokeLinejoin:"round",children:[i.jsx("path",{d:"M2 5a1 1 0 0 1 1-1h3.5l2 2H13a1 1 0 0 1 1 1v6a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1V5Z"}),i.jsx("path",{d:"M8 8v4M6 10h4"})]}),ChevronRight:({size:r=14})=>i.jsx("svg",{width:r,height:r,fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",viewBox:"0 0 14 14",children:i.jsx("path",{d:"m5 3 5 4-5 4"})}),ChevronLeft:()=>i.jsx("svg",{width:"16",height:"16",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:i.jsx("path",{d:"m11 5-5 4 5 4"})}),Music:()=>i.jsxs("svg",{width:"14",height:"14",fill:"none",stroke:"currentColor",strokeWidth:"1.5",strokeLinecap:"round",strokeLinejoin:"round",children:[i.jsx("circle",{cx:"4.5",cy:"11.5",r:"2.5"}),i.jsx("path",{d:"M7 11.5V2l6 2v7.5"}),i.jsx("circle",{cx:"10.5",cy:"11.5",r:"2.5"})]}),Trash:()=>i.jsx("svg",{width:"14",height:"14",fill:"none",stroke:"currentColor",strokeWidth:"1.5",strokeLinecap:"round",strokeLinejoin:"round",children:i.jsx("path",{d:"M3 4h8M5 4V3a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1v1M10 4v7a1 1 0 0 1-1 1H5a1 1 0 0 1-1-1V4"})}),Edit:()=>i.jsx("svg",{width:"14",height:"14",fill:"none",stroke:"currentColor",strokeWidth:"1.5",strokeLinecap:"round",strokeLinejoin:"round",children:i.jsx("path",{d:"M9.5 2.5a1.5 1.5 0 0 1 2 2L5 11l-3 1 1-3 6.5-6.5Z"})}),FolderOpen:()=>i.jsx("svg",{width:"16",height:"16",fill:"none",stroke:"currentColor",strokeWidth:"1.5",strokeLinecap:"round",strokeLinejoin:"round",children:i.jsx("path",{d:"M2 4a1 1 0 0 1 1-1h4l2 2h5a1 1 0 0 1 1 1v7a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1V4Z"})}),SkipBack:()=>i.jsx("svg",{width:"16",height:"16",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:i.jsx("path",{d:"M4 5v6M6 8l6-4v8z"})}),SkipForward:()=>i.jsx("svg",{width:"16",height:"16",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:i.jsx("path",{d:"M12 5v6M10 8l-6-4v8z"})}),Loop:()=>i.jsxs("svg",{width:"16",height:"16",fill:"none",stroke:"currentColor",strokeWidth:"1.5",strokeLinecap:"round",strokeLinejoin:"round",children:[i.jsx("path",{d:"M17 1l4 4-4 4"}),i.jsx("path",{d:"M3 11V9a4 4 0 0 1 4-4h14",transform:"scale(0.67)"}),i.jsx("path",{d:"M7 23l-4-4 4-4"}),i.jsx("path",{d:"M21 13v2a4 4 0 0 1-4 4H3",transform:"scale(0.67)"})]}),Star:({filled:r})=>i.jsx("svg",{width:"14",height:"14",fill:r?"currentColor":"none",stroke:"currentColor",strokeWidth:"1.5",strokeLinecap:"round",strokeLinejoin:"round",children:i.jsx("path",{d:"M7 1l1.8 3.6 4 .6-2.9 2.8.7 4-3.6-1.9-3.6 1.9.7-4-2.9-2.8 4-.6z"})}),Search:()=>i.jsxs("svg",{width:"14",height:"14",fill:"none",stroke:"currentColor",strokeWidth:"1.5",strokeLinecap:"round",strokeLinejoin:"round",children:[i.jsx("circle",{cx:"6",cy:"6",r:"4"}),i.jsx("path",{d:"m13 13-3-3"})]}),Scissors:()=>i.jsxs("svg",{width:"14",height:"14",fill:"none",stroke:"currentColor",strokeWidth:"1.5",strokeLinecap:"round",strokeLinejoin:"round",children:[i.jsx("circle",{cx:"4",cy:"4",r:"2"}),i.jsx("circle",{cx:"4",cy:"10",r:"2"}),i.jsx("path",{d:"M5.5 5.5L12 12M5.5 8.5L12 2"})]}),Volume:()=>i.jsxs("svg",{width:"14",height:"14",fill:"none",stroke:"currentColor",strokeWidth:"1.5",strokeLinecap:"round",strokeLinejoin:"round",children:[i.jsx("path",{d:"M2 5.5v3h2.5l3 3v-9l-3 3H2z"}),i.jsx("path",{d:"M10 4.5a3 3 0 0 1 0 5"})]}),ZoomIn:()=>i.jsxs("svg",{width:"14",height:"14",fill:"none",stroke:"currentColor",strokeWidth:"1.5",strokeLinecap:"round",strokeLinejoin:"round",children:[i.jsx("circle",{cx:"6",cy:"6",r:"4"}),i.jsx("path",{d:"M13 13l-3-3M6 4v4M4 6h4"})]}),ZoomOut:()=>i.jsxs("svg",{width:"14",height:"14",fill:"none",stroke:"currentColor",strokeWidth:"1.5",strokeLinecap:"round",strokeLinejoin:"round",children:[i.jsx("circle",{cx:"6",cy:"6",r:"4"}),i.jsx("path",{d:"M13 13l-3-3M4 6h4"})]}),Copy:()=>i.jsxs("svg",{width:"14",height:"14",fill:"none",stroke:"currentColor",strokeWidth:"1.5",strokeLinecap:"round",strokeLinejoin:"round",children:[i.jsx("rect",{x:"5",y:"5",width:"8",height:"8",rx:"1"}),i.jsx("path",{d:"M3 9V3a1 1 0 0 1 1-1h6"})]}),Bpm:()=>i.jsx("svg",{width:"14",height:"14",fill:"none",stroke:"currentColor",strokeWidth:"1.5",strokeLinecap:"round",strokeLinejoin:"round",children:i.jsx("path",{d:"M2 7h3l2-4 2 8 2-4h3"})})};function Ut({isActive:r,size:e="lg",color:t="red",frequencyData:n}){const s=e==="sm"?8:16,o=e==="sm"?"h-4":"h-10",a=e==="sm"?"w-[2px]":"w-[3px]",l=e==="sm"?"gap-[2px]":"gap-[3px]",d=t==="cyan"?"bg-[var(--accent-cyan)]":"bg-[var(--accent-red)]",c=n&&n.length>0;return i.jsx("div",{className:`flex items-end justify-center ${l} ${o}`,children:Array.from({length:s}).map((u,f)=>{const m=c&&n[f]||0;return i.jsx("div",{className:`${a} rounded-full ${r?d:"bg-[var(--text-muted)]"}`,style:{height:c?`${Math.max(10,m*100)}%`:r?"100%":"30%",animation:!c&&r?"wave 0.8s ease-in-out infinite":"none",animationDelay:c?void 0:`${f*.05}s`,transition:c?"height 50ms ease-out":"all 300ms"}},f)})})}function Yn({rating:r,onChange:e,size:t="sm"}){const n=t==="md"?"w-5 h-5":"w-4 h-4";return i.jsx("div",{className:"flex items-center gap-0.5",children:[1,2,3,4,5].map(s=>i.jsx("button",{onClick:()=>e?.(r===s?0:s),className:`${n} transition-colors ${s<=r?"text-[#facc15]":"text-[var(--text-muted)]"} ${e?"hover:text-[#facc15] cursor-pointer":"cursor-default"}`,disabled:!e,children:i.jsx(G.Star,{filled:s<=r})},s))})}function Zn({tags:r,onChange:e,compact:t=!1}){const[n,s]=w.useState(!1),o=l=>{r.includes(l)?e(r.filter(d=>d!==l)):e([...r,l])},a=n?Et:Et.slice(0,8);return i.jsxs("div",{className:"flex flex-wrap gap-1.5",children:[a.map(l=>i.jsx("button",{onClick:()=>o(l),className:`px-2 py-0.5 text-[10px] rounded-full transition-all ${r.includes(l)?"bg-[var(--accent-cyan)] text-[var(--bg-primary)]":"bg-[var(--bg-tertiary)] text-[var(--text-secondary)] hover:bg-[var(--bg-secondary)]"}`,children:l},l)),!t&&i.jsx("button",{onClick:()=>s(!n),className:"px-2 py-0.5 text-[10px] rounded-full bg-[var(--bg-secondary)] text-[var(--text-muted)] hover:text-[var(--text-primary)]",children:n?"less":`+${Et.length-8}`})]})}function Kn({color:r,onChange:e}){return i.jsx("div",{className:"flex items-center gap-1",children:wn.map(t=>i.jsx("button",{onClick:()=>e(t.value),className:`w-5 h-5 rounded-full border-2 transition-all ${r===t.value?"border-white scale-110":"border-transparent"} ${t.value===""?"bg-[var(--bg-tertiary)]":""}`,style:{backgroundColor:t.value||void 0},title:t.name},t.name))})}function Jn(r,e,t,n){const s=w.useRef(null),o=w.useRef(null),a=w.useRef(null),l=w.useRef(n?.loop??!1),[d,c]=w.useState(!1),[u,f]=w.useState(!1),[m,p]=w.useState(0),[h,b]=w.useState(0),[v,C]=w.useState(1),k=w.useRef(1);w.useEffect(()=>{l.current=n?.loop??!1},[n?.loop]),w.useEffect(()=>{if(!r.current||!t)return;const O=en.create(),S=Nt.create({container:e?.current||void 0,height:30,waveColor:"rgba(255, 255, 255, 0.35)",progressColor:"rgba(0, 255, 136, 0.6)",cursorColor:"#ffffff",cursorWidth:2,overlayColor:"rgba(0, 255, 136, 0.12)",interact:!1,normalize:!0,barWidth:1,barGap:1,barRadius:1}),P=kt.create({container:r.current,waveColor:"rgba(255, 255, 255, 0.25)",progressColor:"#00ff88",cursorColor:"#ffffff",cursorWidth:2,barWidth:2,barGap:1,barRadius:2,height:120,normalize:!0,backend:"WebAudio",interact:!1,dragToSeek:!1,minPxPerSec:1,plugins:[O,S]});P.load(t),s.current=P,o.current=O,a.current=S;let H=null;P.on("ready",()=>{c(!0),b(P.getDuration());const Z=S.minimapWrapper;if(Z){Z.style.cursor="grab";const X=q=>{q.preventDefault(),q.stopPropagation(),P.isPlaying()&&P.pause(),Z.style.cursor="grabbing";const J=P.getDuration()||1,Q=ee=>{const we=Z.getBoundingClientRect(),pe=Math.max(0,Math.min(1,(ee-we.left)/we.width));P.setTime(pe*J)};Q(q.clientX);const le=ee=>Q(ee.clientX),De=()=>{Z.style.cursor="grab",window.removeEventListener("mousemove",le),window.removeEventListener("mouseup",De)};window.addEventListener("mousemove",le),window.addEventListener("mouseup",De)};Z.addEventListener("mousedown",X),H=()=>Z.removeEventListener("mousedown",X)}}),P.on("audioprocess",()=>{p(P.getCurrentTime())}),P.on("seeking",()=>{p(P.getCurrentTime())}),P.on("play",()=>f(!0)),P.on("pause",()=>f(!1)),P.on("finish",()=>{l.current?(P.seekTo(0),P.play()):f(!1)});const I=r.current,_=Z=>{Z.preventDefault();const X=Z.deltaY>0?-1:1,q=k.current,J=Math.max(1,Math.min(50,q+X));if(J===q)return;const Q=I.clientWidth,le=P.getDuration()||1,De=I.getBoundingClientRect(),ee=Z.clientX-De.left,we=P.getScroll(),pe=Q/le*q,Le=(we+ee)/pe,ve=Q/le*J;try{P.zoom(ve)}catch{}const be=Math.max(0,Le*ve-ee);requestAnimationFrame(()=>{P.setScroll(be)}),k.current=J,C(J)};I.addEventListener("wheel",_,{passive:!1});let E=0,z=0,ie=!1,K=!1;const ce=4,de=Z=>Z.composedPath().some(X=>X instanceof HTMLElement&&X.style.cursor==="ew-resize"),ge=Z=>{if(Z.button!==0)return;if(de(Z)){K=!0;const J=()=>{K=!1,window.removeEventListener("mouseup",J)};window.addEventListener("mouseup",J);return}E=Z.clientX,z=P.getScroll(),ie=!1;const X=J=>{if(K)return;const Q=J.clientX-E;!ie&&Math.abs(Q)>ce&&(ie=!0,I.style.cursor="grabbing"),ie&&P.setScroll(z-Q)},q=()=>{window.removeEventListener("mousemove",X),window.removeEventListener("mouseup",q),I.style.cursor="",ie=!1};window.addEventListener("mousemove",X),window.addEventListener("mouseup",q)},Ee=Z=>{if(K||de(Z)||o.current&&o.current.getRegions().length>0)return;const X=I.getBoundingClientRect(),q=P.getDuration()||1,J=I.clientWidth/q*k.current,Q=(P.getScroll()+(Z.clientX-X.left))/J;P.setTime(Math.max(0,Math.min(q,Q)))};return I.addEventListener("mousedown",ge),I.addEventListener("dblclick",Ee),()=>{I.removeEventListener("wheel",_),I.removeEventListener("mousedown",ge),I.removeEventListener("dblclick",Ee),H?.(),P.destroy(),s.current=null,o.current=null,a.current=null,c(!1),f(!1),k.current=1,C(1)}},[t,r]);const D=w.useCallback(()=>{s.current&&(s.current.pause(),s.current.seekTo(0),p(0))},[]),j=w.useCallback(()=>s.current?.playPause(),[]),R=w.useCallback(O=>{if(s.current&&h>0){const S=Math.max(0,Math.min(h,m+O));s.current.seekTo(S/h)}},[m,h]),N=w.useCallback(O=>{if(s.current&&r.current)try{const S=Math.max(1,Math.min(50,O)),P=r.current.clientWidth,H=s.current.getDuration()||1,I=P/H*S;s.current.zoom(I),k.current=S,C(S)}catch{}},[r]),M=w.useCallback((O,S,P)=>{s.current&&s.current.setOptions({waveColor:O,progressColor:S,cursorColor:P})},[]);return{wavesurferRef:s,regions:o.current,minimapRef:a,isReady:d,isPlaying:u,currentTime:m,duration:h,zoomLevel:v,stop:D,togglePlay:j,skip:R,setZoom:N,setColors:M}}function Qn({recording:r,recordings:e,onClose:t,onDelete:n,onUpdate:s,onSelectRecording:o,onSelectRecordingFromCrop:a,onRefreshRecordings:l,cameFromRecordingId:d}){const c=w.useRef(null),u=w.useRef(null),[f,m]=w.useState(null),[p,h]=w.useState(null),[b,v]=w.useState(null),[C,k]=w.useState(!0),[D,j]=w.useState(r.isLooped||!1),[R,N]=w.useState(!1),[M,O]=w.useState(!1),[S,P]=w.useState(!1),[H,I]=w.useState(r.tabTitle),[_,E]=w.useState(!1),[z,ie]=w.useState(null),K=w.useRef(null),ce=w.useRef(null),[de,ge]=w.useState(null),[Ee,Z]=w.useState(""),[X,q]=w.useState(""),{wavesurferRef:J,isReady:Q,isPlaying:le,currentTime:De,duration:ee,zoomLevel:we,regions:pe,minimapRef:Le,togglePlay:ve,skip:be,stop:je,setZoom:ze,setColors:Pe}=Jn(c,u,f,{loop:D});w.useEffect(()=>{let x=null;return(async()=>{k(!0),v(null);try{const se=await re().getRecordingBlob(r.id);se.success?(x=URL.createObjectURL(se.data),m(x),h(se.data)):v("Audio file not found on disk")}catch(F){v("Error loading audio"),console.error(F)}finally{k(!1)}})(),()=>{x&&URL.revokeObjectURL(x)}},[r.id]),w.useEffect(()=>{ee>0&&ee!==r.duration&&s({...r,duration:Math.round(ee)})},[ee]),w.useEffect(()=>{if(pe)if(_&&z){pe.clearRegions();const x=pe.addRegion({start:z.start,end:z.end,color:"rgba(255, 59, 92, 0.35)",drag:!1,resize:!0});K.current=x,x.element&&(x.element.style.pointerEvents="none",x.element.style.borderTop="none",x.element.style.borderBottom="none",x.element.style.zIndex="10",x.element.querySelectorAll('div[style*="cursor: ew-resize"]').forEach((xe,B)=>{const Y=xe,ue=B===0;Y.style.pointerEvents="all",Y.style.width="10px",Y.style.background="transparent",Y.style.borderRadius="0",Y.style.borderLeft="none",Y.style.borderRight="none",Y.style.zIndex="11",Y.style.borderInline="none",Y.style.marginLeft=ue?"-5px":"0",Y.style.marginRight=ue?"0":"-5px",Y.style.backgroundImage="linear-gradient(to right, transparent 4px, #ff9500 4px, #ff9500 6px, transparent 6px)"}));let L=null;const F=Le.current?.miniWavesurfer;if(F&&(L=F.registerPlugin(en.create()),L)){const te=L.addRegion({start:z.start,end:z.end,color:"rgba(255, 149, 0, 0.15)",drag:!1,resize:!1});te.element&&(te.element.style.pointerEvents="none",te.element.style.borderLeft="1px solid rgba(255, 149, 0, 0.5)",te.element.style.borderRight="1px solid rgba(255, 149, 0, 0.5)")}const se=()=>{if(K.current){const{start:te,end:xe}=K.current;if(ie({start:te,end:xe}),L){L.clearRegions();const B=L.addRegion({start:te,end:xe,color:"rgba(255, 149, 0, 0.15)",drag:!1,resize:!1});B.element&&(B.element.style.pointerEvents="none",B.element.style.borderLeft="1px solid rgba(255, 149, 0, 0.5)",B.element.style.borderRight="1px solid rgba(255, 149, 0, 0.5)")}}};return x.on("update-end",se),x.on("update",se),()=>{x.remove(),K.current=null,L&&(L.clearRegions(),L.destroy())}}else pe.clearRegions(),K.current=null},[_,pe]),w.useEffect(()=>{if(K.current&&z){const x=K.current;(Math.abs(x.start-z.start)>.01||Math.abs(x.end-z.end)>.01)&&x.setOptions({start:z.start,end:z.end})}},[z]),w.useEffect(()=>{if(!pe||!_)return;const x=L=>{K.current===L&&J.current?.isPlaying()&&(D?L.play():(J.current.pause(),J.current.setTime(L.end)))};return pe.on("region-out",x),()=>{pe.un("region-out",x)}},[pe,_,D]),w.useEffect(()=>{const x=L=>{if(!(L.target instanceof HTMLInputElement||L.target instanceof HTMLTextAreaElement))switch(L.code){case"Space":L.preventDefault(),le?ve():_&&K.current?K.current.play():ve();break;case"ArrowLeft":be(-5);break;case"ArrowRight":be(5);break;case"KeyL":j(F=>!F);break}};return window.addEventListener("keydown",x),()=>window.removeEventListener("keydown",x)},[ve,be,le,_]);const Fe=()=>{je(),setTimeout(()=>{if(d){const x=e.find(L=>L.id===d);if(x){o(x);return}}t()},50)},$e=()=>{je(),n()},Xe=x=>{ze(we+x)},Be=()=>{H.trim()&&H!==r.tabTitle&&s({...r,tabTitle:H.trim()}),P(!1)},[Ve,We]=w.useState(r.filename),[Me,nt]=w.useState(!1);w.useEffect(()=>{(async()=>{const L=re(),F=L.getFullPath(),se=await L.getFolderName(),te=F||se;if(te){const xe=L.getFolders(),B=xe.find(Y=>Y.id===r.folderId);if(B){let Y=B;const ue=[];for(;Y;)ue.unshift(Y.name),Y=xe.find(Oe=>Oe.id===Y?.parentId);We([te,...ue,r.filename].join("/"))}else r.folderId==="uncategorized"?We(`${te}/${r.filename}`):We(`${te}/${r.filename}`)}})()},[r.id,r.folderId,r.filename]);const _e=async()=>{await navigator.clipboard.writeText(Ve),nt(!0),setTimeout(()=>nt(!1),2e3)},lt=async()=>{if(p){N(!0);try{const x=await jt(p),L=await Sn(x);s({...r,bpm:L})}catch(x){console.error("BPM detection failed:",x)}finally{N(!1)}}},ct=async()=>{if(p){N(!0);try{const x=await jt(p),L=En(x),F=Dt(L);await re().saveRecording(r,F),h(F);const te=URL.createObjectURL(F);m(te)}catch(x){console.error("Normalize failed:",x)}finally{N(!1)}}},[Ge,Ye]=w.useState(!1),st=async()=>{const x=re(),L=x.getFullPath(),F=await x.getFolderName(),se=L||F;let te=r.filename;if(se){const xe=x.getFolders(),B=xe.find(Y=>Y.id===r.folderId);if(B){const Y=[];let ue=B;for(;ue;)Y.unshift(ue.name),ue=xe.find(Oe=>Oe.id===ue?.parentId);te=[se,...Y,r.filename].join("/")}else te=`${se}/${r.filename}`}await navigator.clipboard.writeText(te),Ye(!0),setTimeout(()=>Ye(!1),2e3)},rt=()=>{ee&&(je(),E(!0),ie({start:ee*.25,end:ee*.75}),Pe("rgba(255, 255, 255, 0.08)","#ff3b5c","#ff3b5c"))},it=()=>{je(),E(!1),ie(null),Pe("rgba(255, 255, 255, 0.25)","#00ff88","#00ff88")},Ze=async()=>{if(!(!p||!z)){N(!0);try{const x=await jt(p),L=jn(x,z.start,z.end),F=Dt(L),se=Math.round(z.end-z.start),B=re().getRecordings().filter(ue=>ue.parentId===r.id).length+1,Y=`${r.tabTitle} (crop ${B})`;ge({blob:F,duration:se}),Z(Y)}catch(x){console.error("Crop failed:",x)}finally{N(!1)}}},Ke=async()=>{if(!de)return;const x=Ee.trim()||`${r.tabTitle} (crop)`;if(e.some(F=>F.tabTitle===x)){q("A recording with this name already exists");return}q(""),N(!0);try{const F=re(),se=Date.now(),te=new Date(se),xe=`${String(te.getHours()).padStart(2,"0")}-${String(te.getMinutes()).padStart(2,"0")}-${String(te.getSeconds()).padStart(2,"0")}`,B=x.replace(/[^a-zA-Z0-9]/g,"_").slice(0,30),Y=crypto.randomUUID().slice(0,8),ue={id:crypto.randomUUID(),filename:`${B}_${xe}_${Y}.wav`,duration:de.duration,timestamp:se,tabTitle:x,tabUrl:r.tabUrl,hostname:r.hostname,size:de.blob.size,folderId:r.folderId,parentId:r.id};await F.saveRecording(ue,de.blob),ge(null),Z(""),q(""),E(!1),ie(null),Pe("rgba(255, 255, 255, 0.25)","#00ff88","#00ff88"),l(),a(ue,r.id)}catch(F){console.error("Save crop failed:",F)}finally{N(!1)}},g=()=>{ge(null),Z(""),q("")},T=ee>0?ee:r.duration;return i.jsxs("div",{className:"flex-1 overflow-y-auto",children:[i.jsxs("div",{className:"sticky top-0 z-10 flex items-center gap-3 px-4 py-3 border-b border-[var(--border-color)] bg-[var(--bg-primary)]",children:[i.jsx("button",{onClick:Fe,className:"p-1.5 rounded-lg hover:bg-[var(--bg-tertiary)] text-[var(--text-muted)] hover:text-[var(--text-primary)] transition-colors",children:i.jsx(G.ChevronLeft,{})}),i.jsxs("div",{className:"flex-1 min-w-0",children:[S?i.jsx("input",{ref:ce,type:"text",value:H,onChange:x=>I(x.target.value),onBlur:Be,onKeyDown:x=>{x.key==="Enter"&&Be(),x.key==="Escape"&&(I(r.tabTitle),P(!1))},className:"text-sm font-medium w-full bg-transparent border-b border-[var(--accent-cyan)] focus:outline-none",autoFocus:!0}):i.jsxs("div",{className:"text-sm font-medium truncate flex items-center gap-2 cursor-pointer hover:text-[var(--accent-cyan)] group",onClick:()=>{P(!0),setTimeout(()=>ce.current?.focus(),0)},children:[r.color&&i.jsx("span",{className:"w-2 h-2 rounded-full",style:{backgroundColor:r.color}}),r.tabTitle,i.jsx("span",{className:"opacity-0 group-hover:opacity-100 text-[var(--text-muted)]",children:i.jsx(G.Edit,{})})]}),i.jsxs("div",{className:"text-[10px] text-[var(--text-muted)] mono flex items-center gap-2",children:[on(r.timestamp),r.bpm&&i.jsxs("span",{className:"text-[var(--accent-cyan)]",children:[r.bpm," BPM"]}),r.key&&i.jsx("span",{className:"text-[var(--accent-purple)]",children:r.key})]})]}),i.jsx(Yn,{rating:r.rating||0,onChange:x=>s({...r,rating:x})}),i.jsx("button",{onClick:$e,className:"p-1.5 rounded-lg hover:bg-[var(--accent-red-dim)] text-[var(--text-muted)] hover:text-[var(--accent-red)] transition-colors",children:i.jsx(G.Trash,{})})]}),i.jsxs("div",{className:"p-4 space-y-4",children:[i.jsxs("div",{className:"bg-[var(--bg-tertiary)] rounded-lg p-3 relative",children:[(C||!Q)&&!b&&i.jsx("div",{className:"absolute inset-0 flex items-center justify-center bg-[var(--bg-tertiary)] rounded-lg z-10",children:i.jsx("div",{className:"flex gap-1",children:Array.from({length:5}).map((x,L)=>i.jsx("div",{className:"w-1 h-10 bg-[var(--accent-cyan)] rounded-full animate-pulse",style:{animationDelay:`${L*.1}s`}},L))})}),i.jsx("div",{ref:c,className:"w-full cursor-pointer",style:{userSelect:"none",overflowX:"hidden"}}),i.jsx("div",{className:"h-[1px] bg-[var(--accent-cyan)] opacity-30 mx-0"}),i.jsx("div",{ref:u,className:"w-full"}),le&&Q&&i.jsxs("div",{className:"absolute bottom-4 right-4 flex items-center gap-1 px-2 py-1 rounded bg-[var(--accent-cyan-dim)]",children:[i.jsx("span",{className:"w-1.5 h-1.5 bg-[var(--accent-cyan)] rounded-full animate-pulse"}),i.jsx("span",{className:"text-[10px] text-[var(--accent-cyan)] mono",children:"PLAYING"})]}),D&&i.jsxs("div",{className:"absolute top-4 right-4 flex items-center gap-1 px-2 py-1 rounded bg-[var(--accent-purple)]/20",children:[i.jsx(G.Loop,{}),i.jsx("span",{className:"text-[10px] text-[var(--accent-purple)] mono",children:"LOOP"})]})]}),i.jsxs("div",{className:"flex items-center justify-between",children:[i.jsx("span",{className:"text-sm mono text-[var(--text-primary)]",children:ut(De)}),i.jsxs("div",{className:"flex items-center gap-2",children:[i.jsx("button",{onClick:()=>Xe(-2),className:"p-1.5 rounded hover:bg-[var(--bg-tertiary)] text-[var(--text-muted)] hover:text-[var(--text-primary)]",children:i.jsx(G.ZoomOut,{})}),i.jsxs("span",{className:"text-[10px] text-[var(--text-muted)] w-10 text-center",children:[we,"x"]}),i.jsx("button",{onClick:()=>Xe(2),className:"p-1.5 rounded hover:bg-[var(--bg-tertiary)] text-[var(--text-muted)] hover:text-[var(--text-primary)]",children:i.jsx(G.ZoomIn,{})})]}),i.jsx("span",{className:"text-sm mono text-[var(--text-muted)]",children:ut(T)})]}),i.jsxs("div",{className:"flex items-center justify-center gap-3",children:[i.jsx("button",{onClick:()=>be(-5),className:"p-2 rounded-full hover:bg-[var(--bg-tertiary)] text-[var(--text-secondary)] hover:text-[var(--text-primary)]",title:"-5s",children:i.jsx(G.SkipBack,{})}),i.jsx("button",{onClick:()=>{le?ve():_&&K.current?K.current.play():ve()},disabled:!Q,className:`w-14 h-14 rounded-full flex items-center justify-center transition-all ${Q?_?"bg-[var(--accent-orange)] hover:shadow-[0_0_20px_rgba(255,149,0,0.3)] text-[var(--bg-primary)]":"bg-[var(--accent-cyan)] hover:shadow-[var(--glow-cyan)] text-[var(--bg-primary)]":"bg-[var(--bg-tertiary)] text-[var(--text-muted)]"}`,children:le?i.jsx(G.Pause,{}):i.jsx(G.Play,{size:20})}),i.jsx("button",{onClick:()=>be(5),className:"p-2 rounded-full hover:bg-[var(--bg-tertiary)] text-[var(--text-secondary)] hover:text-[var(--text-primary)]",title:"+5s",children:i.jsx(G.SkipForward,{})}),i.jsx("button",{onClick:()=>j(!D),className:`p-2 rounded-full transition-all ${D?"bg-[var(--accent-purple)]/20 text-[var(--accent-purple)]":"hover:bg-[var(--bg-tertiary)] text-[var(--text-muted)]"}`,title:"Loop (L)",children:i.jsx(G.Loop,{})})]}),_&&z&&i.jsxs("div",{className:"flex items-center justify-between px-3 py-2 rounded-lg bg-[var(--accent-orange)]/10 border border-[var(--accent-orange)]/30",children:[i.jsxs("div",{className:"text-xs text-[var(--accent-orange)] mono",children:[ut(z.start),"  ",ut(z.end)," (",ut(z.end-z.start),")"]}),i.jsxs("div",{className:"flex gap-2",children:[i.jsx("button",{onClick:it,className:"btn btn-ghost text-xs py-1",children:"Cancel"}),i.jsxs("button",{onClick:Ze,disabled:R,className:"btn text-xs py-1 bg-[var(--accent-orange)] text-[var(--bg-primary)]",children:[i.jsx(G.Scissors,{}),"Apply Crop"]})]})]}),i.jsxs("div",{className:"flex items-center justify-center gap-2 flex-wrap",children:[i.jsxs("button",{onClick:lt,disabled:R,className:"btn btn-ghost text-xs",children:[i.jsx(G.Bpm,{}),"Detect BPM"]}),i.jsxs("button",{onClick:ct,disabled:R,className:"btn btn-ghost text-xs",children:[i.jsx(G.Volume,{}),"Normalize"]}),i.jsxs("button",{onClick:_?it:rt,disabled:R||!Q,className:`btn text-xs ${_?"bg-[var(--accent-orange)]/20 text-[var(--accent-orange)] border border-[var(--accent-orange)]/30":"btn-ghost"}`,children:[i.jsx(G.Scissors,{}),"Crop"]}),i.jsxs("button",{onClick:st,className:"btn btn-ghost text-xs",children:[i.jsx(G.Copy,{}),Ge?"Copied!":"Copy Path"]})]}),i.jsxs("div",{className:"glass-panel p-3",children:[i.jsxs("div",{className:"flex items-center justify-between mb-2",children:[i.jsx("span",{className:"text-[10px] text-[var(--text-muted)]",children:"TAGS"}),i.jsx("button",{onClick:()=>O(!M),className:"text-[10px] text-[var(--accent-cyan)]",children:M?"hide":"edit"})]}),M?i.jsx(Zn,{tags:r.tags||[],onChange:x=>s({...r,tags:x})}):i.jsx("div",{className:"flex flex-wrap gap-1",children:(r.tags||[]).length>0?r.tags.map(x=>i.jsx("span",{className:"px-2 py-0.5 text-[10px] rounded-full bg-[var(--accent-cyan)] text-[var(--bg-primary)]",children:x},x)):i.jsx("span",{className:"text-[10px] text-[var(--text-muted)]",children:"No tags"})})]}),i.jsxs("div",{className:"flex items-center gap-4",children:[i.jsxs("div",{className:"flex-1 glass-panel p-3",children:[i.jsx("span",{className:"text-[10px] text-[var(--text-muted)] block mb-2",children:"COLOR"}),i.jsx(Kn,{color:r.color||"",onChange:x=>s({...r,color:x})})]}),i.jsxs("div",{className:"glass-panel p-3",children:[i.jsx("span",{className:"text-[10px] text-[var(--text-muted)] block mb-2",children:"KEY"}),i.jsxs("select",{value:r.key||"",onChange:x=>s({...r,key:x.target.value}),className:"bg-[var(--bg-tertiary)] border border-[var(--border-color)] rounded px-2 py-1 text-xs",children:[i.jsx("option",{value:"",children:"-"}),Cn.map(x=>i.jsx("option",{value:x,children:x},x))]})]})]}),i.jsxs("div",{className:"glass-panel p-3",children:[i.jsx("span",{className:"text-[10px] text-[var(--text-muted)] block mb-2",children:"NOTES"}),i.jsx("textarea",{value:r.notes||"",onChange:x=>s({...r,notes:x.target.value}),placeholder:"Add notes...",className:"w-full bg-[var(--bg-tertiary)] border border-[var(--border-color)] rounded p-2 text-xs resize-none h-16"})]}),i.jsxs("div",{className:"glass-panel p-3",children:[i.jsxs("div",{className:"flex items-center justify-between mb-1",children:[i.jsx("span",{className:"text-[10px] text-[var(--text-muted)]",children:"FILE PATH"}),i.jsxs("button",{onClick:_e,className:"text-[10px] text-[var(--accent-cyan)] hover:underline flex items-center gap-1",children:[i.jsx(G.Copy,{}),Me?"Copied!":"Copy path"]})]}),i.jsx("div",{onClick:_e,className:"text-xs text-[var(--text-secondary)] truncate mono cursor-pointer hover:text-[var(--accent-cyan)] transition-colors",title:Ve,children:Ve}),i.jsxs("div",{className:"flex items-center gap-3 mt-2 text-[10px] text-[var(--text-muted)]",children:[i.jsx("span",{children:ln(r.size)}),i.jsx("span",{children:""}),i.jsx("span",{children:mt(r.duration)}),i.jsx("span",{children:""}),i.jsx("span",{children:"WAV"})]})]}),b&&i.jsx("div",{className:"text-center text-xs text-[var(--accent-red)]",children:b})]}),i.jsxs("div",{className:"sticky bottom-0 px-4 py-2 border-t border-[var(--border-color)] flex items-center justify-center gap-4 text-[10px] text-[var(--text-muted)] bg-[var(--bg-primary)]",children:[i.jsxs("span",{children:[i.jsx("kbd",{className:"px-1 py-0.5 bg-[var(--bg-tertiary)] rounded",children:"Space"})," Play"]}),i.jsxs("span",{children:[i.jsx("kbd",{className:"px-1 py-0.5 bg-[var(--bg-tertiary)] rounded",children:""})," Seek"]}),i.jsxs("span",{children:[i.jsx("kbd",{className:"px-1 py-0.5 bg-[var(--bg-tertiary)] rounded",children:"L"})," Loop"]}),i.jsxs("span",{children:[i.jsx("kbd",{className:"px-1 py-0.5 bg-[var(--bg-tertiary)] rounded",children:"Scroll"})," Zoom"]})]}),de&&i.jsx("div",{className:"fixed inset-0 bg-black/70 flex items-center justify-center z-50 p-4",children:i.jsxs("div",{className:"bg-[var(--bg-secondary)] rounded-xl p-4 w-full max-w-sm border border-[var(--border-color)] shadow-2xl",children:[i.jsx("h3",{className:"text-sm font-semibold mb-1 text-[var(--text-primary)]",children:"Save Crop"}),i.jsxs("p",{className:"text-xs text-[var(--text-muted)] mb-3",children:["Duration: ",mt(de.duration)]}),i.jsx("input",{type:"text",value:Ee,onChange:x=>{Z(x.target.value),q("")},onKeyDown:x=>{x.key==="Enter"&&Ke()},placeholder:"Crop name...",autoFocus:!0,className:`w-full px-3 py-2 bg-[var(--bg-tertiary)] border rounded-lg text-sm text-[var(--text-primary)] placeholder:text-[var(--text-muted)] focus:outline-none ${X?"border-[var(--accent-red)]":"border-[var(--border-color)] focus:border-[var(--accent-cyan)]"}`}),X&&i.jsx("p",{className:"text-xs text-[var(--accent-red)] mt-1 mb-2",children:X}),!X&&i.jsx("div",{className:"mb-3"}),i.jsxs("div",{className:"flex gap-2",children:[i.jsx("button",{onClick:g,className:"flex-1 px-3 py-2 text-sm font-medium text-[var(--text-muted)] hover:text-[var(--text-primary)] bg-[var(--bg-tertiary)] rounded-lg transition-colors",children:"Cancel"}),i.jsx("button",{onClick:Ke,disabled:R,className:"flex-1 px-3 py-2 text-sm font-medium text-white bg-[var(--accent-cyan)] hover:bg-[var(--accent-cyan-hover)] rounded-lg transition-colors disabled:opacity-50",children:R?"Saving...":"Save"})]})]})})]})}function es({isRecording:r,elapsed:e,tabTitle:t,error:n,frequencyData:s,onToggleRecording:o,onOpenDownloads:a}){return w.useEffect(()=>{const l=d=>{d.target instanceof HTMLInputElement||d.target instanceof HTMLTextAreaElement||d.code==="KeyR"&&!d.ctrlKey&&!d.metaKey&&(d.preventDefault(),o())};return window.addEventListener("keydown",l),()=>window.removeEventListener("keydown",l)},[o]),i.jsxs("div",{className:"flex-1 flex flex-col items-center justify-center p-8 animate-fade-in",children:[i.jsx("div",{className:"mb-10 text-center",children:r?i.jsxs(i.Fragment,{children:[i.jsxs("div",{className:"flex items-center justify-center gap-2 mb-4",children:[i.jsx("span",{className:"w-2 h-2 bg-[var(--accent-red)] rounded-full animate-pulse"}),i.jsx("span",{className:"text-xs font-semibold tracking-widest text-[var(--accent-red)]",children:"RECORDING"})]}),i.jsx(Ut,{isActive:!0,frequencyData:s}),i.jsx("div",{className:"mt-6 text-6xl font-bold mono tracking-tight",children:mt(e)}),i.jsx("div",{className:"mt-4 text-sm text-[var(--text-secondary)] max-w-[300px] truncate px-4",children:t})]}):i.jsxs(i.Fragment,{children:[i.jsx(Ut,{isActive:!1}),i.jsxs("div",{className:"mt-6 text-lg text-[var(--text-secondary)]",children:["Press ",i.jsx("kbd",{className:"px-2 py-1 bg-[var(--bg-tertiary)] rounded text-[var(--accent-cyan)]",children:"R"})," or click to record"]}),i.jsx("div",{className:"mt-2 text-sm text-[var(--text-muted)]",children:"Captures audio from current tab"})]})}),i.jsxs("div",{className:"relative",children:[r&&i.jsxs(i.Fragment,{children:[i.jsx("div",{className:"absolute inset-0 rounded-full bg-[var(--accent-red)] opacity-20 ripple-ring"}),i.jsx("div",{className:"absolute inset-0 rounded-full bg-[var(--accent-red)] opacity-20 ripple-ring",style:{animationDelay:"0.5s"}})]}),i.jsx("button",{onClick:o,className:`relative w-32 h-32 rounded-full flex items-center justify-center transition-all duration-300 transform hover:scale-105 active:scale-95 ${r?"bg-[var(--accent-red)] recording-pulse":"bg-[var(--bg-tertiary)] border border-[var(--border-color)] hover:border-[var(--accent-cyan)] hover:shadow-[var(--glow-cyan)]"}`,children:r?i.jsx(G.Stop,{}):i.jsx(G.Mic,{})})]}),n&&i.jsx("div",{className:"mt-8 px-4 py-3 glass-panel border-[var(--accent-red)]/30 text-sm text-[var(--accent-red)] max-w-full",children:n})]})}function ts({folders:r,recordings:e,searchQuery:t,onSearchChange:n,onCreateFolder:s,onRenameFolder:o,onDeleteFolder:a,onMoveRecording:l,onMoveFolder:d,onReorderFolder:c,onReorderRecording:u,onDeleteRecording:f,onConfirmDeleteRecording:m,onConfirmDeleteFolder:p,onRenameRecording:h,onOpenDownloads:b,onSelectRecording:v,onPreviewRecording:C,previewingId:k,playingPreviewId:D,onPlayPreview:j,expandedFolders:R,onToggleFolder:N}){const[M,O]=w.useState(null),[S,P]=w.useState(null),[H,I]=w.useState(""),[_,E]=w.useState(""),[z,ie]=w.useState(!1),[K,ce]=w.useState(null),[de,ge]=w.useState(null),[Ee,Z]=w.useState(null),[X,q]=w.useState(null),[J,Q]=w.useState(null),[le,De]=w.useState(0),[ee,we]=w.useState(""),[pe,Le]=w.useState(new Set),ve=w.useRef(null),be=w.useRef(null),je=g=>e.filter(T=>{if(T.parentId!==g||le>0&&(T.rating||0)!==le||ee&&(T.hostname||"")!==ee)return!1;if(t){const x=t.toLowerCase();if(!((T.tabTitle||"").toLowerCase().includes(x)||(T.hostname||"").toLowerCase().includes(x)||(T.tags||[]).some(F=>F.toLowerCase().includes(x))||(T.notes||"").toLowerCase().includes(x)||(T.key||"").toLowerCase().includes(x)))return!1}return!0}).sort((T,x)=>(T.sortOrder??T.timestamp)-(x.sortOrder??x.timestamp)),ze=g=>je(g).reduce((x,L)=>x+1+ze(L.id),0),Pe=g=>{Le(T=>{const x=new Set(T);return x.has(g)?x.delete(g):x.add(g),x})},Fe=Array.from(new Set(e.map(g=>g.hostname||"").filter(Boolean))).sort();w.useEffect(()=>{z&&ve.current&&ve.current.focus()},[z]),w.useEffect(()=>{S&&be.current&&(be.current.focus(),be.current.select())},[S]);const $e=e.filter(g=>{if(g.parentId)return!1;const T=t.toLowerCase(),x=!T||(g.tabTitle||"").toLowerCase().includes(T)||(g.hostname||"").toLowerCase().includes(T)||(g.tags||[]).some(se=>se.toLowerCase().includes(T))||(g.notes||"").toLowerCase().includes(T)||(g.key||"").toLowerCase().includes(T),L=le===0||(g.rating||0)===le,F=!ee||(g.hostname||"")===ee;return x&&L&&F}),Xe=g=>{H.trim()&&(h(g,H.trim()),I(""),P(null))},Be=()=>{_.trim()&&(s(_.trim(),null),E(""),ie(!1))},Ve=g=>{_.trim()&&(o(g,_.trim()),E(""),O(null))},We=r.filter(g=>g.parentId===null).sort((g,T)=>(g.sortOrder??g.createdAt)-(T.sortOrder??T.createdAt)),Me=$e.filter(g=>g.folderId==="uncategorized").sort((g,T)=>(g.sortOrder??g.timestamp)-(T.sortOrder??T.timestamp)),nt=g=>$e.filter(T=>T.folderId===g).sort((T,x)=>(T.sortOrder??T.timestamp)-(x.sortOrder??x.timestamp)),_e=g=>{const T=$e.filter(L=>L.folderId===g).length,x=r.filter(L=>L.parentId===g);return T+x.reduce((L,F)=>L+_e(F.id),0)},lt=(g,T)=>{g.stopPropagation(),g.dataTransfer.setData("recordingId",T),g.dataTransfer.effectAllowed="move",ge(T)},ct=(g,T)=>{g.dataTransfer.setData("folderId",T),g.dataTransfer.effectAllowed="move",Z(T),g.stopPropagation()},Ge=()=>{ge(null),Z(null),ce(null),q(null),Q(null)},Ye=(g,T)=>{if(g.preventDefault(),g.stopPropagation(),q(null),Ee&&Ee!==T){const x=g.currentTarget.getBoundingClientRect(),F=(g.clientY-x.top)/x.height;F<.25?(Q({id:T,position:"above"}),ce(null)):F>.75?(Q({id:T,position:"below"}),ce(null)):(ce(T),Q(null))}else ce(T),Q(null)},st=(g,T)=>{if(g.preventDefault(),g.stopPropagation(),de){const x=g.currentTarget.getBoundingClientRect(),F=g.clientY-x.top<x.height/2?"above":"below";q({id:T,position:F}),ce(null)}},rt=(g,T)=>{g.preventDefault(),g.stopPropagation();const x=g.dataTransfer.getData("recordingId"),L=g.dataTransfer.getData("folderId");x?l(x,T):L&&L!==T&&(J&&J.id===T?c(L,T,J.position):d(L,T==="uncategorized"?null:T)),ce(null),q(null),Q(null),ge(null),Z(null)},it=(g,T,x)=>{g.preventDefault(),g.stopPropagation();const L=g.dataTransfer.getData("recordingId"),F=g.dataTransfer.getData("folderId");L&&X?L===T||u(L,T,X.position,x):F&&F!==x&&d(F,x==="uncategorized"?null:x),ce(null),q(null),Q(null),ge(null),Z(null)},Ze=(g,T,x=0)=>{const L=k===g.id,F=D===g.id,se=S===g.id,te=X?.id===g.id&&X.position==="above",xe=X?.id===g.id&&X.position==="below",B=je(g.id),Y=B.length>0,ue=ze(g.id),Oe=pe.has(g.id),vt=x>0;return i.jsxs("div",{children:[i.jsxs("div",{draggable:!se,onDragStart:y=>lt(y,g.id),onDragEnd:Ge,onDragOver:y=>st(y,g.id),onDragLeave:()=>q(null),onDrop:y=>it(y,g.id,T),onClick:()=>!se&&v(g),onMouseEnter:()=>C(g),onMouseLeave:()=>C(null),className:`group flex items-center gap-3 px-3 py-2.5 mx-2 cursor-pointer transition-all relative ${de===g.id?"opacity-50":""} ${L?"bg-[var(--bg-tertiary)]":"hover:bg-[var(--bg-tertiary)]"} border-b border-[var(--border-color)]`,style:{marginLeft:x>0?`${x*16}px`:void 0,borderLeft:x>0?"2px solid var(--border-color)":void 0,borderTop:te?"2px solid var(--accent-cyan)":void 0,borderBottom:xe?"2px solid var(--accent-cyan)":void 0},children:[Y&&i.jsx("button",{onClick:y=>{y.stopPropagation(),Pe(g.id)},className:"w-5 h-5 flex items-center justify-center rounded cursor-pointer bg-white/10 text-[var(--text-muted)] hover:text-[var(--text-primary)] hover:bg-white/20 transition-all",title:Oe?"Collapse crops":"Show crops",children:i.jsx("span",{className:`inline-block transition-transform ${Oe?"rotate-90":""}`,children:i.jsx(G.ChevronRight,{size:10})})}),g.color&&i.jsx("span",{className:"w-2.5 h-2.5 rounded-full flex-shrink-0",style:{backgroundColor:g.color}}),vt&&i.jsx("span",{className:"text-[var(--text-muted)]",children:i.jsx(G.Scissors,{})}),i.jsxs("div",{className:"flex-1 min-w-0",children:[se?i.jsx("input",{ref:be,type:"text",value:H,onChange:y=>I(y.target.value),onBlur:()=>Xe(g.id),onKeyDown:y=>{y.stopPropagation(),y.key==="Enter"&&Xe(g.id),y.key==="Escape"&&(P(null),I(""))},onClick:y=>y.stopPropagation(),className:"text-sm w-full bg-transparent border-b border-[var(--accent-cyan)] focus:outline-none text-[var(--text-primary)]"}):i.jsx("div",{className:"text-sm truncate text-[var(--text-primary)]",children:g.tabTitle||"Untitled"}),i.jsxs("div",{className:"text-[10px] text-[var(--text-muted)] mono flex items-center gap-1.5 mt-0.5 flex-wrap",children:[i.jsx(G.Music,{}),g.duration>0&&i.jsx("span",{children:mt(g.duration)}),i.jsx("span",{className:"opacity-50",children:""}),i.jsx("span",{children:on(g.timestamp)}),g.bpm&&i.jsx("span",{className:"text-[var(--accent-cyan)]",children:g.bpm}),g.key&&i.jsx("span",{className:"text-[var(--accent-purple)]",children:g.key}),g.rating&&g.rating>0&&i.jsx("span",{className:"text-[#facc15]",children:"".repeat(g.rating)}),ue>0&&i.jsxs("span",{className:"px-1.5 py-0.5 rounded bg-[var(--bg-tertiary)] text-[var(--accent-cyan)]",children:[ue," crop",ue>1?"s":""]}),(g.tags||[]).slice(0,1).map(y=>i.jsxs("span",{children:["#",y]},y))]}),g.notes&&i.jsx("div",{className:"text-[10px] text-[var(--text-muted)] mt-0.5 truncate max-w-[200px]",title:g.notes,children:g.notes.length>40?g.notes.slice(0,40)+"...":g.notes})]}),i.jsxs("div",{className:"flex items-center gap-1",children:[i.jsx("button",{onClick:y=>{y.stopPropagation(),j(g)},className:`p-1.5 rounded-full cursor-pointer transition-all ${F?"bg-[var(--accent-cyan)] text-[var(--bg-primary)]":"bg-white/10 text-[var(--text-muted)] hover:text-[var(--accent-cyan)] hover:bg-white/20"}`,title:F?"Pause":"Play",children:F?i.jsx(G.Pause,{}):i.jsx(G.Play,{size:14})}),i.jsx("div",{id:`waveform-${g.id}`,className:`w-20 h-6 ${F?"block":"hidden"}`}),i.jsx("button",{onClick:y=>{y.stopPropagation(),I(g.tabTitle||""),P(g.id)},className:"opacity-0 group-hover:opacity-100 p-1.5 rounded-full cursor-pointer bg-white/10 text-[var(--text-muted)] hover:text-[var(--accent-cyan)] hover:bg-white/20 transition-all",title:"Rename",children:i.jsx(G.Edit,{})}),i.jsx("button",{onClick:y=>{y.stopPropagation(),m(g.id,g.tabTitle,ue)},className:"opacity-0 group-hover:opacity-100 p-1.5 rounded-full cursor-pointer bg-white/10 text-[var(--text-muted)] hover:text-[var(--accent-red)] hover:bg-white/20 transition-all",title:"Delete",children:i.jsx(G.Trash,{})})]})]}),Y&&Oe&&B.map(y=>Ze(y,T,x+1))]},g.id)},Ke=g=>{if((t||le>0||ee)&&_e(g.id)===0)return null;const T=R.has(g.id),x=nt(g.id),L=r.filter(B=>B.parentId===g.id).sort((B,Y)=>(B.sortOrder??B.createdAt)-(Y.sortOrder??Y.createdAt)),F=M===g.id,se=K===g.id,te=J?.id===g.id&&J.position==="above",xe=J?.id===g.id&&J.position==="below";return i.jsxs("div",{children:[i.jsxs("div",{draggable:!F,onDragStart:B=>ct(B,g.id),onDragEnd:Ge,onDragOver:B=>Ye(B,g.id),onDragLeave:()=>{ce(null),Q(null)},onDrop:B=>rt(B,g.id),className:`group flex items-center gap-3 px-3 py-2.5 mx-2 cursor-pointer hover:bg-[var(--bg-tertiary)] transition-all ${se?"bg-[var(--accent-cyan-dim)] border border-[var(--accent-cyan)]":""} ${Ee===g.id?"opacity-50":""}`,style:{borderTop:te?"2px solid var(--accent-cyan)":void 0,borderBottom:xe?"2px solid var(--accent-cyan)":void 0},onClick:()=>!F&&N(g.id),children:[i.jsx("span",{className:`transition-transform duration-200 text-[var(--text-muted)] ${T?"rotate-90":""}`,children:i.jsx(G.ChevronRight,{})}),i.jsx("span",{className:"w-2 h-2 rounded-full",style:{backgroundColor:g.color}}),i.jsx("span",{className:"text-[var(--text-secondary)]",children:i.jsx(G.Folder,{open:T})}),F?i.jsx("input",{ref:ve,type:"text",value:_,onChange:B=>E(B.target.value),onKeyDown:B=>{B.key==="Enter"&&Ve(g.id),B.key==="Escape"&&O(null)},onBlur:()=>O(null),className:"flex-1 bg-transparent border-none p-0 text-sm focus:outline-none",onClick:B=>B.stopPropagation()}):i.jsx("span",{className:"flex-1 text-sm text-[var(--text-primary)]",children:g.name}),i.jsxs("span",{className:"px-2 py-0.5 rounded text-xs font-medium bg-[var(--bg-tertiary)] text-[var(--text-secondary)]",children:[_e(g.id)," items"]}),i.jsx("button",{onClick:B=>{B.stopPropagation(),E(g.name),O(g.id),setTimeout(()=>ve.current?.focus(),0)},className:"opacity-0 group-hover:opacity-100 p-1 text-[var(--text-muted)] hover:text-[var(--accent-cyan)]",children:i.jsx(G.Edit,{})}),i.jsx("button",{onClick:B=>{B.stopPropagation(),p(g.id,g.name,_e(g.id)+L.length)},className:"opacity-0 group-hover:opacity-100 p-1 text-[var(--text-muted)] hover:text-[var(--accent-red)]",children:i.jsx(G.Trash,{})})]}),T&&(L.length>0||x.length>0)&&i.jsxs("div",{className:"ml-6 border-l border-[var(--border-color)]",children:[L.map(Ke),x.map(B=>Ze(B,g.id))]})]},g.id)};return i.jsxs("div",{className:"flex-1 flex flex-col",children:[i.jsxs("div",{className:"p-3 border-b border-[var(--border-color)] space-y-2",children:[i.jsxs("div",{className:"flex items-center gap-3",children:[i.jsx("div",{className:"flex-1 relative",children:i.jsx("input",{type:"text",value:t,onChange:g=>n(g.target.value),placeholder:"Search...",className:"w-full pl-3 pr-3 py-1.5 text-sm bg-[var(--bg-tertiary)] border border-[var(--border-color)] rounded-lg focus:border-[var(--accent-cyan)] focus:outline-none"})}),i.jsx("div",{className:"flex gap-0.5 flex-shrink-0",children:[1,2,3,4,5].map(g=>i.jsx("button",{onClick:()=>De(le===g?0:g),className:`w-6 h-6 text-[12px] rounded flex items-center justify-center transition-colors ${le===g?"bg-[#facc15] text-[var(--bg-primary)]":"text-[var(--text-muted)] hover:text-[#facc15]"}`,title:`${g} stars`,children:""},g))})]}),Fe.length>0&&i.jsxs("div",{className:"flex flex-wrap gap-1",children:[i.jsx("button",{onClick:()=>we(""),className:`px-2.5 py-1 text-[10px] rounded-full transition-colors ${ee?"bg-[var(--bg-tertiary)] text-[var(--text-muted)] hover:text-[var(--text-primary)]":"bg-[var(--accent-cyan)] text-[var(--bg-primary)]"}`,children:"All"}),Fe.map(g=>i.jsx("button",{onClick:()=>we(ee===g?"":g),className:`px-2.5 py-1 text-[10px] rounded-full transition-colors ${ee===g?"bg-[var(--accent-cyan)] text-[var(--bg-primary)]":"bg-[var(--bg-tertiary)] text-[var(--text-muted)] hover:text-[var(--text-primary)]"}`,children:cn(g)},g))]}),z?i.jsxs("div",{className:"flex items-center gap-2",children:[i.jsx("input",{ref:ve,type:"text",value:_,onChange:g=>E(g.target.value),onKeyDown:g=>{g.key==="Enter"&&Be(),g.key==="Escape"&&ie(!1)},placeholder:"Folder name...",className:"flex-1 text-sm"}),i.jsx("button",{onClick:Be,className:"btn btn-primary text-xs py-1.5",children:"Create"})]}):i.jsxs("button",{onClick:()=>ie(!0),className:"btn btn-ghost text-xs w-full justify-start",children:[i.jsx(G.FolderPlus,{}),"New Folder"]})]}),i.jsxs("div",{className:"flex-1 overflow-y-auto py-2",children:[We.map(Ke),i.jsxs("div",{className:"mt-2",children:[i.jsxs("div",{onDragOver:g=>Ye(g,"uncategorized"),onDragLeave:()=>ce(null),onDrop:g=>rt(g,"uncategorized"),className:`flex items-center gap-2 px-3 py-2 mx-2 rounded-lg cursor-pointer hover:bg-[var(--bg-tertiary)] transition-all ${K==="uncategorized"?"bg-[var(--accent-cyan-dim)] border border-[var(--accent-cyan)]":""}`,onClick:()=>N("uncategorized"),children:[i.jsx("span",{className:`transition-transform duration-200 text-[var(--text-muted)] ${R.has("uncategorized")?"rotate-90":""}`,children:i.jsx(G.ChevronRight,{})}),i.jsx("span",{className:"w-2 h-2 rounded-full bg-[var(--text-muted)]"}),i.jsx("span",{className:"text-[var(--text-secondary)]",children:i.jsx(G.Folder,{open:R.has("uncategorized")})}),i.jsx("span",{className:"flex-1 text-sm text-[var(--text-secondary)]",children:"Uncategorized"}),i.jsx("span",{className:"badge bg-[var(--bg-secondary)] text-[var(--text-muted)]",children:Me.length})]}),R.has("uncategorized")&&Me.length>0&&i.jsx("div",{className:"ml-6 border-l border-[var(--border-color)]",children:Me.map(g=>Ze(g,"uncategorized"))})]}),$e.length===0&&i.jsxs("div",{className:"flex-1 flex flex-col items-center justify-center py-12 text-center",children:[i.jsx("div",{className:"w-16 h-16 rounded-2xl bg-[var(--bg-tertiary)] flex items-center justify-center mb-4 text-[var(--text-muted)]",children:t?i.jsx(G.Search,{}):i.jsx(G.Music,{})}),i.jsx("div",{className:"text-sm text-[var(--text-secondary)]",children:t?"No matches found":"No recordings yet"})]})]}),i.jsxs("div",{className:"sticky bottom-0 z-10 px-4 py-2 border-t border-[var(--border-color)] text-[10px] text-[var(--text-muted)] flex items-center justify-between bg-[var(--bg-primary)]",children:[i.jsxs("span",{children:[e.length," recordings"]}),i.jsxs("span",{children:[ln(e.reduce((g,T)=>g+T.size,0))," total"]})]})]})}function ns({onSelect:r}){const[e,t]=w.useState(!1),[n,s]=w.useState(null),o=async()=>{t(!0),s(null);try{const l=await re().selectFolder();l.success?r():l.error.type!=="NO_FOLDER_SELECTED"&&s("Failed to select folder. Please try again.")}catch{s("An error occurred. Please try again.")}finally{t(!1)}};return i.jsxs("div",{className:"flex flex-col h-full bg-[var(--bg-primary)] text-[var(--text-primary)]",children:[i.jsx("div",{className:"noise-overlay"}),i.jsxs("div",{className:"flex-1 flex flex-col items-center justify-center p-8 text-center",children:[i.jsx("div",{className:"w-20 h-20 rounded-2xl bg-[var(--bg-tertiary)] flex items-center justify-center mb-6 text-[var(--accent-cyan)]",children:i.jsx(G.FolderOpen,{})}),i.jsx("h2",{className:"text-xl font-bold mb-3",children:"Welcome to CucuBau-Sound"}),i.jsx("p",{className:"text-sm text-[var(--text-secondary)] mb-6 max-w-[280px]",children:"Choose a folder where your recordings will be saved. All audio files and library data will be stored there."}),i.jsx("button",{onClick:o,disabled:e,className:"btn bg-[var(--accent-cyan)] text-[var(--bg-primary)] hover:shadow-[var(--glow-cyan)] px-6 py-3 text-sm font-semibold",children:e?"Selecting...":"Choose Folder"}),n&&i.jsx("p",{className:"mt-4 text-xs text-[var(--accent-red)]",children:n}),i.jsx("p",{className:"mt-8 text-[10px] text-[var(--text-muted)] max-w-[260px]",children:"Your recordings are stored locally on your computer. No data is sent to any server."})]})]})}function ss({progress:r,message:e}){return i.jsxs("div",{className:"flex flex-col h-full bg-[var(--bg-primary)] text-[var(--text-primary)]",children:[i.jsx("div",{className:"noise-overlay"}),i.jsxs("div",{className:"flex-1 flex flex-col items-center justify-center p-8 text-center",children:[i.jsx("div",{className:"w-20 h-20 rounded-2xl bg-[var(--accent-cyan)]/20 flex items-center justify-center mb-6 text-[var(--accent-cyan)]",children:i.jsx("svg",{width:"32",height:"32",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",className:"animate-spin",children:i.jsx("path",{d:"M21 12a9 9 0 11-6.219-8.56"})})}),i.jsx("h2",{className:"text-xl font-bold mb-3",children:"Migrating Data"}),i.jsx("p",{className:"text-sm text-[var(--text-secondary)] mb-6 max-w-[280px]",children:e||"Moving your recordings to the new storage system..."}),i.jsx("div",{className:"w-64 h-2 bg-[var(--bg-tertiary)] rounded-full overflow-hidden",children:i.jsx("div",{className:"h-full bg-[var(--accent-cyan)] transition-all duration-300",style:{width:`${Math.round(r*100)}%`}})}),i.jsxs("p",{className:"mt-2 text-xs text-[var(--text-muted)]",children:[Math.round(r*100),"%"]})]})]})}function rs(){return i.jsxs("div",{className:"flex flex-col h-full bg-[var(--bg-primary)] text-[var(--text-primary)]",children:[i.jsx("div",{className:"noise-overlay"}),i.jsxs("div",{className:"flex-1 flex flex-col items-center justify-center",children:[i.jsx("div",{className:"flex gap-1",children:Array.from({length:5}).map((r,e)=>i.jsx("div",{className:"w-1 h-10 bg-[var(--accent-cyan)] rounded-full animate-pulse",style:{animationDelay:`${e*.1}s`}},e))}),i.jsx("p",{className:"mt-4 text-sm text-[var(--text-muted)]",children:"Loading..."})]})]})}function is(){const[r,e]=w.useState("loading"),[t,n]=w.useState(0),[s,o]=w.useState(""),[a,l]=w.useState(null);w.useEffect(()=>{(async()=>{const f=re(),m=await f.initialize();if(m.success){if(await xt.needsMigration()){e("migrating");const h=await xt.migrate(f,(b,v,C)=>{o(b),n(v/C)});h.success||console.error("Migration failed:",h.error)}e("ready")}else{const p=m.error;if(p.type==="NO_FOLDER_SELECTED")e("needsFolder");else if(p.type==="PERMISSION_PROMPT_NEEDED"||p.type==="PERMISSION_DENIED"){const h=await f.getFolderName();l(h),e("needsPermission")}else console.error("Storage initialization failed:",p),e("needsFolder")}})()},[]);const d=async()=>{const u=re();await xt.needsMigration()&&(e("migrating"),await xt.migrate(u,(m,p,h)=>{o(m),n(p/h)})),e("ready")},c=()=>{e("ready")};switch(r){case"loading":return i.jsx(rs,{});case"needsFolder":return i.jsx(ns,{onSelect:d});case"needsPermission":return i.jsx(qt,{needsStoragePermission:!0,onPermissionGranted:c});case"migrating":return i.jsx(ss,{progress:t,message:s});case"ready":return i.jsx(qt,{})}}function qt({needsStoragePermission:r=!1,onPermissionGranted:e}){const[t,n]=w.useState(!1),[s,o]=w.useState(0),[a,l]=w.useState(""),[d,c]=w.useState([]),[u,f]=w.useState([]),[m,p]=w.useState(null),[h,b]=w.useState("record"),[v,C]=w.useState(null),[k,D]=w.useState(null),[j,R]=w.useState(""),[N,M]=w.useState(null),[O,S]=w.useState(null),[P,H]=w.useState(new Set(["uncategorized"])),[I,_]=w.useState(null),[E,z]=w.useState(""),[ie,K]=w.useState(null),[ce,de]=w.useState(""),[ge,Ee]=w.useState(!1),[Z,X]=w.useState(!1),[q,J]=w.useState(null),[Q,le]=w.useState(!0),De=w.useRef(null),ee=w.useRef(null),we=w.useRef(null),pe=w.useRef(null),Le=w.useRef(null),ve=w.useRef([]),be=w.useRef(null),je=w.useRef(null),ze=w.useRef(null);w.useRef(null);const Pe=w.useRef(null),Fe=w.useRef(0),$e=w.useRef({title:"",url:"",hostname:""}),[Xe,Be]=w.useState([]),Ve=w.useCallback(async y=>{if(!r){y();return}X(!0);try{(await re().requestPermission()).success?(e?.(),setTimeout(()=>{y(),X(!1)},100)):(p("Permission denied. Please try again."),X(!1))}catch{p("Failed to get permission."),X(!1)}},[r,e]),We=w.useCallback(async()=>{const y=re(),W=y.getFolders(),A=y.getRecordings();c(W);const U=A.map(V=>({...V,folderId:V.folderId||"uncategorized"}));f(U.sort((V,ae)=>ae.timestamp-V.timestamp));const $=await chrome.storage.local.get(["expandedFolders"]);$.expandedFolders&&H(new Set($.expandedFolders))},[]);w.useEffect(()=>{if(r)return;We();const y=A=>{A.type==="RECORDING_SAVED"&&We()},W=chrome.runtime.onMessage;return W.addListener(y),()=>W.removeListener(y)},[We,r]),w.useEffect(()=>()=>{je.current&&clearInterval(je.current)},[]);const Me=w.useCallback(()=>{ze.current&&(ze.current.destroy(),ze.current=null),Pe.current=null},[]);w.useEffect(()=>()=>{Me()},[Me]);const nt=y=>{M(y?.id||null)},_e=w.useCallback(async y=>{const W=y.id;if(O===W){Me(),S(null);return}if(Pe.current===W)return;Me(),S(null),Pe.current=W;const A=document.getElementById(`waveform-${W}`);if(!A){Pe.current=null;return}try{const $=await re().getRecordingBlob(W);if(Pe.current!==W)return;if($.success){const V=URL.createObjectURL($.data),ae=kt.create({container:A,waveColor:"#00d4ff",progressColor:"#00ff88",cursorColor:"transparent",barWidth:2,barGap:1,barRadius:1,height:24,normalize:!0});ze.current=ae,ae.on("finish",()=>{Me(),S(null)}),ae.on("ready",()=>{Pe.current===W&&(S(W),ae.play())}),ae.load(V)}else Pe.current=null}catch(U){console.error("Failed to play preview:",U),Me(),S(null)}},[O,Me]),lt=async(y,W)=>{const A=re(),U=Ht[d.length%Ht.length];(await A.createFolder(y,W,U)).success&&c(A.getFolders())},ct=async(y,W)=>{const A=re();(await A.renameFolder(y,W)).success&&c(A.getFolders())},Ge=async(y,W=!1)=>{const U=await re().deleteFolder(y,W);U.success&&(c(U.data.folders),f(U.data.recordings.sort(($,V)=>V.timestamp-$.timestamp)))},Ye=async(y,W)=>{Ee(!0);try{const A=re(),U=await A.moveRecording(y,W);if(U.success)f(A.getRecordings().sort(($,V)=>V.timestamp-$.timestamp));else if(!U.success&&U.error.type==="NAME_CONFLICT"){const $=u.find(V=>V.id===y);$&&(K({recordingId:y,folderId:W,currentName:$.tabTitle}),de($.tabTitle))}}finally{Ee(!1)}},st=async()=>{if(!(!ie||!ce.trim())){Ee(!0);try{const y=re(),W=ce.trim();(await y.moveRecordingWithRename(ie.recordingId,ie.folderId,W)).success&&(f(y.getRecordings().sort((U,$)=>$.timestamp-U.timestamp)),K(null),de(""))}finally{Ee(!1)}}},rt=()=>{K(null),de("")},it=async(y,W)=>{const A=re();(await A.moveFolder(y,W)).success&&c(A.getFolders())},Ze=async(y,W,A)=>{const U=re(),$=U.getFolders(),V=$.find(he=>he.id===W);if(!V)return;const ae=V.parentId,Ce=$.filter(he=>he.parentId===ae).sort((he,Te)=>(he.sortOrder??he.createdAt)-(Te.sortOrder??Te.createdAt)).filter(he=>he.id!==y),oe=Ce.findIndex(he=>he.id===W),ye=A==="above"?oe:oe+1,Se=$.find(he=>he.id===y);if(!Se)return;Ce.splice(ye,0,{...Se,parentId:ae});const Ie=Ce.map((he,Te)=>({...he,sortOrder:Te})),at=$.map(he=>Ie.find(dt=>dt.id===he.id)||he);await U.updateFolders(at),c(U.getFolders())},Ke=async(y,W,A,U)=>{const $=re(),V=$.getRecordings(),ae=V.find(ne=>ne.id===y),Ae=V.find(ne=>ne.id===W);if(!ae||!Ae)return;let Ce,oe,ye=U;if(Ae.parentId?(Ce=V.filter(ne=>ne.parentId===Ae.parentId).sort((ne,Ne)=>(ne.sortOrder??ne.timestamp)-(Ne.sortOrder??Ne.timestamp)),oe=Ae.parentId,ye=Ae.folderId):(Ce=V.filter(ne=>ne.folderId===U&&!ne.parentId).sort((ne,Ne)=>(ne.sortOrder??ne.timestamp)-(Ne.sortOrder??Ne.timestamp)),oe=void 0,ye=U),Ce.findIndex(ne=>ne.id===W)===-1)return;const Ie=Ce.filter(ne=>ne.id!==y),at=Ie.findIndex(ne=>ne.id===W),he=A==="above"?at:at+1;Ie.splice(he,0,ae);const Te=Ie.map((ne,Ne)=>{const He={...ne,sortOrder:Ne};return ne.id===y&&(He.folderId=ye,oe!==void 0?He.parentId=oe:delete He.parentId),He}),dt=V.map(ne=>Te.find(He=>He.id===ne.id)||ne);await $.updateRecordings(dt),f($.getRecordings().sort((ne,Ne)=>Ne.timestamp-ne.timestamp))},g=async(y,W=!0)=>{const A=re();if(!W){const $=A.getRecordings();$.find(ae=>ae.id===y);const V=$.filter(ae=>ae.parentId===y);for(const ae of V)await A.updateRecording({...ae,parentId:void 0})}(await A.deleteRecording(y,W)).success&&f(A.getRecordings().sort(($,V)=>V.timestamp-$.timestamp)),v?.id===y&&C(null)},T=async(y,W)=>{const A=re(),U=A.getRecordings().find($=>$.id===y);if(U){const $=U.filename.replace(".wav","").split("_"),V=$[$.length-1],ae=$[$.length-2],Ce=`${W.replace(/[^a-zA-Z0-9]/g,"_").slice(0,30)}_${ae}_${V}.wav`;await A.renameRecording(y,Ce);const oe=A.getRecordings().find(ye=>ye.id===y);oe&&await A.updateRecording({...oe,tabTitle:W}),f(A.getRecordings().sort((ye,Se)=>Se.timestamp-ye.timestamp))}},x=async y=>{const W=re();await W.updateRecording(y),f(W.getRecordings().sort((A,U)=>U.timestamp-A.timestamp)),v?.id===y.id&&C(y)},L=()=>{const W=re().getRecordings().sort((A,U)=>U.timestamp-A.timestamp);return f(W),W},F=()=>chrome.downloads.showDefaultFolder(),se=async y=>{H(W=>{const A=new Set(W);return A.has(y)?A.delete(y):A.add(y),chrome.storage.local.set({expandedFolders:Array.from(A)}),A})},te=async()=>{if(p(null),r){X(!0);try{if((await re().requestPermission()).success)e?.();else{p("Storage permission denied"),X(!1);return}}catch{p("Failed to get storage permission"),X(!1);return}X(!1)}try{const[y]=await chrome.tabs.query({active:!0,currentWindow:!0});if(!y?.id){p("Cannot access current tab");return}const W=await new Promise((oe,ye)=>{chrome.tabCapture.capture({audio:!0,video:!1},Se=>{chrome.runtime.lastError?ye(new Error(chrome.runtime.lastError.message)):Se?oe(Se):ye(new Error("Could not capture audio"))})});ee.current=W,ve.current=[],be.current=Date.now();let A="";try{A=new URL(y.url||"").hostname.replace(/^www\./,"")}catch{A="unknown"}$e.current={title:y.title||"Unknown",url:y.url||"",hostname:A};const U=new AudioContext;we.current=U;const $=U.createMediaStreamSource(W),V=U.createAnalyser();V.fftSize=64,V.smoothingTimeConstant=.4,pe.current=V,$.connect(V),V.connect(U.destination);const ae=()=>{if(!pe.current)return;const oe=new Uint8Array(pe.current.frequencyBinCount);pe.current.getByteFrequencyData(oe);const ye=[];for(let Se=0;Se<16;Se++){const Ie=Math.floor(Se*oe.length/16);ye.push(oe[Ie]/255)}Be(ye),Le.current=requestAnimationFrame(ae)};ae();const Ae=MediaRecorder.isTypeSupported("audio/webm;codecs=opus")?"audio/webm;codecs=opus":"audio/webm",Ce=new MediaRecorder(W,{mimeType:Ae});De.current=Ce,Ce.ondataavailable=oe=>{oe.data.size>0&&ve.current.push(oe.data)},Ce.onstop=async()=>{const oe=new Blob(ve.current,{type:Ae}),ye=Fe.current>0?Fe.current:Math.floor((Date.now()-(be.current||Date.now()))/1e3),Se=Date.now();console.log("Recording stopped, duration:",ye,"seconds");const{title:Ie,url:at,hostname:he}=$e.current,Te=new Date(Se),dt=`${String(Te.getHours()).padStart(2,"0")}-${String(Te.getMinutes()).padStart(2,"0")}-${String(Te.getSeconds()).padStart(2,"0")}`,ne=Ie.replace(/[^a-zA-Z0-9]/g,"_").slice(0,30),Ne=crypto.randomUUID().slice(0,8),He=`${ne}_${dt}_${Ne}.wav`,Tt=`${cn(he)} - ${Ie}`,Lt=new AudioContext,dn=await oe.arrayBuffer(),un=await Lt.decodeAudioData(dn),hn=Dt(un);Lt.close(),_({blob:hn,duration:ye,timestamp:Se,defaultTitle:Tt,tabUrl:at,hostname:he,filename:He}),z(Tt),we.current&&(we.current.close(),we.current=null),ee.current&&(ee.current.getTracks().forEach(pn=>pn.stop()),ee.current=null),ve.current=[]},Ce.start(1e3),n(!0),l(y.title||"Unknown"),je.current=window.setInterval(()=>{if(be.current){const oe=Math.floor((Date.now()-be.current)/1e3);o(oe),Fe.current=oe}},1e3),chrome.runtime.sendMessage({type:"SET_RECORDING_STATE",state:{isRecording:!0,startTime:be.current,tabId:y.id,tabTitle:y.title||"Unknown"}})}catch(y){console.error("Recording error:",y),p(y instanceof Error?y.message:"Recording failed")}},xe=async()=>{je.current&&(clearInterval(je.current),je.current=null),Le.current&&(cancelAnimationFrame(Le.current),Le.current=null),pe.current=null,Be([]),De.current?.state!=="inactive"&&De.current?.stop(),n(!1),o(0),Fe.current=0,be.current=null,chrome.runtime.sendMessage({type:"SET_RECORDING_STATE",state:{isRecording:!1,startTime:null,tabId:null,tabTitle:""}});try{const[y]=await chrome.tabs.query({active:!0,currentWindow:!0});y?.id&&await chrome.scripting.executeScript({target:{tabId:y.id},func:()=>{document.querySelectorAll("video, audio").forEach(W=>{W.pause()})}})}catch{}},B=()=>{t?xe():te()},Y=async()=>{if(!I)return;if(r){X(!0);try{if((await re().requestPermission()).success)e?.();else{p("Permission denied. Please try again."),X(!1);return}}catch{p("Failed to get permission."),X(!1);return}X(!1)}const y=re(),W=y.getRecordings(),A=Gn(E.trim()||I.defaultTitle,W),U={id:crypto.randomUUID(),filename:I.filename,duration:I.duration,timestamp:I.timestamp,tabTitle:A,tabUrl:I.tabUrl,hostname:I.hostname,size:I.blob.size,folderId:"uncategorized"},$=await y.saveRecording(U,I.blob);if($.success)We(),C(U),b("player"),window.scrollTo(0,0);else{console.error("Failed to save recording:",JSON.stringify($.error));const V=$.error.type==="PERMISSION_DENIED"?"Permission denied. Please grant folder access in Settings.":$.error.type==="WRITE_FAILED"?`Write failed: ${$.error.reason}`:`Failed to save: ${$.error.type}`;p(V)}_(null),z("")},ue=()=>{_(null),z("")},Oe=y=>{Me(),S(null),C(y),D(null),b("player"),window.scrollTo(0,0)},vt=()=>{C(null),b("library")};return i.jsxs("div",{className:"flex flex-col h-full bg-[var(--bg-primary)] text-[var(--text-primary)]",children:[i.jsx("div",{className:"noise-overlay"}),i.jsxs("div",{className:"flex-shrink-0 flex items-center justify-between px-4 py-3 border-b border-[var(--border-color)]",children:[i.jsxs("div",{className:"flex items-center gap-2",children:[i.jsx("div",{className:"w-7 h-7 rounded-full bg-[var(--accent-red)] flex items-center justify-center shadow-[0_0_12px_rgba(255,59,92,0.5)]",children:i.jsx("div",{className:"w-2.5 h-2.5 rounded-full bg-white"})}),i.jsx("span",{className:"text-sm font-bold",children:"CucuBau-Sound"})]}),i.jsxs("div",{className:"flex items-center gap-2",children:[t&&i.jsxs("div",{className:"flex items-center gap-1.5 px-2 py-1 rounded-full bg-[var(--accent-red-dim)]",children:[i.jsx("span",{className:"w-1.5 h-1.5 bg-[var(--accent-red)] rounded-full animate-pulse"}),i.jsx("span",{className:"text-[10px] font-semibold text-[var(--accent-red)] mono",children:mt(s)})]}),i.jsx("button",{onClick:()=>chrome.tabs.create({url:chrome.runtime.getURL("settings.html")}),className:"px-2 py-1 rounded-lg text-xs text-[var(--text-muted)] hover:text-[var(--text-primary)] hover:bg-[var(--bg-tertiary)] transition-colors",children:"Settings"})]})]}),h!=="player"&&i.jsxs("div",{className:"flex-shrink-0 flex border-b border-[var(--border-color)]",children:[i.jsxs("button",{onClick:()=>b("record"),className:`flex-1 py-3 text-sm font-medium transition-all relative ${h==="record"?"text-[var(--text-primary)]":"text-[var(--text-muted)] hover:text-[var(--text-secondary)]"}`,children:["Record",h==="record"&&i.jsx("div",{className:"absolute bottom-0 left-1/2 -translate-x-1/2 w-12 h-0.5 bg-[var(--accent-cyan)] rounded-full"})]}),i.jsxs("button",{onClick:()=>{r?Ve(()=>b("library")):b("library")},disabled:Z,className:`flex-1 py-3 text-sm font-medium transition-all relative ${h==="library"?"text-[var(--text-primary)]":"text-[var(--text-muted)] hover:text-[var(--text-secondary)]"}`,children:[Z?"Opening...":"Library",!Z&&i.jsx("span",{className:"ml-1.5 badge bg-[var(--bg-tertiary)] text-[var(--text-muted)]",children:u.length}),h==="library"&&i.jsx("div",{className:"absolute bottom-0 left-1/2 -translate-x-1/2 w-12 h-0.5 bg-[var(--accent-cyan)] rounded-full"})]})]}),h==="record"&&i.jsx(es,{isRecording:t,elapsed:s,tabTitle:a,error:m,frequencyData:Xe,onToggleRecording:B,onOpenDownloads:F}),h==="library"&&i.jsx(ts,{folders:d,recordings:u,searchQuery:j,onSearchChange:R,onCreateFolder:lt,onRenameFolder:ct,onDeleteFolder:Ge,onMoveRecording:Ye,onMoveFolder:it,onReorderFolder:Ze,onReorderRecording:Ke,onDeleteRecording:g,onConfirmDeleteRecording:(y,W,A)=>{J({type:"recording",id:y,name:W,childCount:A}),le(!0)},onConfirmDeleteFolder:(y,W,A)=>{J({type:"folder",id:y,name:W,childCount:A}),le(!1)},onRenameRecording:T,onOpenDownloads:F,onSelectRecording:Oe,onPreviewRecording:nt,previewingId:N,playingPreviewId:O,onPlayPreview:_e,expandedFolders:P,onToggleFolder:se}),h==="player"&&v&&i.jsx(Qn,{recording:v,recordings:u,onClose:vt,onDelete:()=>{g(v.id),vt()},onUpdate:x,onSelectRecording:Oe,onSelectRecordingFromCrop:(y,W)=>{C(y),D(W),window.scrollTo(0,0)},onRefreshRecordings:L,cameFromRecordingId:k}),I&&i.jsx("div",{className:"fixed inset-0 bg-black/70 flex items-center justify-center z-50 p-4",children:i.jsxs("div",{className:"bg-[var(--bg-secondary)] rounded-xl p-4 w-full max-w-sm border border-[var(--border-color)] shadow-2xl",children:[i.jsx("h3",{className:"text-sm font-semibold mb-3 text-[var(--text-primary)]",children:"Save Recording"}),i.jsx("input",{type:"text",value:E,onChange:y=>z(y.target.value),onKeyDown:y=>{y.key==="Enter"&&Y()},placeholder:"Recording title...",autoFocus:!0,className:"w-full px-3 py-2 bg-[var(--bg-tertiary)] border border-[var(--border-color)] rounded-lg text-sm text-[var(--text-primary)] placeholder:text-[var(--text-muted)] focus:outline-none focus:border-[var(--accent-cyan)] mb-3"}),i.jsxs("div",{className:"flex gap-2",children:[i.jsx("button",{onClick:ue,className:"flex-1 px-3 py-2 text-sm font-medium text-[var(--text-muted)] hover:text-[var(--text-primary)] bg-[var(--bg-tertiary)] rounded-lg transition-colors",children:"Cancel"}),i.jsx("button",{onClick:Y,className:"flex-1 px-3 py-2 text-sm font-medium text-white bg-[var(--accent-cyan)] hover:bg-[var(--accent-cyan-hover)] rounded-lg transition-colors",children:"Save"})]})]})}),ie&&i.jsx("div",{className:"fixed inset-0 bg-black/70 flex items-center justify-center z-50 p-4",children:i.jsxs("div",{className:"bg-[var(--bg-secondary)] rounded-xl p-4 w-full max-w-sm border border-[var(--border-color)] shadow-2xl",children:[i.jsx("h3",{className:"text-sm font-semibold mb-2 text-[var(--text-primary)]",children:"Name Conflict"}),i.jsx("p",{className:"text-xs text-[var(--text-muted)] mb-3",children:"A recording with this name already exists in the destination folder. Please choose a different name."}),i.jsx("input",{type:"text",value:ce,onChange:y=>de(y.target.value),onKeyDown:y=>{y.key==="Enter"&&st()},placeholder:"New name...",autoFocus:!0,className:"w-full px-3 py-2 bg-[var(--bg-tertiary)] border border-[var(--border-color)] rounded-lg text-sm text-[var(--text-primary)] placeholder:text-[var(--text-muted)] focus:outline-none focus:border-[var(--accent-cyan)] mb-3"}),i.jsxs("div",{className:"flex gap-2",children:[i.jsx("button",{onClick:rt,disabled:ge,className:"flex-1 px-3 py-2 text-sm font-medium text-[var(--text-muted)] hover:text-[var(--text-primary)] bg-[var(--bg-tertiary)] rounded-lg transition-colors disabled:opacity-50",children:"Cancel"}),i.jsx("button",{onClick:st,disabled:ge,className:"flex-1 px-3 py-2 text-sm font-medium text-white bg-[var(--accent-cyan)] hover:bg-[var(--accent-cyan-hover)] rounded-lg transition-colors disabled:opacity-50",children:ge?"Moving...":"Rename & Move"})]})]})}),ge&&!ie&&i.jsx("div",{className:"fixed inset-0 bg-black/70 flex items-center justify-center z-50",children:i.jsxs("div",{className:"bg-[var(--bg-secondary)] rounded-xl p-6 border border-[var(--border-color)] shadow-2xl flex flex-col items-center gap-3",children:[i.jsx("div",{className:"w-8 h-8 border-2 border-[var(--accent-cyan)] border-t-transparent rounded-full animate-spin"}),i.jsx("span",{className:"text-sm text-[var(--text-primary)]",children:"Moving file..."})]})}),q&&i.jsx("div",{className:"fixed inset-0 bg-black/70 flex items-center justify-center z-50 p-4",children:i.jsxs("div",{className:"bg-[var(--bg-secondary)] rounded-xl p-4 w-full max-w-sm border border-[var(--border-color)] shadow-2xl",children:[i.jsxs("h3",{className:"text-sm font-semibold mb-3 text-[var(--text-primary)]",children:["Delete ",q.type==="folder"?"Folder":"Recording","?"]}),i.jsxs("p",{className:"text-xs text-[var(--text-muted)] mb-3",children:['Are you sure you want to delete "',i.jsx("span",{className:"text-[var(--text-primary)]",children:q.name}),'"?']}),q.childCount>0&&i.jsxs("label",{className:"flex items-center gap-2 mb-4 cursor-pointer group",children:[i.jsx("input",{type:"checkbox",checked:Q,onChange:y=>le(y.target.checked),className:"w-4 h-4 rounded border-[var(--border-color)] bg-[var(--bg-tertiary)] checked:bg-[var(--accent-red)] cursor-pointer"}),i.jsx("span",{className:"text-xs text-[var(--text-muted)] group-hover:text-[var(--text-secondary)]",children:q.type==="recording"?`Also delete ${q.childCount} crop${q.childCount>1?"s":""}`:`Also delete ${q.childCount} item${q.childCount>1?"s":""} inside`})]}),q.childCount>0&&!Q&&i.jsx("p",{className:"text-xs text-[var(--text-muted)] mb-4 italic",children:q.type==="recording"?"Crops will become independent recordings":"Items will be moved to the parent folder"}),i.jsxs("div",{className:"flex gap-2",children:[i.jsx("button",{onClick:()=>J(null),className:"flex-1 py-2 px-3 rounded-lg text-xs font-medium bg-[var(--bg-tertiary)] text-[var(--text-secondary)] hover:bg-[var(--border-color)] transition-colors",children:"Cancel"}),i.jsx("button",{onClick:()=>{q.type==="recording"?g(q.id,Q):Ge(q.id,Q),J(null)},className:"flex-1 py-2 px-3 rounded-lg text-xs font-medium bg-[var(--accent-red)] text-white hover:brightness-110 transition-all",children:"Delete"})]})]})})]})}function as(r){let e=r;return()=>(e=(e*16807+0)%2147483647,e/2147483647)}function Je(r){return 440*Math.pow(2,(r-69)/12)}function Xt(r,e,t,n,s,o){return r<e?r/e:r<e+t?1-(1-n)*((r-e)/t):r<o-s?n:r<o?n*(1-(r-(o-s))/s):0}function os(r,e,t="melody"){const s=44100*r,o=new ArrayBuffer(44+s*2),a=new DataView(o),l=(m,p)=>{for(let h=0;h<p.length;h++)a.setUint8(m+h,p.charCodeAt(h))};l(0,"RIFF"),a.setUint32(4,36+s*2,!0),l(8,"WAVE"),l(12,"fmt "),a.setUint32(16,16,!0),a.setUint16(20,1,!0),a.setUint16(22,1,!0),a.setUint32(24,44100,!0),a.setUint32(28,44100*2,!0),a.setUint16(32,2,!0),a.setUint16(34,16,!0),l(36,"data"),a.setUint32(40,s*2,!0);const d=as(e),c=2*Math.PI,u=[0,2,3,5,7,8,10],f=57+Math.floor(d()*7);if(t==="melody"){const p=60/(100+Math.floor(d()*60)),h=[];let b=0;for(;b<r;){const v=[p*.5,p,p*1.5,p*2],C=v[Math.floor(d()*v.length)],k=Math.floor(d()*7),D=Math.floor(d()*2),j=f+u[k]+D*12,R=.3+d()*.4;d()>.15&&h.push({start:b,dur:C*.9,freq:Je(j),vel:R}),b+=C}for(let v=0;v<s;v++){const C=v/44100;let k=0;for(const D of h)if(C>=D.start&&C<D.start+D.dur){const j=C-D.start,R=Xt(j,.01,.1,.6,.05,D.dur),N=j*D.freq%1,M=2*N-1,O=4*Math.abs(N-.5)-1;k+=(M*.4+O*.6)*R*D.vel}a.setInt16(44+v*2,Math.max(-32768,Math.min(32767,k*3e4)),!0)}}else if(t==="drums"){const p=60/(130+Math.floor(d()*30))/4,h=Math.ceil(r/p),b=[];for(let v=0;v<h;v++){const C=v*p,k=v%16;(k===0||k===8||k===6&&d()>.5)&&b.push({type:"kick",time:C}),(k===4||k===12)&&b.push({type:"snare",time:C}),d()>.3&&b.push({type:"hat",time:C})}for(let v=0;v<s;v++){const C=v/44100;let k=0;for(const D of b){const j=C-D.time;if(!(j<0||j>.3))if(D.type==="kick"){const R=150*Math.exp(-j*30)+40;k+=Math.sin(c*R*j)*Math.exp(-j*12)*.7}else D.type==="snare"?(k+=(d()*2-1)*Math.exp(-j*20)*.4,k+=Math.sin(c*200*j)*Math.exp(-j*30)*.3):k+=(d()*2-1)*Math.exp(-j*60)*.2}a.setInt16(44+v*2,Math.max(-32768,Math.min(32767,k*3e4)),!0)}}else if(t==="bass"){const p=60/(120+Math.floor(d()*30)),h=[f-12,f-12+7,f-12+5,f-12+3],b=[];let v=0,C=0;for(;v<r;){const k=d()>.3?p:p*.5,D=Je(h[C%h.length]);d()>.1&&b.push({start:v,dur:k*.8,freq:D}),v+=k,C++}for(let k=0;k<s;k++){const D=k/44100;let j=0;for(const R of b)if(D>=R.start&&D<R.start+R.dur){const N=D-R.start,M=Xt(N,.005,.05,.7,.02,R.dur),O=N*R.freq%1;let S=Math.sin(c*O);S=Math.tanh(S*2),j+=S*M*.6}a.setInt16(44+k*2,Math.max(-32768,Math.min(32767,j*3e4)),!0)}}else if(t==="ambient"){const m=[Je(f),Je(f+7),Je(f+12),Je(f+3)];for(let p=0;p<s;p++){const h=p/44100;let b=0;const v=Math.min(h/2,1)*Math.min((r-h)/2,1);for(let C=0;C<m.length;C++){const k=m[C]*(1+.002*Math.sin(c*.1*(C+1)*h));b+=Math.sin(c*k*h)*.15,b+=Math.sin(c*k*2.01*h)*.05}b+=(d()*2-1)*.02,b*=v,a.setInt16(44+p*2,Math.max(-32768,Math.min(32767,b*3e4)),!0)}}else if(t==="vocal"){const m=[{f:800,bw:80,amp:1},{f:1200,bw:90,amp:.6},{f:2500,bw:120,amp:.3}],p=5+d()*2,h=.01+d()*.01,b=Je(f+12);for(let v=0;v<s;v++){const C=v/44100,k=Math.min(C/.3,1)*Math.min((r-C)/.5,1),D=1+h*Math.sin(c*p*C),j=b*D,R=C*j%1,N=Math.pow(Math.sin(Math.PI*R),2)*2-1;let M=0;for(const O of m)M+=N*O.amp*Math.exp(-Math.pow((j-O.f)/O.bw,2));M=M*.3+N*.15,M*=k*.5,a.setInt16(44+v*2,Math.max(-32768,Math.min(32767,M*3e4)),!0)}}else for(let m=0;m<s;m++){const p=m/44100,h=p/r;let b=0;const v=100*Math.pow(40,h);b+=Math.sin(c*v*p)*.3*(.5+.5*h);const C=p*3.7%1;C<.1&&(b+=(d()*2-1)*.3*Math.exp(-C*40)),b+=Math.sin(c*30*p+Math.sin(c*.5*p)*4)*.15;const k=Math.min(p/.1,1)*Math.min((r-p)/.2,1);b*=k,a.setInt16(44+m*2,Math.max(-32768,Math.min(32767,b*3e4)),!0)}return new Blob([o],{type:"audio/wav"})}if(typeof chrome>"u"||!chrome.storage){const r=Date.now(),e=[{id:"f1",name:"Beats",parentId:null,color:"#00ff88",createdAt:r-864e5*5,sortOrder:0},{id:"f2",name:"Vocals",parentId:null,color:"#ff3b5c",createdAt:r-864e5*4,sortOrder:1},{id:"f3",name:"FX & Ambient",parentId:null,color:"#00d4ff",createdAt:r-864e5*3,sortOrder:2},{id:"f4",name:"Samples",parentId:null,color:"#ff9500",createdAt:r-864e5*2,sortOrder:3},{id:"f1a",name:"Trap",parentId:"f1",color:"#a855f7",createdAt:r-864e5*4.5,sortOrder:0},{id:"f1b",name:"Lo-Fi",parentId:"f1",color:"#ec4899",createdAt:r-864e5*4.3,sortOrder:1},{id:"f1a1",name:"Hard Trap",parentId:"f1a",color:"#facc15",createdAt:r-864e5*4.2,sortOrder:0},{id:"f2a",name:"Adlibs",parentId:"f2",color:"#64748b",createdAt:r-864e5*3.5,sortOrder:0}],t=[{id:"r1",filename:"rec/hard-808.webm",tabTitle:"Hard 808 Pattern",hostname:"youtube.com",duration:32,timestamp:r-36e5*2,size:512e3,folderId:"f1a1",rating:5,bpm:145,tags:["drums","bass"],color:"#ff3b5c",key:"Fm",notes:"Crazy 808 slide",sortOrder:0},{id:"r2",filename:"rec/trap-hihats.webm",tabTitle:"Trap Hi-Hats Roll",hostname:"youtube.com",duration:18,timestamp:r-36e5*3,size:288e3,folderId:"f1a1",rating:4,bpm:145,tags:["drums","percussion"],color:"",key:"",sortOrder:1},{id:"r3",filename:"rec/dark-melody.webm",tabTitle:"Dark Piano Melody",hostname:"soundcloud.com",duration:45,timestamp:r-36e5*5,size:72e4,folderId:"f1a",rating:5,bpm:140,tags:["melody","piano"],color:"#a855f7",key:"C#m",notes:"Use for intro",sortOrder:0},{id:"r4",filename:"rec/808-bounce.webm",tabTitle:"808 Bounce Loop",hostname:"youtube.com",duration:24,timestamp:r-36e5*6,size:384e3,folderId:"f1a",rating:3,bpm:138,tags:["bass","loop"],color:"",key:"E",sortOrder:1},{id:"r5",filename:"rec/lofi-guitar.webm",tabTitle:"Lo-Fi Guitar Chops",hostname:"soundcloud.com",duration:67,timestamp:r-36e5*8,size:1072e3,folderId:"f1b",rating:4,bpm:85,tags:["guitar","loop","sample"],color:"#ec4899",key:"Am",sortOrder:0},{id:"r6",filename:"rec/vinyl-crackle.webm",tabTitle:"Vinyl Crackle Texture",hostname:"archive.org",duration:120,timestamp:r-36e5*10,size:192e4,folderId:"f1b",rating:3,bpm:0,tags:["ambient","fx"],color:"",key:"",notes:"Layer under everything",sortOrder:1},{id:"r7",filename:"rec/drumbreak.webm",tabTitle:"Classic Drum Break",hostname:"youtube.com",duration:8,timestamp:r-36e5*12,size:128e3,folderId:"f1",rating:5,bpm:95,tags:["drums","oneshot"],color:"#00ff88",key:"",sortOrder:0},{id:"r8",filename:"rec/vocal-chop-1.webm",tabTitle:"Female Vocal Chop",hostname:"splice.com",duration:4,timestamp:r-36e5*14,size:64e3,folderId:"f2",rating:4,tags:["vocal","oneshot"],color:"#ff3b5c",key:"G",sortOrder:0},{id:"r9",filename:"rec/chorus-hook.webm",tabTitle:"Chorus Hook Idea",hostname:"youtube.com",duration:22,timestamp:r-36e5*16,size:352e3,folderId:"f2",rating:5,tags:["vocal","melody"],color:"#facc15",key:"Dm",notes:"Amazing vibe, use on track 3",sortOrder:1},{id:"r10",filename:"rec/adlib-yeah.webm",tabTitle:"Yeah! Adlib",hostname:"youtube.com",duration:2,timestamp:r-36e5*18,size:32e3,folderId:"f2a",rating:3,tags:["vocal","oneshot"],color:"",key:"",sortOrder:0},{id:"r11",filename:"rec/adlib-woah.webm",tabTitle:"Woah Adlib",hostname:"instagram.com",duration:1,timestamp:r-36e5*19,size:16e3,folderId:"f2a",rating:2,tags:["vocal","oneshot"],color:"",key:"",sortOrder:1},{id:"r12",filename:"rec/rain-texture.webm",tabTitle:"Rain Ambient Texture",hostname:"freesound.org",duration:180,timestamp:r-36e5*20,size:288e4,folderId:"f3",rating:4,tags:["ambient","fx"],color:"#00d4ff",key:"",notes:"Perfect for intros/outros",sortOrder:0},{id:"r13",filename:"rec/riser-fx.webm",tabTitle:"Cinematic Riser",hostname:"youtube.com",duration:6,timestamp:r-36e5*22,size:96e3,folderId:"f3",rating:3,bpm:0,tags:["fx","synth"],color:"#3b82f6",key:"",sortOrder:1},{id:"r14",filename:"rec/tape-stop.webm",tabTitle:"Tape Stop Effect",hostname:"splice.com",duration:3,timestamp:r-36e5*23,size:48e3,folderId:"f3",rating:4,tags:["fx","oneshot"],color:"",key:"",sortOrder:2},{id:"r15",filename:"rec/jazz-piano.webm",tabTitle:"Jazz Piano Progression",hostname:"youtube.com",duration:35,timestamp:r-36e5*25,size:56e4,folderId:"f4",rating:5,bpm:110,tags:["piano","sample","loop"],color:"#ff9500",key:"Bb",notes:"Chop the 2nd bar",sortOrder:0},{id:"r16",filename:"rec/funk-bass.webm",tabTitle:"Funk Bassline",hostname:"youtube.com",duration:16,timestamp:r-36e5*27,size:256e3,folderId:"f4",rating:4,bpm:105,tags:["bass","loop","sample"],color:"",key:"E",sortOrder:1},{id:"r17",filename:"rec/strings-swell.webm",tabTitle:"Strings Swell",hostname:"soundcloud.com",duration:12,timestamp:r-36e5*28,size:192e3,folderId:"f4",rating:3,tags:["strings","pad"],color:"#a855f7",key:"C",sortOrder:2},{id:"r18",filename:"rec/random-idea.webm",tabTitle:"Random Melody Idea",hostname:"youtube.com",duration:28,timestamp:r-36e5*1,size:448e3,folderId:"uncategorized",rating:2,bpm:120,tags:["melody"],color:"",key:"Am",sortOrder:0},{id:"r19",filename:"rec/kick-test.webm",tabTitle:"Kick Drum Test",hostname:"splice.com",duration:1,timestamp:r-36e5*.5,size:16e3,folderId:"uncategorized",rating:0,tags:["drums","oneshot"],color:"",key:"",sortOrder:1},{id:"r20",filename:"rec/podcast-clip.webm",tabTitle:"Interview Snippet",hostname:"spotify.com",duration:55,timestamp:r-36e5*30,size:88e4,folderId:"uncategorized",rating:1,tags:[],color:"#64748b",key:"",notes:"Check at 0:30",sortOrder:2}],n={recordings:t,folders:e,expandedFolders:["uncategorized","f1","f1a","f2"]};window.chrome={storage:{local:{get:a=>Promise.resolve(a?Array.isArray(a)?Object.fromEntries(a.map(l=>[l,n[l]])):{[a]:n[a]}:n),set:a=>(Object.assign(n,a),Promise.resolve())}},runtime:{onMessage:{addListener:()=>{},removeListener:()=>{}},sendMessage:()=>{}},tabs:{query:()=>Promise.resolve([{id:1,title:"Test Tab",url:"https://youtube.com/watch?v=123"}])},downloads:{showDefaultFolder:()=>{},download:()=>Promise.resolve(),search:()=>Promise.resolve([]),show:()=>{},erase:()=>{},onChanged:{addListener:()=>{},removeListener:()=>{}}},tabCapture:{capture:()=>{}}};const s={r1:"drums",r2:"drums",r3:"melody",r4:"bass",r5:"melody",r6:"ambient",r7:"drums",r8:"vocal",r9:"vocal",r10:"vocal",r11:"vocal",r12:"ambient",r13:"fx",r14:"fx",r15:"melody",r16:"bass",r17:"ambient",r18:"melody",r19:"drums",r20:"vocal"},o={};t.forEach((a,l)=>{o[a.id]=os(Math.min(a.duration,10),l*7+42,s[a.id]||"melody")}),window.__devAudioCache=o}xn.createRoot(document.getElementById("root")).render(i.jsx(yn.StrictMode,{children:i.jsx(is,{})}));
